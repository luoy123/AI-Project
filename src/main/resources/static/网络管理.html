<!DOCTYPE html>
<html lang="zh-CN">
<head>
<style>
/* 立即隐藏CMDB菜单项 - 防止闪烁 */
.nav-cmdb { display: none !important; }
.sidebar-item[data-page="CMDB"] { display: none !important; }
</style>
<script>
// 立即执行：尽早隐藏CMDB，防止闪烁
(function() {
    function hideCMDB() {
        var items = document.querySelectorAll('.sidebar-item');
        items.forEach(function(item) {
            var span = item.querySelector('span');
            if (span && span.textContent.trim() === 'CMDB') {
                item.style.display = 'none';
                item.setAttribute('data-hidden', 'true');
            }
        });
    }
    
    // 立即执行
    hideCMDB();
    
    // DOM Ready时再执行一次
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideCMDB);
    }
    
    // 额外保险：延迟执行确保覆盖所有情况
    setTimeout(hideCMDB, 10);
    setTimeout(hideCMDB, 100);
})();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络管理 - 人工智能运维平台</title>
    <link rel="stylesheet" href="libs/fontawesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="设备管理.css">
    <!-- 引入ECharts图表库 -->
    <script src="libs/echarts/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #fff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .content-area {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
        }

        /* 选项卡 */
        .tabs {
            display: flex;
            gap: 10px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-item {
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .tab-item:hover {
            background: #f5f7fa;
            color: #333;
        }

        .tab-item.active {
            background: #2196F3;
            color: #fff;
        }

        .tab-item i {
            font-size: 16px;
        }

        /* 选项卡内容 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .stat-card.clickable:active {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #fff;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        /* 搜索和过滤 */
        .filters {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-item label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-item select:focus,
        .filter-item input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2196F3;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        /* 设备列表 */
        .device-table {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .device-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .device-table th {
            background: #f5f7fa;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            color: #666;
            font-size: 13px;
            border-bottom: 2px solid #e0e0e0;
        }

        .device-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .device-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .status-offline {
            background: #ffebee;
            color: #F44336;
        }

        .status-maintenance {
            background: #fff3e0;
            color: #FF9800;
        }

        .btn-detail {
            padding: 6px 12px;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-detail:hover {
            background: #1976D2;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* 加载动画 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading i {
            font-size: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 专线卡片样式 */
        .line-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .line-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .line-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .line-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .line-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .line-status.normal {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .line-status.warning {
            background: #fff3e0;
            color: #FF9800;
        }

        .line-status.fault {
            background: #ffebee;
            color: #F44336;
        }

        .line-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .line-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .line-info-item i {
            color: #999;
            width: 16px;
        }

        .line-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .line-metric {
            text-align: center;
        }

        .line-metric-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
        }

        .line-metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .line-metric-value.good {
            color: #4CAF50;
        }

        .line-metric-value.warning {
            color: #FF9800;
        }

        .line-metric-value.bad {
            color: #F44336;
        }

        /* 分页控件 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #2196F3;
            color: #fff;
            border-color: #2196F3;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        .pagination-info span {
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>人工智能运维平台</h2>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>总览</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-eye"></i>
            <span>视图</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-bell"></i>
            <span>告警中心</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-server"></i>
            <span>设备管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-network-wired"></i>
            <span>网络拓扑</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-chart-line"></i>
            <span>统计报表</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-tools"></i>
            <span>运维工具</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-group-title">拓展中心</div>
        <div class="sidebar-item">
            <i class="fas fa-layer-group"></i>
            <span>业务管理</span>
        </div>
        <div class="sidebar-item active">
            <i class="fas fa-globe"></i>
            <span>网络管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-video"></i>
            <span>视频管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-building"></i>
            <span>机房管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-cubes"></i>
            <span>资产管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-users"></i>
            <span>运维管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-database"></i>
            <span>CMDB</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-file-alt"></i>
            <span>日志管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-chart-pie"></i>
            <span>智能预测管理</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-cloud"></i>
            <span>云平台</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-group-title">设置中心</div>
        <div class="sidebar-item">
            <i class="fas fa-cog"></i>
            <span>设置</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-plug"></i>
            <span>对接配置</span>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="header">
            <h1>网络管理</h1>
            <!-- 用户下拉菜单容器 -->
            <div id="user-dropdown-container"></div>
        </div>

        <div class="content-area">
            <!-- 选项卡 -->
            <div class="tabs">
                <div class="tab-item active" data-tab="devices">
                    <i class="fas fa-server"></i>
                    <span>网络设备</span>
                </div>
                <div class="tab-item" data-tab="config">
                    <i class="fas fa-cog"></i>
                    <span>配置管理</span>
                </div>
                <div class="tab-item" data-tab="lines">
                    <i class="fas fa-project-diagram"></i>
                    <span>专线管理</span>
                </div>
            </div>

        <!-- 网络设备选项卡 -->
        <div class="tab-content active" id="devices-content">
            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card clickable" data-group-id="8" data-group-name="交换机" onclick="navigateToDeviceGroup(8, '交换机')">
                    <div class="stat-icon" style="background: #2196F3;">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">交换机</div>
                        <div class="stat-value" id="switchCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="9" data-group-name="路由器" onclick="navigateToDeviceGroup(9, '路由器')">
                    <div class="stat-icon" style="background: #4CAF50;">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">路由器</div>
                        <div class="stat-value" id="routerCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="10" data-group-name="防火墙" onclick="navigateToDeviceGroup(10, '防火墙')">
                    <div class="stat-icon" style="background: #FF9800;">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">防火墙</div>
                        <div class="stat-value" id="firewallCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="11" data-group-name="无线AP" onclick="navigateToDeviceGroup(11, '无线AP')">
                    <div class="stat-icon" style="background: #9C27B0;">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">无线AP</div>
                        <div class="stat-value" id="apCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="12" data-group-name="网关" onclick="navigateToDeviceGroup(12, '网关')">
                    <div class="stat-icon" style="background: #00BCD4;">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">网关</div>
                        <div class="stat-value" id="gatewayCount">0</div>
                    </div>
                </div>
            </div>

            <!-- 搜索和过滤 -->
            <div class="filters">
                <div class="filter-item">
                    <label>设备类型</label>
                    <select id="typeFilter">
                        <option value="">全部类型</option>
                        <option value="switch">交换机</option>
                        <option value="router">路由器</option>
                        <option value="firewall">防火墙</option>
                        <option value="ap">无线AP</option>
                        <option value="gateway">网关</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>设备状态</label>
                    <select id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="online">在线</option>
                        <option value="offline">离线</option>
                        <option value="maintenance">维护中</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>关键字搜索</label>
                    <input type="text" id="keywordSearch" placeholder="搜索设备名称或IP地址...">
                </div>
                <div class="filter-item" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button class="btn btn-primary" id="searchBtn">
                        <i class="fas fa-search"></i> 搜索
                    </button>
                    <button class="btn" id="resetBtn" style="background: #607D8B; border-color: #607D8B;">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>
            </div>

            <!-- 设备列表 -->
            <div class="device-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>设备名称</th>
                            <th>IP地址</th>
                            <th>设备类型</th>
                            <th>状态</th>
                            <th>分组</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <tr>
                            <td colspan="7">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>加载中...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页控件 -->
            <div class="pagination" id="devicePagination">
                <button class="pagination-btn" id="prevPageBtn" disabled>
                    <i class="fas fa-chevron-left"></i> 上一页
                </button>
                <span class="pagination-info">
                    第 <span id="currentPage">1</span> 页 / 共 <span id="totalPages">1</span> 页
                    （共 <span id="totalDevices">0</span> 条记录）
                </span>
                <button class="pagination-btn" id="nextPageBtn" disabled>
                    下一页 <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- 配置管理选项卡 -->
        <div class="tab-content" id="config-content">
            <!-- 配置管理搜索区域 -->
            <div style="
                margin-bottom: 30px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
                backdrop-filter: blur(10px);
            ">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <!-- 搜索输入框 -->
                    <div style="flex: 1; min-width: 300px; position: relative;">
                        <div style="
                            position: relative;
                            background: rgba(255,255,255,0.95);
                            border-radius: 50px;
                            padding: 5px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                            backdrop-filter: blur(10px);
                        ">
                            <div style="
                                position: absolute;
                                left: 20px;
                                top: 50%;
                                transform: translateY(-50%);
                                color: #667eea;
                                font-size: 18px;
                                z-index: 2;
                            ">
                                <i class="fas fa-search"></i>
                            </div>
                            <input type="text" id="configKeywordSearch" placeholder="搜索设备名称、IP地址..." style="
                                width: 100%;
                                padding: 15px 20px 15px 55px;
                                border: none;
                                border-radius: 50px;
                                background: transparent;
                                font-size: 16px;
                                color: #333;
                                outline: none;
                                font-weight: 500;
                            ">
                        </div>
                    </div>
                    
                    <!-- 快速时间过滤 -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="configTimeFilter" style="
                            padding: 12px 20px;
                            border: 2px solid rgba(255,255,255,0.3);
                            border-radius: 25px;
                            background: rgba(255,255,255,0.9);
                            color: #667eea;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            outline: none;
                            transition: all 0.3s;
                        " onfocus="this.style.borderColor='#fff'; this.style.boxShadow='0 0 0 3px rgba(255,255,255,0.2)'" 
                           onblur="this.style.borderColor='rgba(255,255,255,0.3)'; this.style.boxShadow='none'">
                            <option value="">全部时间</option>
                            <option value="today">今天</option>
                            <option value="week">最近一周</option>
                            <option value="month">最近一月</option>
                        </select>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 12px;">
                        <button id="searchConfigBtn" style="
                            padding: 12px 30px;
                            background: #fff;
                            color: #667eea;
                            border: none;
                            border-radius: 25px;
                            font-weight: 600;
                            font-size: 15px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255,255,255,0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255,255,255,0.3)'">
                            <i class="fas fa-search"></i>
                            <span>搜索</span>
                        </button>
                        <button id="resetConfigBtn" style="
                            padding: 12px 25px;
                            background: rgba(255,255,255,0.2);
                            color: #fff;
                            border: 2px solid rgba(255,255,255,0.4);
                            border-radius: 25px;
                            font-weight: 500;
                            font-size: 15px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)'">
                            <i class="fas fa-redo"></i>
                            <span>重置</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 设备配置列表 -->
            <div class="device-table">
                <table>
                    <thead>
                        <tr>
                            <th>设备名称</th>
                            <th>IP地址</th>
                            <th>备份版本</th>
                            <th>最新备份时间</th>
                            <th>备份状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="configTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>加载中...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页控件 -->
            <div class="pagination" id="configPagination">
                <button class="pagination-btn" id="prevConfigPageBtn" disabled>
                    <i class="fas fa-chevron-left"></i> 上一页
                </button>
                <span class="pagination-info">
                    第 <span id="currentConfigPage">1</span> 页 / 共 <span id="totalConfigPages">1</span> 页
                    （共 <span id="totalConfigs">0</span> 条记录）
                </span>
                <button class="pagination-btn" id="nextConfigPageBtn" disabled>
                    下一页 <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- 专线管理选项卡 -->
        <div class="tab-content" id="lines-content">
            <!-- 工具栏 -->
            <div class="filters" style="margin-bottom: 20px;">
                <div class="filter-item">
                    <label>运营商</label>
                    <select id="lineProviderFilter">
                        <option value="">全部运营商</option>
                        <option value="中国电信">中国电信</option>
                        <option value="中国联通">中国联通</option>
                        <option value="中国移动">中国移动</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>状态</label>
                    <select id="lineStatusFilter">
                        <option value="">全部状态</option>
                        <option value="normal">正常</option>
                        <option value="warning">警告</option>
                        <option value="fault">故障</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>关键字搜索</label>
                    <input type="text" id="lineKeywordSearch" placeholder="搜索专线名称...">
                </div>
                <div class="filter-item" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button class="btn btn-primary" id="searchLineBtn">
                        <i class="fas fa-search"></i> 搜索
                    </button>
                    <button class="btn btn-primary" id="resetLineBtn" style="background: #FF9800;">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                    <button class="btn btn-primary" id="addLineBtn">
                        <i class="fas fa-plus"></i> 添加专线
                    </button>
                </div>
            </div>

            <!-- 专线列表表格 -->
            <div class="device-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>专线名称</th>
                            <th>运营商</th>
                            <th>带宽</th>
                            <th>端点A</th>
                            <th>端点B</th>
                            <th>状态</th>
                            <th>延迟</th>
                            <th>丢包率</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="lineTableBody">
                        <tr>
                            <td colspan="10">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>加载中...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 全局变量：标记配置管理数据是否需要刷新
        let configDataNeedsRefresh = false;
        
        // 选项卡切换
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 添加active类
                this.classList.add('active');
                const tabName = this.dataset.tab;
                document.getElementById(tabName + '-content').classList.add('active');
                
                // 当切换到配置管理页面时，检查是否需要刷新数据
                if (tabName === 'config') {
                    console.log('🔄 切换到配置管理页面...');
                    setTimeout(() => {
                        if (typeof loadConfigList === 'function') {
                            // 总是刷新配置管理数据，确保显示最新信息
                            loadConfigList();
                            configDataNeedsRefresh = false; // 重置刷新标记
                            console.log('✅ 配置管理数据已刷新');
                        }
                    }, 100); // 稍微延迟确保页面切换完成
                }
            });
        });

        // 加载设备统计数据
        function loadDeviceStats() {
            console.log('开始加载网络设备统计数据...');
            
            fetch('/api/asset/list?deviceManagementOnly=true')
                .then(response => response.json())
                .then(result => {
                    console.log('Asset API响应:', result);
                    
                    if (result.code === 200 && result.data) {
                        // 过滤网络设备（categoryId: 8-12）
                        const networkAssets = result.data.filter(asset => {
                            const categoryId = asset.categoryId;
                            return categoryId >= 8 && categoryId <= 12;
                        });
                        
                        console.log('网络设备数量:', networkAssets.length);
                        
                        // 统计各类型设备
                        const stats = {
                            switch: networkAssets.filter(asset => asset.categoryId === 8).length,    // 交换机
                            router: networkAssets.filter(asset => asset.categoryId === 9).length,    // 路由器
                            firewall: networkAssets.filter(asset => asset.categoryId === 10).length, // 防火墙
                            ap: networkAssets.filter(asset => asset.categoryId === 11).length,       // 无线AP
                            gateway: networkAssets.filter(asset => asset.categoryId === 12).length   // 网关
                        };
                        
                        console.log('设备统计:', stats);
                        
                        // 更新页面显示
                        document.getElementById('switchCount').textContent = stats.switch;
                        document.getElementById('routerCount').textContent = stats.router;
                        document.getElementById('firewallCount').textContent = stats.firewall;
                        document.getElementById('apCount').textContent = stats.ap;
                        document.getElementById('gatewayCount').textContent = stats.gateway;
                        
                        console.log('✅ 统计数据更新完成');
                    } else {
                        console.error('API返回错误:', result);
                        // 设置为0
                        document.getElementById('switchCount').textContent = 0;
                        document.getElementById('routerCount').textContent = 0;
                        document.getElementById('firewallCount').textContent = 0;
                        document.getElementById('apCount').textContent = 0;
                        document.getElementById('gatewayCount').textContent = 0;
                    }
                })
                .catch(error => {
                    console.error('加载统计数据失败:', error);
                    // 设置为0
                    document.getElementById('switchCount').textContent = 0;
                    document.getElementById('routerCount').textContent = 0;
                    document.getElementById('firewallCount').textContent = 0;
                    document.getElementById('apCount').textContent = 0;
                    document.getElementById('gatewayCount').textContent = 0;
                });
        }

        // 分页变量
        let currentDevicePage = 1;
        const devicesPerPage = 5;
        let allDevices = [];

        // 加载设备列表
        function loadDeviceList() {
            console.log('开始加载网络设备列表...');
            
            fetch('/api/asset/list?deviceManagementOnly=true')
                .then(response => response.json())
                .then(result => {
                    console.log('设备列表API响应:', result);
                    
                    if (result.code === 200 && result.data) {
                        // 过滤网络设备（categoryId: 8-12）
                        const networkAssets = result.data.filter(asset => {
                            const categoryId = asset.categoryId;
                            return categoryId >= 8 && categoryId <= 12;
                        });
                        
                        // 映射为设备列表格式
                        allDevices = networkAssets.map(asset => ({
                            id: asset.id,
                            name: asset.deviceName || asset.assetName,
                            ip: asset.ipAddress || '未设置',
                            type: getDeviceTypeFromCategory(asset.categoryId),
                            status: mapAssetStatusToDeviceStatus(asset.assetStatus),
                            groupName: getCategoryName(asset.categoryId),
                            groupId: asset.categoryId,
                            manufacturer: asset.manufacturer || '未知',
                            model: asset.model || '未知',
                            location: asset.location || '未知'
                        }));
                        
                        console.log('映射后的设备列表:', allDevices);
                        
                        // 应用过滤器
                        applyFilters();
                        
                        currentDevicePage = 1; // 重置到第一页
                        renderDeviceTable();
                        updatePagination();
                        
                        console.log('✅ 设备列表加载完成');
                    } else {
                        console.error('API返回错误:', result);
                        allDevices = [];
                        renderDeviceTable();
                    }
                })
                .catch(error => {
                    console.error('加载设备列表失败:', error);
                    allDevices = [];
                    document.getElementById('deviceTableBody').innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>加载失败，请稍后重试</p>
                                </div>
                            </td>
                        </tr>
                    `;
                });
        }
        
        // 辅助函数：根据categoryId获取设备类型
        function getDeviceTypeFromCategory(categoryId) {
            const typeMap = {
                8: 'switch',     // 交换机
                9: 'router',     // 路由器
                10: 'firewall',  // 防火墙
                11: 'ap',        // 无线AP
                12: 'gateway'    // 网关
            };
            return typeMap[categoryId] || 'unknown';
        }
        
        // 辅助函数：映射资产状态到设备状态
        function mapAssetStatusToDeviceStatus(assetStatus) {
            const statusMap = {
                'online': 'online',
                'offline': 'offline',
                'maintenance': 'maintenance'
            };
            return statusMap[assetStatus] || 'offline';
        }
        
        // 辅助函数：获取分类名称
        function getCategoryName(categoryId) {
            const categoryMap = {
                8: '交换机',
                9: '路由器',
                10: '防火墙',
                11: '无线AP',
                12: '网关'
            };
            return categoryMap[categoryId] || '未知';
        }
        
        // 应用过滤器
        function applyFilters() {
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const keywordSearch = document.getElementById('keywordSearch');
            
            if (!typeFilter || !statusFilter || !keywordSearch) {
                console.warn('过滤器元素未找到，跳过过滤');
                return;
            }
            
            const type = typeFilter.value;
            const status = statusFilter.value;
            const keyword = keywordSearch.value.toLowerCase();
            
            allDevices = allDevices.filter(device => {
                // 类型过滤
                if (type && device.type !== type) return false;
                
                // 状态过滤
                if (status && device.status !== status) return false;
                
                // 关键词过滤
                if (keyword && !device.name.toLowerCase().includes(keyword) && 
                    !device.ip.toLowerCase().includes(keyword)) return false;
                
                return true;
            });
        }

        // 渲染设备表格（分页）
        function renderDeviceTable() {
            const tbody = document.getElementById('deviceTableBody');
            
            if (allDevices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>暂无设备数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // 计算当前页的数据
            const startIndex = (currentDevicePage - 1) * devicesPerPage;
            const endIndex = startIndex + devicesPerPage;
            const pageDevices = allDevices.slice(startIndex, endIndex);

            tbody.innerHTML = pageDevices.map(device => {
                const statusClass = device.status === 'online' ? 'status-online' : 
                                   device.status === 'offline' ? 'status-offline' : 'status-maintenance';
                const statusText = device.status === 'online' ? '在线' : 
                                  device.status === 'offline' ? '离线' : '维护中';
                const typeText = getTypeText(device.type);

                return `
                    <tr>
                        <td>${device.id}</td>
                        <td>${device.name}</td>
                        <td>${device.ip}</td>
                        <td>${typeText}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${device.groupName || '-'}</td>
                        <td>
                            <button class="btn-detail" onclick="viewDeviceDetail(${device.id}, ${device.groupId})">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                            <button class="btn-detail" onclick="backupDeviceConfig(${device.id}, '${device.name}', '${device.ip}', '${typeText}')" 
                                    style="background: #4CAF50; border-color: #4CAF50; margin-left: 5px;">
                                <i class="fas fa-sync-alt"></i> 更新
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 更新分页控件
        function updatePagination() {
            const totalPages = Math.ceil(allDevices.length / devicesPerPage);
            
            document.getElementById('currentPage').textContent = currentDevicePage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalDevices').textContent = allDevices.length;
            
            // 更新按钮状态
            document.getElementById('prevPageBtn').disabled = currentDevicePage === 1;
            document.getElementById('nextPageBtn').disabled = currentDevicePage === totalPages || totalPages === 0;
        }

        // 上一页
        function prevPage() {
            if (currentDevicePage > 1) {
                currentDevicePage--;
                renderDeviceTable();
                updatePagination();
            }
        }

        // 下一页
        function nextPage() {
            const totalPages = Math.ceil(allDevices.length / devicesPerPage);
            if (currentDevicePage < totalPages) {
                currentDevicePage++;
                renderDeviceTable();
                updatePagination();
            }
        }

        // 获取设备类型文本
        function getTypeText(type) {
            const typeMap = {
                'switch': '交换机',
                'router': '路由器',
                'firewall': '防火墙',
                'ap': '无线AP',
                'gateway': '网关'
            };
            return typeMap[type] || type;
        }

        // 查看设备详情
        function viewDeviceDetail(deviceId, groupId) {
            // 跳转到设备管理页面，同时传递设备ID和分组ID
            // groupId: 展开并选中对应分组，显示该分组的所有设备
            // deviceId: 高亮显示该设备
            window.location.href = `设备管理.html?groupId=${groupId}&deviceId=${deviceId}`;
        }

        // 备份设备配置（更新按钮）
        function backupDeviceConfig(deviceId, deviceName, deviceIp, deviceType) {
            console.log('备份设备配置:', deviceId, deviceName, deviceIp, deviceType);
            
            // 显示美化的确认弹窗
            showBackupConfirmModal(deviceId, deviceName, deviceIp, deviceType);
        }
        
        // 执行实际的备份操作
        function executeDeviceBackup(deviceId, deviceName, deviceIp, deviceType) {
            console.log('🚀 执行设备备份:', deviceName);
            
            // 先检查设备是否存在（调用Asset API验证）
            fetch(`/api/asset/${deviceId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        throw new Error('设备不存在');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(result => {
                    if (result.code === 200 && result.data) {
                        // 设备存在，执行备份
                        simulateDeviceBackup(deviceId, deviceName, deviceIp, deviceType, result.data);
                    } else {
                        throw new Error(result.message || '设备验证失败');
                    }
                })
                .catch(error => {
                    console.error('备份失败:', error);
                    alert(`备份失败: ${error.message}`);
                });
        }
        
        // 显示美化的备份确认弹窗
        function showBackupConfirmModal(deviceId, deviceName, deviceIp, deviceType) {
            const modalHTML = `
                <div id="backupConfirmModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    backdrop-filter: blur(5px);
                ">
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 20px;
                        width: 90%;
                        max-width: 480px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        overflow: hidden;
                        animation: modalSlideIn 0.3s ease-out;
                    ">
                        <!-- 头部 -->
                        <div style="
                            color: #fff;
                            padding: 30px 30px 20px 30px;
                            text-align: center;
                        ">
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 50%;
                                margin: 0 auto 20px auto;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 36px;
                            ">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 600;">
                                配置备份确认
                            </h2>
                            <p style="margin: 0; opacity: 0.9; font-size: 16px;">
                                即将为以下设备创建配置备份
                            </p>
                        </div>

                        <!-- 设备信息卡片 -->
                        <div style="
                            background: #fff;
                            margin: 0 20px 20px 20px;
                            border-radius: 15px;
                            padding: 25px;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        ">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="color: #667eea; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                        <i class="fas fa-server" style="margin-right: 5px;"></i>设备名称
                                    </div>
                                    <div style="color: #333; font-size: 18px; font-weight: 600;">${deviceName}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #667eea; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                        <i class="fas fa-network-wired" style="margin-right: 5px;"></i>IP地址
                                    </div>
                                    <div style="color: #333; font-size: 18px; font-weight: 600;">${deviceIp}</div>
                                </div>
                            </div>
                            
                            <div style="
                                margin-top: 20px;
                                padding-top: 20px;
                                border-top: 1px solid #eee;
                                text-align: center;
                            ">
                                <div style="color: #667eea; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                    <i class="fas fa-tag" style="margin-right: 5px;"></i>设备类型
                                </div>
                                <div style="
                                    display: inline-block;
                                    background: linear-gradient(135deg, #667eea, #764ba2);
                                    color: #fff;
                                    padding: 8px 20px;
                                    border-radius: 20px;
                                    font-size: 16px;
                                    font-weight: 500;
                                ">${deviceType}</div>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="
                            padding: 0 30px 30px 30px;
                            display: flex;
                            gap: 15px;
                        ">
                            <button onclick="closeBackupConfirmModal()" style="
                                flex: 1;
                                padding: 15px;
                                background: rgba(255,255,255,0.2);
                                color: #fff;
                                border: 2px solid rgba(255,255,255,0.3);
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-times" style="margin-right: 8px;"></i>取消
                            </button>
                            <button onclick="confirmBackup(${deviceId}, '${deviceName}', '${deviceIp}', '${deviceType}')" style="
                                flex: 2;
                                padding: 15px;
                                background: #fff;
                                color: #667eea;
                                border: none;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: 600;
                                transition: all 0.3s ease;
                                box-shadow: 0 5px 15px rgba(255,255,255,0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255,255,255,0.4)'" 
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(255,255,255,0.3)'">
                                <i class="fas fa-check" style="margin-right: 8px;"></i>确认备份
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes modalSlideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-50px) scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                    
                    @keyframes modalSlideOut {
                        from {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                        to {
                            opacity: 0;
                            transform: translateY(-50px) scale(0.9);
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // 关闭备份确认弹窗
        function closeBackupConfirmModal() {
            const modal = document.getElementById('backupConfirmModal');
            if (modal) {
                modal.style.animation = 'modalSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // 确认备份
        function confirmBackup(deviceId, deviceName, deviceIp, deviceType) {
            closeBackupConfirmModal();
            executeDeviceBackup(deviceId, deviceName, deviceIp, deviceType);
        }
        
        // 设备配置备份 - 调用数据库API
        function simulateDeviceBackup(deviceId, deviceName, deviceIp, deviceType, deviceData) {
            console.log(`🚀 开始备份设备: ${deviceName} (ID: ${deviceId})`);
            
            // 调用后端API进行备份
            fetch(`/api/config-backup/backup/${deviceId}?operator=admin`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('📡 备份API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('📊 备份API结果:', result);
                
                if (result.success) {
                    // 显示美化的成功提示
                    showBackupSuccessNotification(deviceName, result.version, result.backupTime);
                    
                    // 标记配置管理数据需要刷新
                    configDataNeedsRefresh = true;
                    
                    // 检查当前是否在配置管理标签页
                    const activeTab = document.querySelector('.tab-item.active');
                    if (activeTab && activeTab.dataset.tab === 'config') {
                        // 如果当前在配置管理页面，立即刷新数据
                        console.log('📋 当前在配置管理页面，立即刷新数据...');
                        setTimeout(() => {
                            if (typeof loadConfigList === 'function') {
                                loadConfigList();
                                configDataNeedsRefresh = false;
                                console.log('✅ 配置管理数据已刷新');
                            }
                        }, 800); // 稍微延迟确保后端数据已保存
                    } else {
                        // 如果不在配置管理页面，只设置刷新标记，等切换时再刷新
                        console.log('📋 不在配置管理页面，已标记需要刷新');
                    }
                    
                    console.log('✅ 设备配置备份完成:', result);
                } else {
                    console.error('❌ 备份失败详情:', result);
                    showBackupErrorNotification(result.message || '未知错误');
                }
            })
            .catch(error => {
                console.error('❌ 备份API调用失败:', error);
                showBackupErrorNotification(error.message);
            });
        }
        
        // 显示备份成功通知
        function showBackupSuccessNotification(deviceName, version, backupTime) {
            const notificationHTML = `
                <div id="successNotification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #4CAF50, #45a049);
                    color: white;
                    padding: 20px 25px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
                    z-index: 10001;
                    min-width: 350px;
                    animation: slideInRight 0.5s ease-out;
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            font-size: 18px;
                        ">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                                备份成功！
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                设备 "${deviceName}" 配置已备份，数据已自动更新
                            </div>
                        </div>
                    </div>
                    <div style="
                        background: rgba(255,255,255,0.1);
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 13px;
                    ">
                        <div>📋 版本号: ${version}</div>
                        <div style="margin-top: 5px;">⏰ 备份时间: ${backupTime}</div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            opacity: 1;
                            transform: translateX(0);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHTML);
            
            // 3秒后自动消失
            setTimeout(() => {
                const notification = document.getElementById('successNotification');
                if (notification) {
                    notification.style.animation = 'slideOutRight 0.5s ease-in forwards';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }
            }, 3000);
        }
        
        // 显示备份失败通知
        function showBackupErrorNotification(message) {
            const notificationHTML = `
                <div id="errorNotification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #F44336, #d32f2f);
                    color: white;
                    padding: 20px 25px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(244, 67, 54, 0.3);
                    z-index: 10001;
                    min-width: 350px;
                    animation: slideInRight 0.5s ease-out;
                ">
                    <div style="display: flex; align-items: center;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            font-size: 18px;
                        ">
                            <i class="fas fa-times"></i>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                                备份失败
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                ${message}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHTML);
            
            // 5秒后自动消失
            setTimeout(() => {
                const notification = document.getElementById('errorNotification');
                if (notification) {
                    notification.style.animation = 'slideOutRight 0.5s ease-in forwards';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }
            }, 5000);
        }
        
        // 获取设备的下一个版本号
        function getNextDeviceVersion(deviceId) {
            try {
                // 获取该设备的所有备份记录
                const allBackups = JSON.parse(localStorage.getItem('deviceBackups') || '[]');
                const deviceBackups = allBackups.filter(backup => backup.deviceId == deviceId);
                
                if (deviceBackups.length === 0) {
                    // 第一次备份，从v1.0开始
                    return 'v1.0';
                }
                
                // 找到最新的版本号
                let maxVersion = 0;
                deviceBackups.forEach(backup => {
                    const versionMatch = backup.version.match(/^v(\d+)\.(\d+)$/);
                    if (versionMatch) {
                        const major = parseInt(versionMatch[1]);
                        const minor = parseInt(versionMatch[2]);
                        const currentVersion = major + minor / 10;
                        if (currentVersion > maxVersion) {
                            maxVersion = currentVersion;
                        }
                    }
                });
                
                // 版本号递增0.1
                const nextVersion = maxVersion + 0.1;
                const major = Math.floor(nextVersion);
                const minor = Math.round((nextVersion - major) * 10);
                
                return `v${major}.${minor}`;
            } catch (error) {
                console.error('获取版本号失败:', error);
                return 'v1.0';
            }
        }
        
        // 生成MAC地址
        function generateMacAddress() {
            const chars = '0123456789ABCDEF';
            let mac = '';
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 2 === 0) mac += ':';
                mac += chars[Math.floor(Math.random() * 16)];
            }
            return mac;
        }
        
        // 根据设备类型生成端口信息
        function generatePortInfo(deviceType) {
            const portConfigs = {
                '交换机': [
                    { port: 'GE1/0/1', status: 'up', speed: '1000M', duplex: 'full' },
                    { port: 'GE1/0/2', status: 'up', speed: '1000M', duplex: 'full' },
                    { port: 'GE1/0/3', status: 'down', speed: '-', duplex: '-' },
                    { port: 'GE1/0/4', status: 'up', speed: '1000M', duplex: 'full' }
                ],
                '路由器': [
                    { port: 'GE0/0/0', status: 'up', speed: '1000M', duplex: 'full', ip: '192.168.1.1' },
                    { port: 'GE0/0/1', status: 'up', speed: '1000M', duplex: 'full', ip: '10.0.0.1' },
                    { port: 'Serial0/0/0', status: 'up', speed: '2M', duplex: 'full' }
                ],
                '防火墙': [
                    { port: 'inside', status: 'up', security: 'high', ip: '192.168.1.254' },
                    { port: 'outside', status: 'up', security: 'low', ip: '112.23.65.1' },
                    { port: 'dmz', status: 'up', security: 'medium', ip: '172.16.1.1' }
                ],
                '无线AP': [
                    { ssid: 'Corporate-WiFi', status: 'up', clients: Math.floor(Math.random() * 20) },
                    { ssid: 'Guest-WiFi', status: 'up', clients: Math.floor(Math.random() * 10) }
                ],
                '网关': [
                    { tunnel: 'VPN-Tunnel-1', status: 'up', remote: '203.45.67.89' },
                    { tunnel: 'VPN-Tunnel-2', status: 'down', remote: '198.51.100.1' }
                ]
            };
            
            return portConfigs[deviceType] || [{ port: 'eth0', status: 'up', speed: '1000M' }];
        }
        
        // 生成固件版本
        function generateFirmwareVersion(deviceType) {
            const firmwareMap = {
                '交换机': `SW-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                '路由器': `RT-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                '防火墙': `FW-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                '无线AP': `AP-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                '网关': `GW-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`
            };
            
            return firmwareMap[deviceType] || `DEV-1.0.0`;
        }
        
        // 生成配置校验和
        function generateChecksum() {
            const chars = '0123456789abcdef';
            let checksum = '';
            for (let i = 0; i < 32; i++) {
                checksum += chars[Math.floor(Math.random() * 16)];
            }
            return checksum;
        }
        
        // 计算设备运行时间
        function calculateUptime(createTime) {
            if (!createTime) return '未知';
            
            try {
                const created = new Date(createTime);
                const now = new Date();
                const diffMs = now.getTime() - created.getTime();
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                if (diffDays > 0) {
                    return `${diffDays}天${diffHours}小时`;
                } else if (diffHours > 0) {
                    return `${diffHours}小时`;
                } else {
                    return '不足1小时';
                }
            } catch (error) {
                return '未知';
            }
        }
        
        // 保存备份记录
        function saveBackupRecord(backupResult) {
            try {
                // 获取现有备份记录
                const existingBackups = JSON.parse(localStorage.getItem('deviceBackups') || '[]');
                
                // 添加新的备份记录（包含完整设备快照）
                const newBackup = {
                    id: Date.now(),
                    deviceId: backupResult.deviceSnapshot.deviceId,
                    deviceName: backupResult.deviceSnapshot.deviceName,
                    deviceIp: backupResult.deviceSnapshot.deviceIp,
                    deviceType: backupResult.deviceSnapshot.deviceType,
                    version: backupResult.version,
                    backupTime: backupResult.backupTime,
                    status: 'success',
                    operator: backupResult.deviceSnapshot.operator,
                    createTime: backupResult.deviceSnapshot.backupTimestamp,
                    backupSize: backupResult.deviceSnapshot.backupSize,
                    
                    // 保存完整的设备快照信息
                    deviceSnapshot: backupResult.deviceSnapshot
                };
                
                existingBackups.unshift(newBackup); // 添加到开头
                
                // 只保留最近100条记录（增加存储量以支持版本历史）
                if (existingBackups.length > 100) {
                    existingBackups.splice(100);
                }
                
                // 保存到localStorage
                localStorage.setItem('deviceBackups', JSON.stringify(existingBackups));
                
                console.log('✅ 备份记录已保存:', newBackup);
                console.log('📸 设备快照已保存:', backupResult.deviceSnapshot);
                
                // 同时保存版本历史记录（按设备分组）
                saveDeviceVersionHistory(backupResult.deviceSnapshot.deviceId, newBackup);
                
            } catch (error) {
                console.error('❌ 保存备份记录失败:', error);
            }
        }
        
        // 保存设备版本历史记录
        function saveDeviceVersionHistory(deviceId, backupRecord) {
            try {
                // 获取设备版本历史
                const versionHistory = JSON.parse(localStorage.getItem('deviceVersionHistory') || '{}');
                
                if (!versionHistory[deviceId]) {
                    versionHistory[deviceId] = {
                        deviceId: deviceId,
                        deviceName: backupRecord.deviceName,
                        deviceType: backupRecord.deviceType,
                        versions: []
                    };
                }
                
                // 添加新版本记录
                const versionRecord = {
                    version: backupRecord.version,
                    backupTime: backupRecord.backupTime,
                    backupTimestamp: backupRecord.createTime,
                    operator: backupRecord.operator,
                    backupSize: backupRecord.backupSize,
                    deviceSnapshot: backupRecord.deviceSnapshot,
                    
                    // 版本变更摘要
                    changes: generateVersionChanges(deviceId, backupRecord.deviceSnapshot)
                };
                
                versionHistory[deviceId].versions.unshift(versionRecord);
                
                // 每个设备最多保留20个版本
                if (versionHistory[deviceId].versions.length > 20) {
                    versionHistory[deviceId].versions.splice(20);
                }
                
                // 保存版本历史
                localStorage.setItem('deviceVersionHistory', JSON.stringify(versionHistory));
                
                console.log(`📚 设备${deviceId}版本历史已更新:`, versionRecord);
            } catch (error) {
                console.error('保存版本历史失败:', error);
            }
        }
        
        // 生成版本变更摘要
        function generateVersionChanges(deviceId, currentSnapshot) {
            try {
                const versionHistory = JSON.parse(localStorage.getItem('deviceVersionHistory') || '{}');
                const deviceHistory = versionHistory[deviceId];
                
                if (!deviceHistory || deviceHistory.versions.length === 0) {
                    return ['首次配置备份'];
                }
                
                const lastSnapshot = deviceHistory.versions[0].deviceSnapshot;
                const changes = [];
                
                // 比较关键配置项
                if (currentSnapshot.firmwareVersion !== lastSnapshot.firmwareVersion) {
                    changes.push(`固件版本: ${lastSnapshot.firmwareVersion} → ${currentSnapshot.firmwareVersion}`);
                }
                
                if (currentSnapshot.configChecksum !== lastSnapshot.configChecksum) {
                    changes.push('配置文件已更新');
                }
                
                if (currentSnapshot.status !== lastSnapshot.status) {
                    changes.push(`设备状态: ${lastSnapshot.status} → ${currentSnapshot.status}`);
                }
                
                // 比较端口状态
                const portChanges = comparePortStatus(lastSnapshot.ports, currentSnapshot.ports);
                if (portChanges.length > 0) {
                    changes.push(...portChanges);
                }
                
                return changes.length > 0 ? changes : ['配置定期备份'];
            } catch (error) {
                console.error('生成版本变更失败:', error);
                return ['配置备份'];
            }
        }
        
        // 比较端口状态变化
        function comparePortStatus(oldPorts, newPorts) {
            const changes = [];
            
            try {
                // 简单的端口状态比较
                if (oldPorts && newPorts && oldPorts.length === newPorts.length) {
                    for (let i = 0; i < oldPorts.length; i++) {
                        const oldPort = oldPorts[i];
                        const newPort = newPorts[i];
                        
                        if (oldPort.status !== newPort.status) {
                            const portName = oldPort.port || oldPort.ssid || oldPort.tunnel || `端口${i+1}`;
                            changes.push(`${portName}: ${oldPort.status} → ${newPort.status}`);
                        }
                    }
                }
            } catch (error) {
                console.error('比较端口状态失败:', error);
            }
            
            return changes;
        }

        // 搜索按钮点击事件
        document.getElementById('searchBtn').addEventListener('click', loadDeviceList);
        
        // 重置按钮点击事件
        document.getElementById('resetBtn').addEventListener('click', function() {
            // 清空所有筛选条件
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('keywordSearch').value = '';
            // 重新加载设备列表
            loadDeviceList();
        });

        // 回车搜索
        document.getElementById('keywordSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadDeviceList();
            }
        });

        // 设备列表分页按钮事件
        document.getElementById('prevPageBtn').addEventListener('click', prevPage);
        document.getElementById('nextPageBtn').addEventListener('click', nextPage);

        // 配置管理分页按钮事件
        document.getElementById('prevConfigPageBtn').addEventListener('click', prevConfigPage);
        document.getElementById('nextConfigPageBtn').addEventListener('click', nextConfigPage);

        // 配置管理搜索按钮事件
        document.getElementById('searchConfigBtn').addEventListener('click', loadConfigList);
        
        // 配置管理重置按钮事件
        document.getElementById('resetConfigBtn').addEventListener('click', resetConfigSearch);
        
        // 配置管理关键字输入框回车搜索
        document.getElementById('configKeywordSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadConfigList();
            }
        });
        
        // 时间过滤器变化时自动搜索
        document.getElementById('configTimeFilter').addEventListener('change', function() {
            loadConfigList();
        });

        // 加载配置管理统计数据（已删除图表功能）
        function loadConfigStats() {
            // 配置统计功能已移除
            console.log('配置统计图表功能已删除');
        }

        // 配置管理分页变量
        let currentConfigPage = 1;
        const configsPerPage = 5;
        let allConfigs = [];

        // 加载配置管理列表 - 从数据库读取
        function loadConfigList() {
            console.log('🔄 从数据库加载配置管理列表...');
            
            const keyword = document.getElementById('configKeywordSearch').value.trim();
            const timeFilter = document.getElementById('configTimeFilter').value;
            
            // 根据时间过滤器计算日期范围
            let startDate = '';
            let endDate = '';
            const today = new Date();
            
            if (timeFilter === 'today') {
                startDate = today.toISOString().split('T')[0];
                endDate = startDate;
            } else if (timeFilter === 'week') {
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                startDate = weekAgo.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            } else if (timeFilter === 'month') {
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                startDate = monthAgo.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }
            
            // 调试信息
            console.log('🔍 搜索参数:', {
                keyword: keyword || '(空)',
                timeFilter: timeFilter || '(空)',
                startDate: startDate || '(空)',
                endDate: endDate || '(空)'
            });
            
            // 构建查询参数
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            
            const queryString = params.toString();
            const url = `/api/config-backup/list${queryString ? '?' + queryString : ''}`;
            
            console.log('📡 请求URL:', url);
            
            fetch(url, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                console.log('📡 配置列表API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('📊 配置列表API结果:', result);
                
                if (result.success) {
                    allConfigs = result.data || [];
                    console.log('📋 从数据库获取的配置列表:', allConfigs.length, '条记录');
                    
                    currentConfigPage = 1;
                    renderConfigTable();
                    updateConfigPagination();
                    
                    console.log('✅ 配置列表加载完成');
                } else {
                    console.error('❌ 获取配置列表失败:', result.message);
                    allConfigs = [];
                    currentConfigPage = 1;
                    renderConfigTable();
                    updateConfigPagination();
                }
            })
            .catch(error => {
                console.error('❌ 配置列表API调用失败:', error);
                allConfigs = [];
                currentConfigPage = 1;
                renderConfigTable();
                updateConfigPagination();
            });
        }
        
        // 获取每个设备的最新备份记录
        function getLatestDeviceBackups(allBackups) {
            const deviceMap = new Map();
            
            // 遍历所有备份记录，为每个设备保留最新的记录
            allBackups.forEach(backup => {
                const deviceId = backup.deviceId;
                
                if (!deviceMap.has(deviceId)) {
                    deviceMap.set(deviceId, backup);
                } else {
                    const existingBackup = deviceMap.get(deviceId);
                    
                    // 比较版本号，保留更新的版本
                    if (compareVersions(backup.version, existingBackup.version) > 0) {
                        deviceMap.set(deviceId, backup);
                    } else if (compareVersions(backup.version, existingBackup.version) === 0) {
                        // 版本号相同时，比较时间戳
                        const backupTime = new Date(backup.createTime);
                        const existingTime = new Date(existingBackup.createTime);
                        if (backupTime > existingTime) {
                            deviceMap.set(deviceId, backup);
                        }
                    }
                }
            });
            
            return Array.from(deviceMap.values());
        }
        
        // 比较版本号大小
        function compareVersions(version1, version2) {
            // 解析版本号 (如 v1.2)
            const parseVersion = (version) => {
                const match = version.match(/^v(\d+)\.(\d+)$/);
                if (match) {
                    return parseFloat(match[1] + '.' + match[2]);
                }
                return 0;
            };
            
            const v1 = parseVersion(version1);
            const v2 = parseVersion(version2);
            
            if (v1 > v2) return 1;
            if (v1 < v2) return -1;
            return 0;
        }
        
        // 获取设备的版本数量
        function getDeviceVersionCount(deviceId, allBackups) {
            return allBackups.filter(backup => backup.deviceId == deviceId).length;
        }
        
        // 重置搜索条件
        function resetConfigSearch() {
            document.getElementById('configKeywordSearch').value = '';
            document.getElementById('configTimeFilter').value = '';
            loadConfigList();
        }

        // 渲染配置表格（分页）
        function renderConfigTable() {
            const tbody = document.getElementById('configTableBody');
            
            if (allConfigs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>暂无配置数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // 计算当前页的数据
            const startIndex = (currentConfigPage - 1) * configsPerPage;
            const endIndex = startIndex + configsPerPage;
            const pageConfigs = allConfigs.slice(startIndex, endIndex);

            tbody.innerHTML = pageConfigs.map(config => {
                const backupStatusClass = config.backupStatus === 'success' ? 'status-online' : 'status-offline';
                const backupStatusText = config.backupStatus === 'success' ? '成功' : '失败';

                return `
                    <tr>
                        <td>${config.deviceName}</td>
                        <td>${config.deviceIp}</td>
                        <td>${config.baselineVersion || '-'}</td>
                        <td>${config.lastBackupTime || '-'}</td>
                        <td><span class="status-badge ${backupStatusClass}">${backupStatusText}</span></td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn-detail" onclick="viewConfigHistory(${config.deviceId}, '${config.deviceName}')">
                                    <i class="fas fa-history"></i> 版本历史
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 更新配置管理分页控件
        function updateConfigPagination() {
            const totalPages = Math.ceil(allConfigs.length / configsPerPage);
            
            document.getElementById('currentConfigPage').textContent = currentConfigPage;
            document.getElementById('totalConfigPages').textContent = totalPages;
            document.getElementById('totalConfigs').textContent = allConfigs.length;
            
            document.getElementById('prevConfigPageBtn').disabled = currentConfigPage === 1;
            document.getElementById('nextConfigPageBtn').disabled = currentConfigPage === totalPages || totalPages === 0;
        }

        // 配置管理上一页
        function prevConfigPage() {
            if (currentConfigPage > 1) {
                currentConfigPage--;
                renderConfigTable();
                updateConfigPagination();
            }
        }

        // 配置管理下一页
        function nextConfigPage() {
            const totalPages = Math.ceil(allConfigs.length / configsPerPage);
            if (currentConfigPage < totalPages) {
                currentConfigPage++;
                renderConfigTable();
                updateConfigPagination();
            }
        }

        // 立即备份设备配置
        function backupDevice(deviceId, deviceName) {
            if (confirm(`确定要立即备份设备 "${deviceName}" 的配置吗？`)) {
                console.log('开始备份设备:', deviceId, deviceName);
                
                // 显示备份进度提示
                alert('正在备份配置，请稍候...');
                
                // TODO: 调用备份API
                fetch(`/api/network/config/backup/${deviceId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`设备 "${deviceName}" 配置备份成功！`);
                        // 刷新配置列表
                        loadConfigList();
                    } else {
                        alert(`备份失败: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('备份失败:', error);
                    alert('备份失败，请稍后重试');
                });
            }
        }

        // 查看设备快照详情
        function viewDeviceSnapshot(deviceId, deviceName) {
            console.log('查看设备快照:', deviceId, deviceName);
            
            // 从localStorage获取配置备份数据
            const configBackups = JSON.parse(localStorage.getItem('configBackups') || '{}');
            const deviceBackup = configBackups[deviceId];
            
            if (!deviceBackup || deviceBackup.backups.length === 0) {
                alert(`设备 "${deviceName}" 暂无备份记录`);
                return;
            }
            
            // 获取最新的备份快照
            const latestBackup = deviceBackup.backups[0];
            const snapshot = latestBackup.deviceSnapshot;
            
            // 创建详情模态框
            showDeviceSnapshotModal(snapshot, latestBackup, deviceBackup);
        }

        // 显示设备快照详情模态框
        function showDeviceSnapshotModal(snapshot, backup, deviceBackup) {
            // 创建模态框HTML
            const modalHTML = `
                <div id="snapshotModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    ">
                        <!-- 头部 -->
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #fff;
                            padding: 25px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 24px;">
                                    <i class="fas fa-camera"></i> 设备快照详情
                                </h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    备份版本: ${backup.version} | 备份时间: ${backup.backupTime}
                                </p>
                            </div>
                            <button onclick="closeSnapshotModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- 内容区域 -->
                        <div style="padding: 30px;">
                            <!-- 基本信息 -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #667eea;
                                ">
                                    <i class="fas fa-info-circle"></i> 基本信息
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #667eea;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">设备ID</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceId || snapshot.id}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #667eea;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">设备名称</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceName || snapshot.name}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">IP地址</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceIp || snapshot.ip}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">设备类型</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${getDeviceTypeText(snapshot.deviceType || snapshot.type)}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid ${(snapshot.deviceStatus || snapshot.status) === 'online' ? '#4CAF50' : '#F44336'};
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">设备状态</div>
                                        <div style="color: ${(snapshot.deviceStatus || snapshot.status) === 'online' ? '#4CAF50' : '#F44336'}; font-size: 16px; font-weight: 500;">
                                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i>
                                            ${(snapshot.deviceStatus || snapshot.status) === 'online' ? '在线' : '离线'}
                                        </div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #FF9800;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">所属分组</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.groupName || '未分组'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #9C27B0;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">设备型号</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceModel || snapshot.model || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #9C27B0;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">制造商</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.manufacturer || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #607D8B;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">序列号</div>
                                        <div style="color: #333; font-size: 14px; font-weight: 500;">${snapshot.serialNumber || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #607D8B;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">MAC地址</div>
                                        <div style="color: #333; font-size: 14px; font-weight: 500;">${snapshot.macAddress || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #00BCD4;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">物理位置</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.location || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #00BCD4;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">接口数量</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.interfaceCount || 0} 个</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 性能指标 -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #FF5722;
                                ">
                                    <i class="fas fa-tachometer-alt"></i> 性能指标（快照时刻）
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(4, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">CPU使用率</div>
                                        <div style="font-size: 28px; font-weight: bold;">${(snapshot.cpuUsage || 0).toFixed(1)}%</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">内存使用率</div>
                                        <div style="font-size: 28px; font-weight: bold;">${(snapshot.memoryUsage || 0).toFixed(1)}%</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">磁盘使用率</div>
                                        <div style="font-size: 28px; font-weight: bold;">${(snapshot.diskUsage || 0).toFixed(1)}%</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #FA709A 0%, #FEE140 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">运行时长</div>
                                        <div style="font-size: 20px; font-weight: bold;">${formatUptime(snapshot.uptime || 0)}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 备份信息 -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #4CAF50;
                                ">
                                    <i class="fas fa-save"></i> 备份信息
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #2196F3;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">备份版本</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${backup.version}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #2196F3;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">备份时间</div>
                                        <div style="color: #333; font-size: 14px; font-weight: 500;">${backup.backupTime}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">备份状态</div>
                                        <div style="color: ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'}; font-size: 16px; font-weight: 500;">
                                            <i class="fas ${backup.backupStatus === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                            ${backup.backupStatus === 'success' ? '成功' : '失败'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 统计信息 -->
                            <div style="margin-bottom: 20px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #FF9800;
                                ">
                                    <i class="fas fa-chart-bar"></i> 统计信息
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">总备份次数</div>
                                        <div style="font-size: 32px; font-weight: bold;">${deviceBackup.backups ? deviceBackup.backups.length : 0}</div>
                                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">次</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">当前版本号</div>
                                        <div style="font-size: 32px; font-weight: bold;">${backup.version || '-'}</div>
                                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">版本</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 快照时间戳 -->
                            <div style="
                                background: #e3f2fd;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #2196F3;
                                margin-top: 20px;
                            ">
                                <div style="color: #1976D2; font-size: 14px;">
                                    <i class="fas fa-clock"></i> 
                                    <strong>快照时间：</strong>${backup.backupTime}
                                </div>
                                <div style="color: #666; font-size: 12px; margin-top: 5px;">
                                    此快照记录了该时刻设备的完整状态信息
                                </div>
                            </div>
                        </div>

                        <!-- 底部按钮 -->
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: flex-end;
                            gap: 10px;
                        ">
                            <button onclick="closeSnapshotModal()" style="
                                padding: 10px 20px;
                                background: #607D8B;
                                color: #fff;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // 关闭快照详情模态框
        function closeSnapshotModal() {
            const modal = document.getElementById('snapshotModal');
            if (modal) {
                modal.remove();
            }
        }

        // 获取设备类型文本
        function getDeviceTypeText(type) {
            const typeMap = {
                'router': '路由器',
                'switch': '交换机',
                'firewall': '防火墙',
                'server': '服务器',
                'storage': '存储设备',
                'wireless': '无线AP',
                'load_balancer': '负载均衡',
                'network': '网络设备'
            };
            return typeMap[type] || type || '未知';
        }

        // 格式化运行时长
        function formatUptime(seconds) {
            if (!seconds || seconds === 0) return '0天';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}天${hours}时`;
            } else if (hours > 0) {
                return `${hours}时${minutes}分`;
            } else {
                return `${minutes}分钟`;
            }
        }

        // 查看配置历史 - 从数据库读取
        function viewConfigHistory(deviceId, deviceName) {
            console.log(`🔍 查看设备版本历史: ${deviceName} (ID: ${deviceId})`);
            
            fetch(`/api/config-backup/history/${deviceId}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('📡 版本历史API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('📊 版本历史API结果:', result);
                
                if (result.success && result.data && result.data.length > 0) {
                    // 获取第一条记录作为设备基本信息的来源
                    const firstRecord = result.data[0];
                    
                    // 转换数据格式以适配模态框
                    const deviceBackup = {
                        deviceId: deviceId,
                        deviceName: firstRecord.deviceName || deviceName,
                        deviceType: firstRecord.deviceType || '未知',
                        deviceIp: '获取中...', // 需要从其他地方获取
                        backups: result.data.map(history => ({
                            version: history.version,
                            backupTime: history.backupTime,
                            operator: history.operator || 'admin',
                            backupSize: history.backupSize || 'N/A',
                            backupStatus: 'success', // 修正字段名，强制设置为成功状态
                            changeSummary: history.changeSummary || '配置备份',
                            changeDetails: history.changeDetails,
                            backupId: history.backupId,
                            // 添加设备详细信息
                            deviceId: history.deviceId,
                            deviceName: history.deviceName,
                            deviceType: history.deviceType
                        }))
                    };
                    
                    // 从备份记录中获取设备详细信息
                    if (deviceBackup.backups.length > 0) {
                        const latestBackup = deviceBackup.backups[0];
                        // 通过备份ID获取完整的设备快照信息
                        fetch(`/api/config-backup/snapshot/${latestBackup.backupId}`, {
                            method: 'GET',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(snapshotResult => {
                            if (snapshotResult.success && snapshotResult.backup) {
                                const backup = snapshotResult.backup;
                                deviceBackup.deviceIp = backup.deviceIp || 'N/A';
                                deviceBackup.assetCode = backup.assetCode || 'N/A';
                                deviceBackup.manufacturer = backup.manufacturer || 'N/A';
                                deviceBackup.model = backup.model || 'N/A';
                                
                                // 更新模态框中的设备信息
                                updateModalDeviceInfo(deviceBackup);
                            }
                        })
                        .catch(error => {
                            console.log('获取设备快照失败:', error);
                        });
                    }
                    
                    showVersionHistoryModal(deviceName, deviceBackup);
                } else {
                    alert(`设备 "${deviceName}" 暂无备份历史`);
                }
            })
            .catch(error => {
                console.error('❌ 版本历史API调用失败:', error);
                alert('获取版本历史失败，请稍后重试');
            });
        }
        
        // 更新模态框中的设备信息
        function updateModalDeviceInfo(deviceBackup) {
            // 这个函数用于在获取到完整设备信息后更新模态框显示
            // 由于模态框已经显示，这里可以通过DOM操作更新信息
            console.log('更新模态框设备信息:', deviceBackup);
        }
        
        // 解析版本号为数字（用于排序）
        function parseVersionNumber(version) {
            const match = version.match(/^v(\d+)\.(\d+)$/);
            if (match) {
                return parseFloat(match[1] + '.' + match[2]);
            }
            return 0;
        }

        // 显示版本历史模态框
        function showVersionHistoryModal(deviceName, deviceBackup) {
            const modalHTML = `
                <div id="historyModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    ">
                        <!-- 头部 -->
                        <div style="
                            background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
                            color: #fff;
                            padding: 25px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 24px;">
                                    <i class="fas fa-history"></i> 版本历史
                                </h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    设备: ${deviceName} | 总计 ${deviceBackup.backups.length} 个版本
                                </p>
                            </div>
                            <button onclick="closeHistoryModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- 时间线内容 -->
                        <div style="padding: 30px;">
                            <div style="position: relative; padding-left: 40px;">
                                <!-- 时间线竖线 -->
                                <div style="
                                    position: absolute;
                                    left: 15px;
                                    top: 0;
                                    bottom: 0;
                                    width: 2px;
                                    background: linear-gradient(180deg, #4FACFE 0%, #00F2FE 100%);
                                "></div>
                                
                                ${deviceBackup.backups.map((backup, index) => `
                                    <div style="
                                        position: relative;
                                        margin-bottom: ${index < deviceBackup.backups.length - 1 ? '30px' : '0'};
                                        background: #fff;
                                        border: 2px solid ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                        border-radius: 8px;
                                        padding: 20px;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                        transition: transform 0.2s, box-shadow 0.2s;
                                    " onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" 
                                       onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                                        <!-- 时间线圆点 -->
                                        <div style="
                                            position: absolute;
                                            left: -33px;
                                            top: 20px;
                                            width: 16px;
                                            height: 16px;
                                            background: ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                            border: 3px solid #fff;
                                            border-radius: 50%;
                                            box-shadow: 0 0 0 2px ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                        "></div>
                                        
                                        <!-- 版本标题 -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="
                                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                    color: #fff;
                                                    padding: 5px 15px;
                                                    border-radius: 20px;
                                                    font-weight: bold;
                                                    font-size: 16px;
                                                ">版本 ${backup.version}</span>
                                                ${index === 0 ? '<span style="background: #FF9800; color: #fff; padding: 3px 10px; border-radius: 12px; font-size: 12px;">最新</span>' : ''}
                                            </div>
                                            <div style="
                                                color: ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                                font-weight: bold;
                                                display: flex;
                                                align-items: center;
                                                gap: 5px;
                                            ">
                                                <i class="fas ${backup.backupStatus === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                                ${backup.backupStatus === 'success' ? '备份成功' : '备份失败'}
                                            </div>
                                        </div>
                                        
                                        <!-- 版本信息 -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: repeat(2, 1fr);
                                            gap: 15px;
                                            margin-bottom: 15px;
                                        ">
                                            <div style="
                                                background: #f8f9fa;
                                                padding: 10px 15px;
                                                border-radius: 6px;
                                                border-left: 3px solid #2196F3;
                                            ">
                                                <div style="color: #666; font-size: 12px; margin-bottom: 3px;">
                                                    <i class="fas fa-clock"></i> 备份时间
                                                </div>
                                                <div style="color: #333; font-size: 14px; font-weight: 500;">
                                                    ${backup.backupTime}
                                                </div>
                                            </div>
                                            <div style="
                                                background: #f8f9fa;
                                                padding: 10px 15px;
                                                border-radius: 6px;
                                                border-left: 3px solid #9C27B0;
                                            ">
                                                <div style="color: #666; font-size: 12px; margin-bottom: 3px;">
                                                    <i class="fas fa-server"></i> 设备状态
                                                </div>
                                                <div style="color: #333; font-size: 14px; font-weight: 500;">
                                                    ${(backup.deviceSnapshot && backup.deviceSnapshot.deviceStatus === 'online') ? '🟢 在线' : '🔴 离线'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 操作按钮 -->
                                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                            <button onclick="viewVersionSnapshot(${deviceBackup.deviceId}, ${backup.backupId}); event.stopPropagation();" style="
                                                padding: 8px 16px;
                                                background: #2196F3;
                                                color: #fff;
                                                border: none;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-size: 13px;
                                            ">
                                                <i class="fas fa-eye"></i> 查看快照
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- 底部 -->
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: flex-end;
                        ">
                            <button onclick="closeHistoryModal()" style="
                                padding: 10px 20px;
                                background: #607D8B;
                                color: #fff;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // 关闭版本历史模态框
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }

        // 查看指定版本的快照
        function viewVersionSnapshot(deviceId, backupId) {
            console.log('查看版本快照:', deviceId, backupId);
            
            // 从后端API获取快照数据
            fetch(`/api/config-backup/snapshot/${backupId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const data = result.data;
                        
                        // 详细调试信息
                        console.log('🔍 快照API返回结果:', result);
                        console.log('📊 设备数据详情:', data);
                        console.log('🆔 设备ID:', data.deviceId);
                        console.log('📛 设备名称:', data.deviceName);
                        console.log('🌐 设备IP:', data.deviceIp);
                        console.log('🏷️ 设备类型:', data.deviceType);
                        console.log('🏭 厂商:', data.manufacturer);
                        console.log('📱 型号:', data.model);
                        console.log('📋 所有字段:', Object.keys(data));
                        
                        // 快照数据（已包含所有字段）
                        const snapshot = data;
                        
                        // 构造backup对象（用于显示）
                        const backup = {
                            version: data.version || '-',
                            backupTime: data.backupTime || data.createdAt || '-',
                            backupStatus: data.backupStatus || 'success'
                        };
                        
                        // 构造deviceBackup对象（用于显示统计信息）
                        const deviceBackup = {
                            deviceId: deviceId,
                            backups: [] // 可以为空，因为我们只显示当前快照
                        };
                        
                        // 关闭历史模态框
                        closeHistoryModal();
                        
                        // 延迟一下再显示快照详情，确保历史模态框已关闭
                        setTimeout(() => {
                            showDeviceSnapshotModal(snapshot, backup, deviceBackup);
                        }, 100);
                    } else {
                        alert('未找到该版本的快照数据');
                    }
                })
                .catch(error => {
                    console.error('获取快照失败:', error);
                    alert('获取快照失败，请稍后重试');
                });
        }

        // 模拟专线数据
        let mockLines = [
            {
                id: 1,
                name: '北京-上海专线',
                provider: '中国电信',
                bandwidth: '100Mbps',
                endpointA: '北京机房',
                endpointB: '上海机房',
                status: 'normal',
                latency: 25.5,
                jitter: 5.2,
                packetLoss: 0.05
            },
            {
                id: 2,
                name: '北京-广州专线',
                provider: '中国联通',
                bandwidth: '200Mbps',
                endpointA: '北京机房',
                endpointB: '广州机房',
                status: 'warning',
                latency: 45.8,
                jitter: 8.5,
                packetLoss: 0.15
            },
            {
                id: 3,
                name: '机房A-机房B专线',
                provider: '中国移动',
                bandwidth: '500Mbps',
                endpointA: '机房A',
                endpointB: '机房B',
                status: 'normal',
                latency: 18.2,
                jitter: 3.1,
                packetLoss: 0.02
            },
            {
                id: 4,
                name: '互联网出口专线',
                provider: '中国电信',
                bandwidth: '1Gbps',
                endpointA: '核心机房',
                endpointB: '互联网',
                status: 'fault',
                latency: 85.6,
                jitter: 15.3,
                packetLoss: 2.5
            }
        ];

        // 加载专线列表
        function loadLinesList() {
            const provider = document.getElementById('lineProviderFilter')?.value || '';
            const status = document.getElementById('lineStatusFilter')?.value || '';
            const keyword = document.getElementById('lineKeywordSearch')?.value || '';
            
            // 构建查询参数
            let params = [];
            if (provider) params.push(`provider=${encodeURIComponent(provider)}`);
            if (status) params.push(`status=${encodeURIComponent(status)}`);
            if (keyword) params.push(`keyword=${encodeURIComponent(keyword)}`);
            
            const queryString = params.length > 0 ? '?' + params.join('&') : '';
            
            // 从API获取数据
            fetch(`/api/lines${queryString}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        renderLineTable(result.data || []);
                    } else {
                        console.error('获取专线列表失败:', result.message);
                        renderLineTable([]);
                    }
                })
                .catch(error => {
                    console.error('加载专线列表失败:', error);
                    renderLineTable([]);
                });
        }

        // 渲染专线表格
        function renderLineTable(lines) {
            const tbody = document.getElementById('lineTableBody');
            
            if (lines.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state">
                                <i class="fas fa-project-diagram"></i>
                                <p>暂无专线数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = lines.map(line => {
                const statusClass = line.status === 'normal' ? 'status-online' : 
                                   line.status === 'warning' ? 'status-maintenance' : 'status-offline';
                const statusText = line.status === 'normal' ? '正常' : 
                                  line.status === 'warning' ? '警告' : '故障';
                
                const latencyClass = line.latency < 30 ? 'status-online' : 
                                    line.latency < 50 ? 'status-maintenance' : 'status-offline';
                const packetLossClass = line.packetLoss < 0.1 ? 'status-online' : 
                                       line.packetLoss < 1 ? 'status-maintenance' : 'status-offline';

                return `
                    <tr>
                        <td>${line.id}</td>
                        <td>${line.name}</td>
                        <td>${line.provider}</td>
                        <td>${line.bandwidth}</td>
                        <td>${line.endpointA}</td>
                        <td>${line.endpointB}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td><span class="status-badge ${latencyClass}">${line.latency}ms</span></td>
                        <td><span class="status-badge ${packetLossClass}">${line.packetLoss}%</span></td>
                        <td>
                            <button class="btn-detail" onclick="viewLineDetail(${line.id})" style="margin-right: 5px;">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                            <button class="btn-detail" onclick="editLine(${line.id})" style="margin-right: 5px; background: #FF9800;">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn-detail" onclick="deleteLine(${line.id})" style="background: #F44336;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 查看专线详情
        function viewLineDetail(lineId) {
            fetch(`/api/lines/${lineId}`)
                .then(response => response.json())
                .then(line => {
                    if (line) {
                        showLineDetailModal(line);
                    } else {
                        alert('未找到专线信息');
                    }
                })
                .catch(error => {
                    console.error('获取专线详情失败:', error);
                    alert('获取专线详情失败');
                });
        }

        // 显示专线详情模态框
        function showLineDetailModal(line) {
            const statusText = line.status === 'normal' ? '正常' : 
                              line.status === 'warning' ? '警告' : '故障';
            const statusColor = line.status === 'normal' ? '#4CAF50' : 
                               line.status === 'warning' ? '#FF9800' : '#F44336';
            
            const modalHTML = `
                <div id="lineDetailModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        animation: slideUp 0.3s;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #fff;
                            padding: 25px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 24px;">
                                <i class="fas fa-project-diagram"></i> 专线详情
                            </h2>
                            <button onclick="closeLineDetailModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                                transition: all 0.3s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="padding: 30px;">
                            <!-- 基本信息 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-info-circle"></i> 基本信息
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">专线名称</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.name}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">电路ID</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.circuitId || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">运营商</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.provider}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">专线类型</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.lineType || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">带宽</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.bandwidth}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">状态</div>
                                        <div style="color: ${statusColor}; font-size: 16px; font-weight: 500;">
                                            <i class="fas fa-circle" style="font-size: 8px;"></i> ${statusText}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 端点信息 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-map-marker-alt"></i> 端点信息
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">端点A</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.endpointA}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">端点B</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.endpointB}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- SLA指标 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-chart-line"></i> SLA指标
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">延迟阈值</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaLatency || '-'}ms</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">抖动阈值</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaJitter || '-'}ms</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">丢包率阈值</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaPacketLoss || '-'}%</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">可用性要求</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaAvailability || '-'}%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 合同信息 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-file-contract"></i> 合同信息
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">开通日期</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.activationDate || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">到期日期</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.expiryDate || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">月租费用</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">¥${line.monthlyCost || '-'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 联系信息 -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-address-book"></i> 联系信息
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #00BCD4;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">联系人</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.contactPerson || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #00BCD4;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">联系电话</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.contactPhone || '-'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 备注 -->
                            ${line.notes ? `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-sticky-note"></i> 备注
                                </h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #607D8B;">
                                    <div style="color: #333; font-size: 14px; line-height: 1.6;">${line.notes}</div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 30px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="closeLineDetailModal(); editLine(${line.id});" style="
                                    padding: 10px 20px;
                                    background: #FF9800;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#F57C00'" 
                                   onmouseout="this.style.background='#FF9800'">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button onclick="closeLineDetailModal()" style="
                                    padding: 10px 20px;
                                    background: #607D8B;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#455A64'" 
                                   onmouseout="this.style.background='#607D8B'">
                                    <i class="fas fa-times"></i> 关闭
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // 关闭专线详情模态框
        function closeLineDetailModal() {
            const modal = document.getElementById('lineDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        // 编辑专线
        function editLine(lineId) {
            fetch(`/api/lines/${lineId}`)
                .then(response => response.json())
                .then(line => {
                    if (line) {
                        showLineFormModal(line);
                    } else {
                        alert('未找到专线信息');
                    }
                })
                .catch(error => {
                    console.error('获取专线信息失败:', error);
                    alert('获取专线信息失败');
                });
        }

        // 显示专线表单模态框（添加/编辑）
        function showLineFormModal(line) {
            const isEdit = line !== null;
            const modalHTML = `
                <div id="lineFormModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        animation: slideUp 0.3s;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #fff;
                            padding: 20px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 22px;">
                                <i class="fas ${isEdit ? 'fa-edit' : 'fa-plus'}"></i> ${isEdit ? '编辑专线' : '添加专线'}
                            </h2>
                            <button onclick="closeLineFormModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="lineForm" style="padding: 30px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <!-- 基本信息 -->
                                <div style="grid-column: 1 / -1;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-info-circle"></i> 基本信息
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        专线名称 <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="lineName" value="${line?.name || ''}" required 
                                        placeholder="例如：北京-上海专线"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        电路ID <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="circuitId" value="${line?.circuitId || ''}" required 
                                        placeholder="例如：CT-BJ-SH-001"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        运营商 <span style="color: red;">*</span>
                                    </label>
                                    <select id="lineProvider" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">请选择运营商</option>
                                        <option value="中国电信" ${line?.provider === '中国电信' ? 'selected' : ''}>中国电信</option>
                                        <option value="中国联通" ${line?.provider === '中国联通' ? 'selected' : ''}>中国联通</option>
                                        <option value="中国移动" ${line?.provider === '中国移动' ? 'selected' : ''}>中国移动</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        专线类型 <span style="color: red;">*</span>
                                    </label>
                                    <select id="lineType" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">请选择类型</option>
                                        <option value="MPLS" ${line?.lineType === 'MPLS' ? 'selected' : ''}>MPLS</option>
                                        <option value="IPLC" ${line?.lineType === 'IPLC' ? 'selected' : ''}>IPLC</option>
                                        <option value="IEPL" ${line?.lineType === 'IEPL' ? 'selected' : ''}>IEPL</option>
                                        <option value="互联网专线" ${line?.lineType === '互联网专线' ? 'selected' : ''}>互联网专线</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        带宽 <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="bandwidth" value="${line?.bandwidth || ''}" required 
                                        placeholder="例如：100Mbps"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        状态 <span style="color: red;">*</span>
                                    </label>
                                    <select id="lineStatus" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="normal" ${line?.status === 'normal' ? 'selected' : ''}>正常</option>
                                        <option value="warning" ${line?.status === 'warning' ? 'selected' : ''}>警告</option>
                                        <option value="fault" ${line?.status === 'fault' ? 'selected' : ''}>故障</option>
                                    </select>
                                </div>

                                <!-- 端点信息 -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-map-marker-alt"></i> 端点信息
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        端点A <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="endpointA" value="${line?.endpointA || ''}" required 
                                        placeholder="例如：北京数据中心"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        端点B <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="endpointB" value="${line?.endpointB || ''}" required 
                                        placeholder="例如：上海数据中心"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>

                                <!-- 合同信息 -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-file-contract"></i> 合同信息
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        开通日期
                                    </label>
                                    <input type="date" id="activationDate" value="${line?.activationDate || ''}"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        到期日期
                                    </label>
                                    <input type="date" id="expiryDate" value="${line?.expiryDate || ''}"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        月租费用（元）
                                    </label>
                                    <input type="number" id="monthlyCost" value="${line?.monthlyCost || ''}" 
                                        placeholder="例如：8000"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>

                                <!-- 联系信息 -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-address-book"></i> 联系信息
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        联系人
                                    </label>
                                    <input type="text" id="contactPerson" value="${line?.contactPerson || ''}" 
                                        placeholder="例如：张伟"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        联系电话
                                    </label>
                                    <input type="text" id="contactPhone" value="${line?.contactPhone || ''}" 
                                        placeholder="例如：13800138000"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>

                                <!-- 备注 -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        <i class="fas fa-sticky-note"></i> 备注
                                    </label>
                                    <textarea id="notes" rows="3" 
                                        placeholder="请输入备注信息..."
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${line?.notes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 20px;">
                                <button type="button" onclick="closeLineFormModal()" style="
                                    padding: 10px 25px;
                                    background: #607D8B;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#455A64'" 
                                   onmouseout="this.style.background='#607D8B'">
                                    <i class="fas fa-times"></i> 取消
                                </button>
                                <button type="submit" style="
                                    padding: 10px 25px;
                                    background: #4CAF50;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#45a049'" 
                                   onmouseout="this.style.background='#4CAF50'">
                                    <i class="fas fa-save"></i> 保存
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 表单提交事件
            document.getElementById('lineForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveLineData(line?.id);
            });
        }

        // 保存专线数据
        function saveLineData(lineId) {
            const lineData = {
                name: document.getElementById('lineName').value.trim(),
                circuitId: document.getElementById('circuitId').value.trim(),
                provider: document.getElementById('lineProvider').value,
                lineType: document.getElementById('lineType').value,
                bandwidth: document.getElementById('bandwidth').value.trim(),
                status: document.getElementById('lineStatus').value,
                endpointA: document.getElementById('endpointA').value.trim(),
                endpointB: document.getElementById('endpointB').value.trim(),
                activationDate: document.getElementById('activationDate').value || null,
                expiryDate: document.getElementById('expiryDate').value || null,
                monthlyCost: document.getElementById('monthlyCost').value || null,
                contactPerson: document.getElementById('contactPerson').value.trim() || null,
                contactPhone: document.getElementById('contactPhone').value.trim() || null,
                notes: document.getElementById('notes').value.trim() || null
            };
            
            // 验证必填字段
            if (!lineData.name || !lineData.circuitId || !lineData.provider || 
                !lineData.lineType || !lineData.bandwidth || !lineData.endpointA || !lineData.endpointB) {
                alert('请填写所有必填字段！');
                return;
            }
            
            console.log('准备保存专线数据:', lineData);
            
            const url = lineId ? `/api/lines/${lineId}` : '/api/lines';
            const method = lineId ? 'PUT' : 'POST';
            
            console.log(`发送请求: ${method} ${url}`);
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(lineData)
            })
            .then(response => {
                console.log('响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('保存结果:', result);
                if (result === true || result.success === true) {
                    alert(lineId ? '专线更新成功！' : '专线添加成功！');
                    closeLineFormModal();
                    loadLinesList();
                } else {
                    const errorMsg = result.message || '操作失败！';
                    alert(errorMsg);
                    console.error('操作失败:', result);
                }
            })
            .catch(error => {
                console.error('保存专线失败:', error);
                alert('保存专线失败: ' + error.message);
            });
        }

        // 关闭专线表单模态框
        function closeLineFormModal() {
            const modal = document.getElementById('lineFormModal');
            if (modal) {
                modal.remove();
            }
        }

        // 删除专线
        function deleteLine(lineId) {
            if (confirm('确定要删除这条专线吗？此操作不可恢复！')) {
                console.log('删除专线:', lineId);
                
                fetch(`/api/lines/${lineId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    console.log('删除响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('删除结果:', result);
                    if (result.success === true) {
                        alert('专线删除成功！');
                        loadLinesList();
                    } else {
                        const errorMsg = result.message || '删除失败！';
                        alert(errorMsg);
                        console.error('删除失败:', result);
                    }
                })
                .catch(error => {
                    console.error('删除专线失败:', error);
                    alert('删除专线失败: ' + error.message);
                });
            }
        }

        // 添加专线
        function addLine() {
            showLineFormModal(null);
        }

        // 重置专线筛选
        function resetLineFilters() {
            // 清空所有筛选条件
            document.getElementById('lineProviderFilter').value = '';
            document.getElementById('lineStatusFilter').value = '';
            document.getElementById('lineKeywordSearch').value = '';
            // 重新加载专线列表
            loadLinesList();
        }

        // 搜索专线
        document.addEventListener('DOMContentLoaded', function() {
            const searchBtn = document.getElementById('searchLineBtn');
            const resetBtn = document.getElementById('resetLineBtn');
            const addBtn = document.getElementById('addLineBtn');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', loadLinesList);
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', resetLineFilters);
            }
            
            if (addBtn) {
                addBtn.addEventListener('click', addLine);
            }
            
            const keywordInput = document.getElementById('lineKeywordSearch');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loadLinesList();
                    }
                });
            }
        });

        // 跳转到设备管理页面的指定分组
        function navigateToDeviceGroup(groupId, groupName) {
            // 使用URL参数传递分组ID和名称
            window.location.href = `设备管理.html?groupId=${groupId}&groupName=${encodeURIComponent(groupName)}`;
        }

        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', function() {
            loadDeviceStats();
            loadDeviceList();
            loadConfigStats();
            loadConfigList();
            loadLinesList();
        });
    </script>
    
    <!-- 侧边栏导航脚本 -->
    <script src="js/navigation-fix.js"></script>
    
    <!-- 加载用户下拉菜单 -->
    <script src="js/user-dropdown-loader.js"></script>
        </div>
    </div>
</div>
</body>
</html>
