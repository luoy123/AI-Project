<!DOCTYPE html>
<html lang="zh-CN">
<head>
<style>
/* ç«‹å³éšè—CMDBèœå•é¡¹ - é˜²æ­¢é—ªçƒ */
.nav-cmdb { display: none !important; }
.sidebar-item[data-page="CMDB"] { display: none !important; }
</style>
<script>
// ç«‹å³æ‰§è¡Œï¼šå°½æ—©éšè—CMDBï¼Œé˜²æ­¢é—ªçƒ
(function() {
    function hideCMDB() {
        var items = document.querySelectorAll('.sidebar-item');
        items.forEach(function(item) {
            var span = item.querySelector('span');
            if (span && span.textContent.trim() === 'CMDB') {
                item.style.display = 'none';
                item.setAttribute('data-hidden', 'true');
            }
        });
    }
    
    // ç«‹å³æ‰§è¡Œ
    hideCMDB();
    
    // DOM Readyæ—¶å†æ‰§è¡Œä¸€æ¬¡
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideCMDB);
    }
    
    // é¢å¤–ä¿é™©ï¼šå»¶è¿Ÿæ‰§è¡Œç¡®ä¿è¦†ç›–æ‰€æœ‰æƒ…å†µ
    setTimeout(hideCMDB, 10);
    setTimeout(hideCMDB, 100);
})();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œç®¡ç† - äººå·¥æ™ºèƒ½è¿ç»´å¹³å°</title>
    <link rel="stylesheet" href="libs/fontawesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="è®¾å¤‡ç®¡ç†.css">
    <!-- å¼•å…¥EChartså›¾è¡¨åº“ -->
    <script src="libs/echarts/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #fff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .content-area {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
        }

        /* é€‰é¡¹å¡ */
        .tabs {
            display: flex;
            gap: 10px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-item {
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .tab-item:hover {
            background: #f5f7fa;
            color: #333;
        }

        .tab-item.active {
            background: #2196F3;
            color: #fff;
        }

        .tab-item i {
            font-size: 16px;
        }

        /* é€‰é¡¹å¡å†…å®¹ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .stat-card.clickable:active {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #fff;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        /* æœç´¢å’Œè¿‡æ»¤ */
        .filters {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-item label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-item select:focus,
        .filter-item input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2196F3;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        /* è®¾å¤‡åˆ—è¡¨ */
        .device-table {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .device-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .device-table th {
            background: #f5f7fa;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            color: #666;
            font-size: 13px;
            border-bottom: 2px solid #e0e0e0;
        }

        .device-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .device-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .status-offline {
            background: #ffebee;
            color: #F44336;
        }

        .status-maintenance {
            background: #fff3e0;
            color: #FF9800;
        }

        .btn-detail {
            padding: 6px 12px;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-detail:hover {
            background: #1976D2;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading i {
            font-size: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ä¸“çº¿å¡ç‰‡æ ·å¼ */
        .line-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .line-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .line-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .line-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .line-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .line-status.normal {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .line-status.warning {
            background: #fff3e0;
            color: #FF9800;
        }

        .line-status.fault {
            background: #ffebee;
            color: #F44336;
        }

        .line-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .line-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .line-info-item i {
            color: #999;
            width: 16px;
        }

        .line-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .line-metric {
            text-align: center;
        }

        .line-metric-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
        }

        .line-metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .line-metric-value.good {
            color: #4CAF50;
        }

        .line-metric-value.warning {
            color: #FF9800;
        }

        .line-metric-value.bad {
            color: #F44336;
        }

        /* åˆ†é¡µæ§ä»¶ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #2196F3;
            color: #fff;
            border-color: #2196F3;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        .pagination-info span {
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>äººå·¥æ™ºèƒ½è¿ç»´å¹³å°</h2>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>æ€»è§ˆ</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-eye"></i>
            <span>è§†å›¾</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-bell"></i>
            <span>å‘Šè­¦ä¸­å¿ƒ</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-server"></i>
            <span>è®¾å¤‡ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-network-wired"></i>
            <span>ç½‘ç»œæ‹“æ‰‘</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-chart-line"></i>
            <span>ç»Ÿè®¡æŠ¥è¡¨</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-tools"></i>
            <span>è¿ç»´å·¥å…·</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-desktop"></i>
            <span>æ•°å­—å¤§å±</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-group-title">æ‹“å±•ä¸­å¿ƒ</div>
        <div class="sidebar-item">
            <i class="fas fa-layer-group"></i>
            <span>ä¸šåŠ¡ç®¡ç†</span>
        </div>
        <div class="sidebar-item active">
            <i class="fas fa-globe"></i>
            <span>ç½‘ç»œç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-video"></i>
            <span>è§†é¢‘ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-building"></i>
            <span>æœºæˆ¿ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-cubes"></i>
            <span>èµ„äº§ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-users"></i>
            <span>è¿ç»´ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-database"></i>
            <span>CMDB</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-file-alt"></i>
            <span>æ—¥å¿—ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-chart-pie"></i>
            <span>æ™ºèƒ½é¢„æµ‹ç®¡ç†</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-cloud"></i>
            <span>äº‘å¹³å°</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-group-title">è®¾ç½®ä¸­å¿ƒ</div>
        <div class="sidebar-item">
            <i class="fas fa-cog"></i>
            <span>è®¾ç½®</span>
        </div>
        <div class="sidebar-item">
            <i class="fas fa-plug"></i>
            <span>å¯¹æ¥é…ç½®</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="header">
            <h1>ç½‘ç»œç®¡ç†</h1>
            <!-- ç”¨æˆ·ä¸‹æ‹‰èœå•å®¹å™¨ -->
            <div id="user-dropdown-container"></div>
        </div>

        <div class="content-area">
            <!-- é€‰é¡¹å¡ -->
            <div class="tabs">
                <div class="tab-item active" data-tab="devices">
                    <i class="fas fa-server"></i>
                    <span>ç½‘ç»œè®¾å¤‡</span>
                </div>
                <div class="tab-item" data-tab="config">
                    <i class="fas fa-cog"></i>
                    <span>é…ç½®ç®¡ç†</span>
                </div>
                <div class="tab-item" data-tab="lines">
                    <i class="fas fa-project-diagram"></i>
                    <span>ä¸“çº¿ç®¡ç†</span>
                </div>
            </div>

        <!-- ç½‘ç»œè®¾å¤‡é€‰é¡¹å¡ -->
        <div class="tab-content active" id="devices-content">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card clickable" data-group-id="8" data-group-name="äº¤æ¢æœº" onclick="navigateToDeviceGroup(8, 'äº¤æ¢æœº')">
                    <div class="stat-icon" style="background: #2196F3;">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">äº¤æ¢æœº</div>
                        <div class="stat-value" id="switchCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="9" data-group-name="è·¯ç”±å™¨" onclick="navigateToDeviceGroup(9, 'è·¯ç”±å™¨')">
                    <div class="stat-icon" style="background: #4CAF50;">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">è·¯ç”±å™¨</div>
                        <div class="stat-value" id="routerCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="10" data-group-name="é˜²ç«å¢™" onclick="navigateToDeviceGroup(10, 'é˜²ç«å¢™')">
                    <div class="stat-icon" style="background: #FF9800;">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">é˜²ç«å¢™</div>
                        <div class="stat-value" id="firewallCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="11" data-group-name="æ— çº¿AP" onclick="navigateToDeviceGroup(11, 'æ— çº¿AP')">
                    <div class="stat-icon" style="background: #9C27B0;">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">æ— çº¿AP</div>
                        <div class="stat-value" id="apCount">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" data-group-id="12" data-group-name="ç½‘å…³" onclick="navigateToDeviceGroup(12, 'ç½‘å…³')">
                    <div class="stat-icon" style="background: #00BCD4;">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">ç½‘å…³</div>
                        <div class="stat-value" id="gatewayCount">0</div>
                    </div>
                </div>
            </div>

            <!-- æœç´¢å’Œè¿‡æ»¤ -->
            <div class="filters">
                <div class="filter-item">
                    <label>è®¾å¤‡ç±»å‹</label>
                    <select id="typeFilter">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="switch">äº¤æ¢æœº</option>
                        <option value="router">è·¯ç”±å™¨</option>
                        <option value="firewall">é˜²ç«å¢™</option>
                        <option value="ap">æ— çº¿AP</option>
                        <option value="gateway">ç½‘å…³</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>è®¾å¤‡çŠ¶æ€</label>
                    <select id="statusFilter">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="online">åœ¨çº¿</option>
                        <option value="offline">ç¦»çº¿</option>
                        <option value="maintenance">ç»´æŠ¤ä¸­</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å…³é”®å­—æœç´¢</label>
                    <input type="text" id="keywordSearch" placeholder="æœç´¢è®¾å¤‡åç§°æˆ–IPåœ°å€...">
                </div>
                <div class="filter-item" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button class="btn btn-primary" id="searchBtn">
                        <i class="fas fa-search"></i> æœç´¢
                    </button>
                    <button class="btn" id="resetBtn" style="background: #607D8B; border-color: #607D8B;">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                </div>
            </div>

            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <div class="device-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>è®¾å¤‡åç§°</th>
                            <th>IPåœ°å€</th>
                            <th>è®¾å¤‡ç±»å‹</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ†ç»„</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <tr>
                            <td colspan="7">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>åŠ è½½ä¸­...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="pagination" id="devicePagination">
                <button class="pagination-btn" id="prevPageBtn" disabled>
                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                </button>
                <span class="pagination-info">
                    ç¬¬ <span id="currentPage">1</span> é¡µ / å…± <span id="totalPages">1</span> é¡µ
                    ï¼ˆå…± <span id="totalDevices">0</span> æ¡è®°å½•ï¼‰
                </span>
                <button class="pagination-btn" id="nextPageBtn" disabled>
                    ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- é…ç½®ç®¡ç†é€‰é¡¹å¡ -->
        <div class="tab-content" id="config-content">
            <!-- é…ç½®ç®¡ç†æœç´¢åŒºåŸŸ -->
            <div style="
                margin-bottom: 30px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
                backdrop-filter: blur(10px);
            ">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <!-- æœç´¢è¾“å…¥æ¡† -->
                    <div style="flex: 1; min-width: 300px; position: relative;">
                        <div style="
                            position: relative;
                            background: rgba(255,255,255,0.95);
                            border-radius: 50px;
                            padding: 5px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                            backdrop-filter: blur(10px);
                        ">
                            <div style="
                                position: absolute;
                                left: 20px;
                                top: 50%;
                                transform: translateY(-50%);
                                color: #667eea;
                                font-size: 18px;
                                z-index: 2;
                            ">
                                <i class="fas fa-search"></i>
                            </div>
                            <input type="text" id="configKeywordSearch" placeholder="æœç´¢è®¾å¤‡åç§°ã€IPåœ°å€..." style="
                                width: 100%;
                                padding: 15px 20px 15px 55px;
                                border: none;
                                border-radius: 50px;
                                background: transparent;
                                font-size: 16px;
                                color: #333;
                                outline: none;
                                font-weight: 500;
                            ">
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿæ—¶é—´è¿‡æ»¤ -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="configTimeFilter" style="
                            padding: 12px 20px;
                            border: 2px solid rgba(255,255,255,0.3);
                            border-radius: 25px;
                            background: rgba(255,255,255,0.9);
                            color: #667eea;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            outline: none;
                            transition: all 0.3s;
                        " onfocus="this.style.borderColor='#fff'; this.style.boxShadow='0 0 0 3px rgba(255,255,255,0.2)'" 
                           onblur="this.style.borderColor='rgba(255,255,255,0.3)'; this.style.boxShadow='none'">
                            <option value="">å…¨éƒ¨æ—¶é—´</option>
                            <option value="today">ä»Šå¤©</option>
                            <option value="week">æœ€è¿‘ä¸€å‘¨</option>
                            <option value="month">æœ€è¿‘ä¸€æœˆ</option>
                        </select>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="display: flex; gap: 12px;">
                        <button id="searchConfigBtn" style="
                            padding: 12px 30px;
                            background: #fff;
                            color: #667eea;
                            border: none;
                            border-radius: 25px;
                            font-weight: 600;
                            font-size: 15px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255,255,255,0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255,255,255,0.3)'">
                            <i class="fas fa-search"></i>
                            <span>æœç´¢</span>
                        </button>
                        <button id="resetConfigBtn" style="
                            padding: 12px 25px;
                            background: rgba(255,255,255,0.2);
                            color: #fff;
                            border: 2px solid rgba(255,255,255,0.4);
                            border-radius: 25px;
                            font-weight: 500;
                            font-size: 15px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)'">
                            <i class="fas fa-redo"></i>
                            <span>é‡ç½®</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- è®¾å¤‡é…ç½®åˆ—è¡¨ -->
            <div class="device-table">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡åç§°</th>
                            <th>IPåœ°å€</th>
                            <th>å¤‡ä»½ç‰ˆæœ¬</th>
                            <th>æœ€æ–°å¤‡ä»½æ—¶é—´</th>
                            <th>å¤‡ä»½çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="configTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>åŠ è½½ä¸­...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="pagination" id="configPagination">
                <button class="pagination-btn" id="prevConfigPageBtn" disabled>
                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                </button>
                <span class="pagination-info">
                    ç¬¬ <span id="currentConfigPage">1</span> é¡µ / å…± <span id="totalConfigPages">1</span> é¡µ
                    ï¼ˆå…± <span id="totalConfigs">0</span> æ¡è®°å½•ï¼‰
                </span>
                <button class="pagination-btn" id="nextConfigPageBtn" disabled>
                    ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- ä¸“çº¿ç®¡ç†é€‰é¡¹å¡ -->
        <div class="tab-content" id="lines-content">
            <!-- å·¥å…·æ  -->
            <div class="filters" style="margin-bottom: 20px;">
                <div class="filter-item">
                    <label>è¿è¥å•†</label>
                    <select id="lineProviderFilter">
                        <option value="">å…¨éƒ¨è¿è¥å•†</option>
                        <option value="ä¸­å›½ç”µä¿¡">ä¸­å›½ç”µä¿¡</option>
                        <option value="ä¸­å›½è”é€š">ä¸­å›½è”é€š</option>
                        <option value="ä¸­å›½ç§»åŠ¨">ä¸­å›½ç§»åŠ¨</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>çŠ¶æ€</label>
                    <select id="lineStatusFilter">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="normal">æ­£å¸¸</option>
                        <option value="warning">è­¦å‘Š</option>
                        <option value="fault">æ•…éšœ</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å…³é”®å­—æœç´¢</label>
                    <input type="text" id="lineKeywordSearch" placeholder="æœç´¢ä¸“çº¿åç§°...">
                </div>
                <div class="filter-item" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button class="btn btn-primary" id="searchLineBtn">
                        <i class="fas fa-search"></i> æœç´¢
                    </button>
                    <button class="btn btn-primary" id="resetLineBtn" style="background: #FF9800;">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                    <button class="btn btn-primary" id="addLineBtn">
                        <i class="fas fa-plus"></i> æ·»åŠ ä¸“çº¿
                    </button>
                </div>
            </div>

            <!-- ä¸“çº¿åˆ—è¡¨è¡¨æ ¼ -->
            <div class="device-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ä¸“çº¿åç§°</th>
                            <th>è¿è¥å•†</th>
                            <th>å¸¦å®½</th>
                            <th>ç«¯ç‚¹A</th>
                            <th>ç«¯ç‚¹B</th>
                            <th>çŠ¶æ€</th>
                            <th>å»¶è¿Ÿ</th>
                            <th>ä¸¢åŒ…ç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="lineTableBody">
                        <tr>
                            <td colspan="10">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>åŠ è½½ä¸­...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼šæ ‡è®°é…ç½®ç®¡ç†æ•°æ®æ˜¯å¦éœ€è¦åˆ·æ–°
        let configDataNeedsRefresh = false;
        
        // é€‰é¡¹å¡åˆ‡æ¢
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ activeç±»
                this.classList.add('active');
                const tabName = this.dataset.tab;
                document.getElementById(tabName + '-content').classList.add('active');
                
                // å½“åˆ‡æ¢åˆ°é…ç½®ç®¡ç†é¡µé¢æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°æ•°æ®
                if (tabName === 'config') {
                    console.log('ğŸ”„ åˆ‡æ¢åˆ°é…ç½®ç®¡ç†é¡µé¢...');
                    setTimeout(() => {
                        if (typeof loadConfigList === 'function') {
                            // æ€»æ˜¯åˆ·æ–°é…ç½®ç®¡ç†æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°ä¿¡æ¯
                            loadConfigList();
                            configDataNeedsRefresh = false; // é‡ç½®åˆ·æ–°æ ‡è®°
                            console.log('âœ… é…ç½®ç®¡ç†æ•°æ®å·²åˆ·æ–°');
                        }
                    }, 100); // ç¨å¾®å»¶è¿Ÿç¡®ä¿é¡µé¢åˆ‡æ¢å®Œæˆ
                }
            });
        });

        // åŠ è½½è®¾å¤‡ç»Ÿè®¡æ•°æ®
        function loadDeviceStats() {
            console.log('å¼€å§‹åŠ è½½ç½‘ç»œè®¾å¤‡ç»Ÿè®¡æ•°æ®...');
            
            fetch('/api/asset/list?deviceManagementOnly=true')
                .then(response => response.json())
                .then(result => {
                    console.log('Asset APIå“åº”:', result);
                    
                    if (result.code === 200 && result.data) {
                        // è¿‡æ»¤ç½‘ç»œè®¾å¤‡ï¼ˆcategoryId: 8-12ï¼‰
                        const networkAssets = result.data.filter(asset => {
                            const categoryId = asset.categoryId;
                            return categoryId >= 8 && categoryId <= 12;
                        });
                        
                        console.log('ç½‘ç»œè®¾å¤‡æ•°é‡:', networkAssets.length);
                        
                        // ç»Ÿè®¡å„ç±»å‹è®¾å¤‡
                        const stats = {
                            switch: networkAssets.filter(asset => asset.categoryId === 8).length,    // äº¤æ¢æœº
                            router: networkAssets.filter(asset => asset.categoryId === 9).length,    // è·¯ç”±å™¨
                            firewall: networkAssets.filter(asset => asset.categoryId === 10).length, // é˜²ç«å¢™
                            ap: networkAssets.filter(asset => asset.categoryId === 11).length,       // æ— çº¿AP
                            gateway: networkAssets.filter(asset => asset.categoryId === 12).length   // ç½‘å…³
                        };
                        
                        console.log('è®¾å¤‡ç»Ÿè®¡:', stats);
                        
                        // æ›´æ–°é¡µé¢æ˜¾ç¤º
                        document.getElementById('switchCount').textContent = stats.switch;
                        document.getElementById('routerCount').textContent = stats.router;
                        document.getElementById('firewallCount').textContent = stats.firewall;
                        document.getElementById('apCount').textContent = stats.ap;
                        document.getElementById('gatewayCount').textContent = stats.gateway;
                        
                        console.log('âœ… ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ');
                    } else {
                        console.error('APIè¿”å›é”™è¯¯:', result);
                        // è®¾ç½®ä¸º0
                        document.getElementById('switchCount').textContent = 0;
                        document.getElementById('routerCount').textContent = 0;
                        document.getElementById('firewallCount').textContent = 0;
                        document.getElementById('apCount').textContent = 0;
                        document.getElementById('gatewayCount').textContent = 0;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    // è®¾ç½®ä¸º0
                    document.getElementById('switchCount').textContent = 0;
                    document.getElementById('routerCount').textContent = 0;
                    document.getElementById('firewallCount').textContent = 0;
                    document.getElementById('apCount').textContent = 0;
                    document.getElementById('gatewayCount').textContent = 0;
                });
        }

        // åˆ†é¡µå˜é‡
        let currentDevicePage = 1;
        const devicesPerPage = 5;
        let allDevices = [];

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        function loadDeviceList() {
            console.log('å¼€å§‹åŠ è½½ç½‘ç»œè®¾å¤‡åˆ—è¡¨...');
            
            fetch('/api/asset/list?deviceManagementOnly=true')
                .then(response => response.json())
                .then(result => {
                    console.log('è®¾å¤‡åˆ—è¡¨APIå“åº”:', result);
                    
                    if (result.code === 200 && result.data) {
                        // è¿‡æ»¤ç½‘ç»œè®¾å¤‡ï¼ˆcategoryId: 8-12ï¼‰
                        const networkAssets = result.data.filter(asset => {
                            const categoryId = asset.categoryId;
                            return categoryId >= 8 && categoryId <= 12;
                        });
                        
                        // æ˜ å°„ä¸ºè®¾å¤‡åˆ—è¡¨æ ¼å¼
                        allDevices = networkAssets.map(asset => ({
                            id: asset.id,
                            name: asset.deviceName || asset.assetName,
                            ip: asset.ipAddress || 'æœªè®¾ç½®',
                            type: getDeviceTypeFromCategory(asset.categoryId),
                            status: mapAssetStatusToDeviceStatus(asset.assetStatus),
                            groupName: getCategoryName(asset.categoryId),
                            groupId: asset.categoryId,
                            manufacturer: asset.manufacturer || 'æœªçŸ¥',
                            model: asset.model || 'æœªçŸ¥',
                            location: asset.location || 'æœªçŸ¥'
                        }));
                        
                        console.log('æ˜ å°„åçš„è®¾å¤‡åˆ—è¡¨:', allDevices);
                        
                        // åº”ç”¨è¿‡æ»¤å™¨
                        applyFilters();
                        
                        currentDevicePage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                        renderDeviceTable();
                        updatePagination();
                        
                        console.log('âœ… è®¾å¤‡åˆ—è¡¨åŠ è½½å®Œæˆ');
                    } else {
                        console.error('APIè¿”å›é”™è¯¯:', result);
                        allDevices = [];
                        renderDeviceTable();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                    allDevices = [];
                    document.getElementById('deviceTableBody').innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                                </div>
                            </td>
                        </tr>
                    `;
                });
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®categoryIdè·å–è®¾å¤‡ç±»å‹
        function getDeviceTypeFromCategory(categoryId) {
            const typeMap = {
                8: 'switch',     // äº¤æ¢æœº
                9: 'router',     // è·¯ç”±å™¨
                10: 'firewall',  // é˜²ç«å¢™
                11: 'ap',        // æ— çº¿AP
                12: 'gateway'    // ç½‘å…³
            };
            return typeMap[categoryId] || 'unknown';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ˜ å°„èµ„äº§çŠ¶æ€åˆ°è®¾å¤‡çŠ¶æ€
        function mapAssetStatusToDeviceStatus(assetStatus) {
            const statusMap = {
                'online': 'online',
                'offline': 'offline',
                'maintenance': 'maintenance'
            };
            return statusMap[assetStatus] || 'offline';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–åˆ†ç±»åç§°
        function getCategoryName(categoryId) {
            const categoryMap = {
                8: 'äº¤æ¢æœº',
                9: 'è·¯ç”±å™¨',
                10: 'é˜²ç«å¢™',
                11: 'æ— çº¿AP',
                12: 'ç½‘å…³'
            };
            return categoryMap[categoryId] || 'æœªçŸ¥';
        }
        
        // åº”ç”¨è¿‡æ»¤å™¨
        function applyFilters() {
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const keywordSearch = document.getElementById('keywordSearch');
            
            if (!typeFilter || !statusFilter || !keywordSearch) {
                console.warn('è¿‡æ»¤å™¨å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡è¿‡æ»¤');
                return;
            }
            
            const type = typeFilter.value;
            const status = statusFilter.value;
            const keyword = keywordSearch.value.toLowerCase();
            
            allDevices = allDevices.filter(device => {
                // ç±»å‹è¿‡æ»¤
                if (type && device.type !== type) return false;
                
                // çŠ¶æ€è¿‡æ»¤
                if (status && device.status !== status) return false;
                
                // å…³é”®è¯è¿‡æ»¤
                if (keyword && !device.name.toLowerCase().includes(keyword) && 
                    !device.ip.toLowerCase().includes(keyword)) return false;
                
                return true;
            });
        }

        // æ¸²æŸ“è®¾å¤‡è¡¨æ ¼ï¼ˆåˆ†é¡µï¼‰
        function renderDeviceTable() {
            const tbody = document.getElementById('deviceTableBody');
            
            if (allDevices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>æš‚æ— è®¾å¤‡æ•°æ®</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // è®¡ç®—å½“å‰é¡µçš„æ•°æ®
            const startIndex = (currentDevicePage - 1) * devicesPerPage;
            const endIndex = startIndex + devicesPerPage;
            const pageDevices = allDevices.slice(startIndex, endIndex);

            tbody.innerHTML = pageDevices.map(device => {
                const statusClass = device.status === 'online' ? 'status-online' : 
                                   device.status === 'offline' ? 'status-offline' : 'status-maintenance';
                const statusText = device.status === 'online' ? 'åœ¨çº¿' : 
                                  device.status === 'offline' ? 'ç¦»çº¿' : 'ç»´æŠ¤ä¸­';
                const typeText = getTypeText(device.type);

                return `
                    <tr>
                        <td>${device.id}</td>
                        <td>${device.name}</td>
                        <td>${device.ip}</td>
                        <td>${typeText}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${device.groupName || '-'}</td>
                        <td>
                            <button class="btn-detail" onclick="viewDeviceDetail(${device.id}, ${device.groupId})">
                                <i class="fas fa-eye"></i> è¯¦æƒ…
                            </button>
                            <button class="btn-detail" onclick="backupDeviceConfig(${device.id}, '${device.name}', '${device.ip}', '${typeText}')" 
                                    style="background: #4CAF50; border-color: #4CAF50; margin-left: 5px;">
                                <i class="fas fa-sync-alt"></i> æ›´æ–°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            const totalPages = Math.ceil(allDevices.length / devicesPerPage);
            
            document.getElementById('currentPage').textContent = currentDevicePage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalDevices').textContent = allDevices.length;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevPageBtn').disabled = currentDevicePage === 1;
            document.getElementById('nextPageBtn').disabled = currentDevicePage === totalPages || totalPages === 0;
        }

        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentDevicePage > 1) {
                currentDevicePage--;
                renderDeviceTable();
                updatePagination();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            const totalPages = Math.ceil(allDevices.length / devicesPerPage);
            if (currentDevicePage < totalPages) {
                currentDevicePage++;
                renderDeviceTable();
                updatePagination();
            }
        }

        // è·å–è®¾å¤‡ç±»å‹æ–‡æœ¬
        function getTypeText(type) {
            const typeMap = {
                'switch': 'äº¤æ¢æœº',
                'router': 'è·¯ç”±å™¨',
                'firewall': 'é˜²ç«å¢™',
                'ap': 'æ— çº¿AP',
                'gateway': 'ç½‘å…³'
            };
            return typeMap[type] || type;
        }

        // æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…
        function viewDeviceDetail(deviceId, groupId) {
            // è·³è½¬åˆ°è®¾å¤‡ç®¡ç†é¡µé¢ï¼ŒåŒæ—¶ä¼ é€’è®¾å¤‡IDå’Œåˆ†ç»„ID
            // groupId: å±•å¼€å¹¶é€‰ä¸­å¯¹åº”åˆ†ç»„ï¼Œæ˜¾ç¤ºè¯¥åˆ†ç»„çš„æ‰€æœ‰è®¾å¤‡
            // deviceId: é«˜äº®æ˜¾ç¤ºè¯¥è®¾å¤‡
            window.location.href = `è®¾å¤‡ç®¡ç†.html?groupId=${groupId}&deviceId=${deviceId}`;
        }

        // å¤‡ä»½è®¾å¤‡é…ç½®ï¼ˆæ›´æ–°æŒ‰é’®ï¼‰
        function backupDeviceConfig(deviceId, deviceName, deviceIp, deviceType) {
            console.log('å¤‡ä»½è®¾å¤‡é…ç½®:', deviceId, deviceName, deviceIp, deviceType);
            
            // æ˜¾ç¤ºç¾åŒ–çš„ç¡®è®¤å¼¹çª—
            showBackupConfirmModal(deviceId, deviceName, deviceIp, deviceType);
        }
        
        // æ‰§è¡Œå®é™…çš„å¤‡ä»½æ“ä½œ
        function executeDeviceBackup(deviceId, deviceName, deviceIp, deviceType) {
            console.log('ğŸš€ æ‰§è¡Œè®¾å¤‡å¤‡ä»½:', deviceName);
            
            // å…ˆæ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨ï¼ˆè°ƒç”¨Asset APIéªŒè¯ï¼‰
            fetch(`/api/asset/${deviceId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        throw new Error('è®¾å¤‡ä¸å­˜åœ¨');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(result => {
                    if (result.code === 200 && result.data) {
                        // è®¾å¤‡å­˜åœ¨ï¼Œæ‰§è¡Œå¤‡ä»½
                        simulateDeviceBackup(deviceId, deviceName, deviceIp, deviceType, result.data);
                    } else {
                        throw new Error(result.message || 'è®¾å¤‡éªŒè¯å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('å¤‡ä»½å¤±è´¥:', error);
                    alert(`å¤‡ä»½å¤±è´¥: ${error.message}`);
                });
        }
        
        // æ˜¾ç¤ºç¾åŒ–çš„å¤‡ä»½ç¡®è®¤å¼¹çª—
        function showBackupConfirmModal(deviceId, deviceName, deviceIp, deviceType) {
            const modalHTML = `
                <div id="backupConfirmModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    backdrop-filter: blur(5px);
                ">
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 20px;
                        width: 90%;
                        max-width: 480px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        overflow: hidden;
                        animation: modalSlideIn 0.3s ease-out;
                    ">
                        <!-- å¤´éƒ¨ -->
                        <div style="
                            color: #fff;
                            padding: 30px 30px 20px 30px;
                            text-align: center;
                        ">
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 50%;
                                margin: 0 auto 20px auto;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 36px;
                            ">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 600;">
                                é…ç½®å¤‡ä»½ç¡®è®¤
                            </h2>
                            <p style="margin: 0; opacity: 0.9; font-size: 16px;">
                                å³å°†ä¸ºä»¥ä¸‹è®¾å¤‡åˆ›å»ºé…ç½®å¤‡ä»½
                            </p>
                        </div>

                        <!-- è®¾å¤‡ä¿¡æ¯å¡ç‰‡ -->
                        <div style="
                            background: #fff;
                            margin: 0 20px 20px 20px;
                            border-radius: 15px;
                            padding: 25px;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        ">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="color: #667eea; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                        <i class="fas fa-server" style="margin-right: 5px;"></i>è®¾å¤‡åç§°
                                    </div>
                                    <div style="color: #333; font-size: 18px; font-weight: 600;">${deviceName}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #667eea; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                        <i class="fas fa-network-wired" style="margin-right: 5px;"></i>IPåœ°å€
                                    </div>
                                    <div style="color: #333; font-size: 18px; font-weight: 600;">${deviceIp}</div>
                                </div>
                            </div>
                            
                            <div style="
                                margin-top: 20px;
                                padding-top: 20px;
                                border-top: 1px solid #eee;
                                text-align: center;
                            ">
                                <div style="color: #667eea; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
                                    <i class="fas fa-tag" style="margin-right: 5px;"></i>è®¾å¤‡ç±»å‹
                                </div>
                                <div style="
                                    display: inline-block;
                                    background: linear-gradient(135deg, #667eea, #764ba2);
                                    color: #fff;
                                    padding: 8px 20px;
                                    border-radius: 20px;
                                    font-size: 16px;
                                    font-weight: 500;
                                ">${deviceType}</div>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="
                            padding: 0 30px 30px 30px;
                            display: flex;
                            gap: 15px;
                        ">
                            <button onclick="closeBackupConfirmModal()" style="
                                flex: 1;
                                padding: 15px;
                                background: rgba(255,255,255,0.2);
                                color: #fff;
                                border: 2px solid rgba(255,255,255,0.3);
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-times" style="margin-right: 8px;"></i>å–æ¶ˆ
                            </button>
                            <button onclick="confirmBackup(${deviceId}, '${deviceName}', '${deviceIp}', '${deviceType}')" style="
                                flex: 2;
                                padding: 15px;
                                background: #fff;
                                color: #667eea;
                                border: none;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: 600;
                                transition: all 0.3s ease;
                                box-shadow: 0 5px 15px rgba(255,255,255,0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255,255,255,0.4)'" 
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(255,255,255,0.3)'">
                                <i class="fas fa-check" style="margin-right: 8px;"></i>ç¡®è®¤å¤‡ä»½
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes modalSlideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-50px) scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                    
                    @keyframes modalSlideOut {
                        from {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                        to {
                            opacity: 0;
                            transform: translateY(-50px) scale(0.9);
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // å…³é—­å¤‡ä»½ç¡®è®¤å¼¹çª—
        function closeBackupConfirmModal() {
            const modal = document.getElementById('backupConfirmModal');
            if (modal) {
                modal.style.animation = 'modalSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // ç¡®è®¤å¤‡ä»½
        function confirmBackup(deviceId, deviceName, deviceIp, deviceType) {
            closeBackupConfirmModal();
            executeDeviceBackup(deviceId, deviceName, deviceIp, deviceType);
        }
        
        // è®¾å¤‡é…ç½®å¤‡ä»½ - è°ƒç”¨æ•°æ®åº“API
        function simulateDeviceBackup(deviceId, deviceName, deviceIp, deviceType, deviceData) {
            console.log(`ğŸš€ å¼€å§‹å¤‡ä»½è®¾å¤‡: ${deviceName} (ID: ${deviceId})`);
            
            // è°ƒç”¨åç«¯APIè¿›è¡Œå¤‡ä»½
            fetch(`/api/config-backup/backup/${deviceId}?operator=admin`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('ğŸ“¡ å¤‡ä»½APIå“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('ğŸ“Š å¤‡ä»½APIç»“æœ:', result);
                
                if (result.success) {
                    // æ˜¾ç¤ºç¾åŒ–çš„æˆåŠŸæç¤º
                    showBackupSuccessNotification(deviceName, result.version, result.backupTime);
                    
                    // æ ‡è®°é…ç½®ç®¡ç†æ•°æ®éœ€è¦åˆ·æ–°
                    configDataNeedsRefresh = true;
                    
                    // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨é…ç½®ç®¡ç†æ ‡ç­¾é¡µ
                    const activeTab = document.querySelector('.tab-item.active');
                    if (activeTab && activeTab.dataset.tab === 'config') {
                        // å¦‚æœå½“å‰åœ¨é…ç½®ç®¡ç†é¡µé¢ï¼Œç«‹å³åˆ·æ–°æ•°æ®
                        console.log('ğŸ“‹ å½“å‰åœ¨é…ç½®ç®¡ç†é¡µé¢ï¼Œç«‹å³åˆ·æ–°æ•°æ®...');
                        setTimeout(() => {
                            if (typeof loadConfigList === 'function') {
                                loadConfigList();
                                configDataNeedsRefresh = false;
                                console.log('âœ… é…ç½®ç®¡ç†æ•°æ®å·²åˆ·æ–°');
                            }
                        }, 800); // ç¨å¾®å»¶è¿Ÿç¡®ä¿åç«¯æ•°æ®å·²ä¿å­˜
                    } else {
                        // å¦‚æœä¸åœ¨é…ç½®ç®¡ç†é¡µé¢ï¼Œåªè®¾ç½®åˆ·æ–°æ ‡è®°ï¼Œç­‰åˆ‡æ¢æ—¶å†åˆ·æ–°
                        console.log('ğŸ“‹ ä¸åœ¨é…ç½®ç®¡ç†é¡µé¢ï¼Œå·²æ ‡è®°éœ€è¦åˆ·æ–°');
                    }
                    
                    console.log('âœ… è®¾å¤‡é…ç½®å¤‡ä»½å®Œæˆ:', result);
                } else {
                    console.error('âŒ å¤‡ä»½å¤±è´¥è¯¦æƒ…:', result);
                    showBackupErrorNotification(result.message || 'æœªçŸ¥é”™è¯¯');
                }
            })
            .catch(error => {
                console.error('âŒ å¤‡ä»½APIè°ƒç”¨å¤±è´¥:', error);
                showBackupErrorNotification(error.message);
            });
        }
        
        // æ˜¾ç¤ºå¤‡ä»½æˆåŠŸé€šçŸ¥
        function showBackupSuccessNotification(deviceName, version, backupTime) {
            const notificationHTML = `
                <div id="successNotification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #4CAF50, #45a049);
                    color: white;
                    padding: 20px 25px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
                    z-index: 10001;
                    min-width: 350px;
                    animation: slideInRight 0.5s ease-out;
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            font-size: 18px;
                        ">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                                å¤‡ä»½æˆåŠŸï¼
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                è®¾å¤‡ "${deviceName}" é…ç½®å·²å¤‡ä»½ï¼Œæ•°æ®å·²è‡ªåŠ¨æ›´æ–°
                            </div>
                        </div>
                    </div>
                    <div style="
                        background: rgba(255,255,255,0.1);
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 13px;
                    ">
                        <div>ğŸ“‹ ç‰ˆæœ¬å·: ${version}</div>
                        <div style="margin-top: 5px;">â° å¤‡ä»½æ—¶é—´: ${backupTime}</div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            opacity: 1;
                            transform: translateX(0);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHTML);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                const notification = document.getElementById('successNotification');
                if (notification) {
                    notification.style.animation = 'slideOutRight 0.5s ease-in forwards';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }
            }, 3000);
        }
        
        // æ˜¾ç¤ºå¤‡ä»½å¤±è´¥é€šçŸ¥
        function showBackupErrorNotification(message) {
            const notificationHTML = `
                <div id="errorNotification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #F44336, #d32f2f);
                    color: white;
                    padding: 20px 25px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(244, 67, 54, 0.3);
                    z-index: 10001;
                    min-width: 350px;
                    animation: slideInRight 0.5s ease-out;
                ">
                    <div style="display: flex; align-items: center;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            font-size: 18px;
                        ">
                            <i class="fas fa-times"></i>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                                å¤‡ä»½å¤±è´¥
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                ${message}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHTML);
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                const notification = document.getElementById('errorNotification');
                if (notification) {
                    notification.style.animation = 'slideOutRight 0.5s ease-in forwards';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }
            }, 5000);
        }
        
        // è·å–è®¾å¤‡çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
        function getNextDeviceVersion(deviceId) {
            try {
                // è·å–è¯¥è®¾å¤‡çš„æ‰€æœ‰å¤‡ä»½è®°å½•
                const allBackups = JSON.parse(localStorage.getItem('deviceBackups') || '[]');
                const deviceBackups = allBackups.filter(backup => backup.deviceId == deviceId);
                
                if (deviceBackups.length === 0) {
                    // ç¬¬ä¸€æ¬¡å¤‡ä»½ï¼Œä»v1.0å¼€å§‹
                    return 'v1.0';
                }
                
                // æ‰¾åˆ°æœ€æ–°çš„ç‰ˆæœ¬å·
                let maxVersion = 0;
                deviceBackups.forEach(backup => {
                    const versionMatch = backup.version.match(/^v(\d+)\.(\d+)$/);
                    if (versionMatch) {
                        const major = parseInt(versionMatch[1]);
                        const minor = parseInt(versionMatch[2]);
                        const currentVersion = major + minor / 10;
                        if (currentVersion > maxVersion) {
                            maxVersion = currentVersion;
                        }
                    }
                });
                
                // ç‰ˆæœ¬å·é€’å¢0.1
                const nextVersion = maxVersion + 0.1;
                const major = Math.floor(nextVersion);
                const minor = Math.round((nextVersion - major) * 10);
                
                return `v${major}.${minor}`;
            } catch (error) {
                console.error('è·å–ç‰ˆæœ¬å·å¤±è´¥:', error);
                return 'v1.0';
            }
        }
        
        // ç”ŸæˆMACåœ°å€
        function generateMacAddress() {
            const chars = '0123456789ABCDEF';
            let mac = '';
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 2 === 0) mac += ':';
                mac += chars[Math.floor(Math.random() * 16)];
            }
            return mac;
        }
        
        // æ ¹æ®è®¾å¤‡ç±»å‹ç”Ÿæˆç«¯å£ä¿¡æ¯
        function generatePortInfo(deviceType) {
            const portConfigs = {
                'äº¤æ¢æœº': [
                    { port: 'GE1/0/1', status: 'up', speed: '1000M', duplex: 'full' },
                    { port: 'GE1/0/2', status: 'up', speed: '1000M', duplex: 'full' },
                    { port: 'GE1/0/3', status: 'down', speed: '-', duplex: '-' },
                    { port: 'GE1/0/4', status: 'up', speed: '1000M', duplex: 'full' }
                ],
                'è·¯ç”±å™¨': [
                    { port: 'GE0/0/0', status: 'up', speed: '1000M', duplex: 'full', ip: '192.168.1.1' },
                    { port: 'GE0/0/1', status: 'up', speed: '1000M', duplex: 'full', ip: '10.0.0.1' },
                    { port: 'Serial0/0/0', status: 'up', speed: '2M', duplex: 'full' }
                ],
                'é˜²ç«å¢™': [
                    { port: 'inside', status: 'up', security: 'high', ip: '192.168.1.254' },
                    { port: 'outside', status: 'up', security: 'low', ip: '112.23.65.1' },
                    { port: 'dmz', status: 'up', security: 'medium', ip: '172.16.1.1' }
                ],
                'æ— çº¿AP': [
                    { ssid: 'Corporate-WiFi', status: 'up', clients: Math.floor(Math.random() * 20) },
                    { ssid: 'Guest-WiFi', status: 'up', clients: Math.floor(Math.random() * 10) }
                ],
                'ç½‘å…³': [
                    { tunnel: 'VPN-Tunnel-1', status: 'up', remote: '203.45.67.89' },
                    { tunnel: 'VPN-Tunnel-2', status: 'down', remote: '198.51.100.1' }
                ]
            };
            
            return portConfigs[deviceType] || [{ port: 'eth0', status: 'up', speed: '1000M' }];
        }
        
        // ç”Ÿæˆå›ºä»¶ç‰ˆæœ¬
        function generateFirmwareVersion(deviceType) {
            const firmwareMap = {
                'äº¤æ¢æœº': `SW-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                'è·¯ç”±å™¨': `RT-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                'é˜²ç«å¢™': `FW-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                'æ— çº¿AP': `AP-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`,
                'ç½‘å…³': `GW-${Math.floor(Math.random() * 9) + 1}.${Math.floor(Math.random() * 9)}.${Math.floor(Math.random() * 99)}`
            };
            
            return firmwareMap[deviceType] || `DEV-1.0.0`;
        }
        
        // ç”Ÿæˆé…ç½®æ ¡éªŒå’Œ
        function generateChecksum() {
            const chars = '0123456789abcdef';
            let checksum = '';
            for (let i = 0; i < 32; i++) {
                checksum += chars[Math.floor(Math.random() * 16)];
            }
            return checksum;
        }
        
        // è®¡ç®—è®¾å¤‡è¿è¡Œæ—¶é—´
        function calculateUptime(createTime) {
            if (!createTime) return 'æœªçŸ¥';
            
            try {
                const created = new Date(createTime);
                const now = new Date();
                const diffMs = now.getTime() - created.getTime();
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                if (diffDays > 0) {
                    return `${diffDays}å¤©${diffHours}å°æ—¶`;
                } else if (diffHours > 0) {
                    return `${diffHours}å°æ—¶`;
                } else {
                    return 'ä¸è¶³1å°æ—¶';
                }
            } catch (error) {
                return 'æœªçŸ¥';
            }
        }
        
        // ä¿å­˜å¤‡ä»½è®°å½•
        function saveBackupRecord(backupResult) {
            try {
                // è·å–ç°æœ‰å¤‡ä»½è®°å½•
                const existingBackups = JSON.parse(localStorage.getItem('deviceBackups') || '[]');
                
                // æ·»åŠ æ–°çš„å¤‡ä»½è®°å½•ï¼ˆåŒ…å«å®Œæ•´è®¾å¤‡å¿«ç…§ï¼‰
                const newBackup = {
                    id: Date.now(),
                    deviceId: backupResult.deviceSnapshot.deviceId,
                    deviceName: backupResult.deviceSnapshot.deviceName,
                    deviceIp: backupResult.deviceSnapshot.deviceIp,
                    deviceType: backupResult.deviceSnapshot.deviceType,
                    version: backupResult.version,
                    backupTime: backupResult.backupTime,
                    status: 'success',
                    operator: backupResult.deviceSnapshot.operator,
                    createTime: backupResult.deviceSnapshot.backupTimestamp,
                    backupSize: backupResult.deviceSnapshot.backupSize,
                    
                    // ä¿å­˜å®Œæ•´çš„è®¾å¤‡å¿«ç…§ä¿¡æ¯
                    deviceSnapshot: backupResult.deviceSnapshot
                };
                
                existingBackups.unshift(newBackup); // æ·»åŠ åˆ°å¼€å¤´
                
                // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•ï¼ˆå¢åŠ å­˜å‚¨é‡ä»¥æ”¯æŒç‰ˆæœ¬å†å²ï¼‰
                if (existingBackups.length > 100) {
                    existingBackups.splice(100);
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('deviceBackups', JSON.stringify(existingBackups));
                
                console.log('âœ… å¤‡ä»½è®°å½•å·²ä¿å­˜:', newBackup);
                console.log('ğŸ“¸ è®¾å¤‡å¿«ç…§å·²ä¿å­˜:', backupResult.deviceSnapshot);
                
                // åŒæ—¶ä¿å­˜ç‰ˆæœ¬å†å²è®°å½•ï¼ˆæŒ‰è®¾å¤‡åˆ†ç»„ï¼‰
                saveDeviceVersionHistory(backupResult.deviceSnapshot.deviceId, newBackup);
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¤‡ä»½è®°å½•å¤±è´¥:', error);
            }
        }
        
        // ä¿å­˜è®¾å¤‡ç‰ˆæœ¬å†å²è®°å½•
        function saveDeviceVersionHistory(deviceId, backupRecord) {
            try {
                // è·å–è®¾å¤‡ç‰ˆæœ¬å†å²
                const versionHistory = JSON.parse(localStorage.getItem('deviceVersionHistory') || '{}');
                
                if (!versionHistory[deviceId]) {
                    versionHistory[deviceId] = {
                        deviceId: deviceId,
                        deviceName: backupRecord.deviceName,
                        deviceType: backupRecord.deviceType,
                        versions: []
                    };
                }
                
                // æ·»åŠ æ–°ç‰ˆæœ¬è®°å½•
                const versionRecord = {
                    version: backupRecord.version,
                    backupTime: backupRecord.backupTime,
                    backupTimestamp: backupRecord.createTime,
                    operator: backupRecord.operator,
                    backupSize: backupRecord.backupSize,
                    deviceSnapshot: backupRecord.deviceSnapshot,
                    
                    // ç‰ˆæœ¬å˜æ›´æ‘˜è¦
                    changes: generateVersionChanges(deviceId, backupRecord.deviceSnapshot)
                };
                
                versionHistory[deviceId].versions.unshift(versionRecord);
                
                // æ¯ä¸ªè®¾å¤‡æœ€å¤šä¿ç•™20ä¸ªç‰ˆæœ¬
                if (versionHistory[deviceId].versions.length > 20) {
                    versionHistory[deviceId].versions.splice(20);
                }
                
                // ä¿å­˜ç‰ˆæœ¬å†å²
                localStorage.setItem('deviceVersionHistory', JSON.stringify(versionHistory));
                
                console.log(`ğŸ“š è®¾å¤‡${deviceId}ç‰ˆæœ¬å†å²å·²æ›´æ–°:`, versionRecord);
            } catch (error) {
                console.error('ä¿å­˜ç‰ˆæœ¬å†å²å¤±è´¥:', error);
            }
        }
        
        // ç”Ÿæˆç‰ˆæœ¬å˜æ›´æ‘˜è¦
        function generateVersionChanges(deviceId, currentSnapshot) {
            try {
                const versionHistory = JSON.parse(localStorage.getItem('deviceVersionHistory') || '{}');
                const deviceHistory = versionHistory[deviceId];
                
                if (!deviceHistory || deviceHistory.versions.length === 0) {
                    return ['é¦–æ¬¡é…ç½®å¤‡ä»½'];
                }
                
                const lastSnapshot = deviceHistory.versions[0].deviceSnapshot;
                const changes = [];
                
                // æ¯”è¾ƒå…³é”®é…ç½®é¡¹
                if (currentSnapshot.firmwareVersion !== lastSnapshot.firmwareVersion) {
                    changes.push(`å›ºä»¶ç‰ˆæœ¬: ${lastSnapshot.firmwareVersion} â†’ ${currentSnapshot.firmwareVersion}`);
                }
                
                if (currentSnapshot.configChecksum !== lastSnapshot.configChecksum) {
                    changes.push('é…ç½®æ–‡ä»¶å·²æ›´æ–°');
                }
                
                if (currentSnapshot.status !== lastSnapshot.status) {
                    changes.push(`è®¾å¤‡çŠ¶æ€: ${lastSnapshot.status} â†’ ${currentSnapshot.status}`);
                }
                
                // æ¯”è¾ƒç«¯å£çŠ¶æ€
                const portChanges = comparePortStatus(lastSnapshot.ports, currentSnapshot.ports);
                if (portChanges.length > 0) {
                    changes.push(...portChanges);
                }
                
                return changes.length > 0 ? changes : ['é…ç½®å®šæœŸå¤‡ä»½'];
            } catch (error) {
                console.error('ç”Ÿæˆç‰ˆæœ¬å˜æ›´å¤±è´¥:', error);
                return ['é…ç½®å¤‡ä»½'];
            }
        }
        
        // æ¯”è¾ƒç«¯å£çŠ¶æ€å˜åŒ–
        function comparePortStatus(oldPorts, newPorts) {
            const changes = [];
            
            try {
                // ç®€å•çš„ç«¯å£çŠ¶æ€æ¯”è¾ƒ
                if (oldPorts && newPorts && oldPorts.length === newPorts.length) {
                    for (let i = 0; i < oldPorts.length; i++) {
                        const oldPort = oldPorts[i];
                        const newPort = newPorts[i];
                        
                        if (oldPort.status !== newPort.status) {
                            const portName = oldPort.port || oldPort.ssid || oldPort.tunnel || `ç«¯å£${i+1}`;
                            changes.push(`${portName}: ${oldPort.status} â†’ ${newPort.status}`);
                        }
                    }
                }
            } catch (error) {
                console.error('æ¯”è¾ƒç«¯å£çŠ¶æ€å¤±è´¥:', error);
            }
            
            return changes;
        }

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('searchBtn').addEventListener('click', loadDeviceList);
        
        // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('resetBtn').addEventListener('click', function() {
            // æ¸…ç©ºæ‰€æœ‰ç­›é€‰æ¡ä»¶
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('keywordSearch').value = '';
            // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
            loadDeviceList();
        });

        // å›è½¦æœç´¢
        document.getElementById('keywordSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadDeviceList();
            }
        });

        // è®¾å¤‡åˆ—è¡¨åˆ†é¡µæŒ‰é’®äº‹ä»¶
        document.getElementById('prevPageBtn').addEventListener('click', prevPage);
        document.getElementById('nextPageBtn').addEventListener('click', nextPage);

        // é…ç½®ç®¡ç†åˆ†é¡µæŒ‰é’®äº‹ä»¶
        document.getElementById('prevConfigPageBtn').addEventListener('click', prevConfigPage);
        document.getElementById('nextConfigPageBtn').addEventListener('click', nextConfigPage);

        // é…ç½®ç®¡ç†æœç´¢æŒ‰é’®äº‹ä»¶
        document.getElementById('searchConfigBtn').addEventListener('click', loadConfigList);
        
        // é…ç½®ç®¡ç†é‡ç½®æŒ‰é’®äº‹ä»¶
        document.getElementById('resetConfigBtn').addEventListener('click', resetConfigSearch);
        
        // é…ç½®ç®¡ç†å…³é”®å­—è¾“å…¥æ¡†å›è½¦æœç´¢
        document.getElementById('configKeywordSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadConfigList();
            }
        });
        
        // æœç´¢é…ç½®åˆ—è¡¨
        function searchConfigList() {
            // æŸ¥æ‰¾é…ç½®ç®¡ç†é¡µé¢çš„æœç´¢æ¡†
            let keywordInput = null;
            const allInputs = document.querySelectorAll('input');
            for (let input of allInputs) {
                if (input.placeholder && input.placeholder.includes('æœç´¢è®¾å¤‡åç§°')) {
                    keywordInput = input;
                    break;
                }
            }
            
            // æŸ¥æ‰¾æ—¶é—´ç­›é€‰ä¸‹æ‹‰æ¡†
            let timeSelect = null;
            const allSelects = document.querySelectorAll('select');
            for (let select of allSelects) {
                const options = Array.from(select.options).map(opt => opt.textContent);
                if (options.includes('å…¨éƒ¨æ—¶é—´')) {
                    timeSelect = select;
                    break;
                }
            }
            
            const keyword = keywordInput ? keywordInput.value.trim() : '';
            const timeFilter = timeSelect ? timeSelect.options[timeSelect.selectedIndex].textContent : '';
            
            console.log('ğŸ” æœç´¢é…ç½®åˆ—è¡¨:', { keyword, timeFilter, keywordInput: !!keywordInput, timeSelect: !!timeSelect });
            loadConfigList(keyword, timeFilter);
        }
        
        // é‡ç½®æœç´¢æ¡ä»¶
        function resetConfigSearch() {
            // æŸ¥æ‰¾é…ç½®ç®¡ç†é¡µé¢çš„æœç´¢æ¡†
            let keywordInput = null;
            const allInputs = document.querySelectorAll('input');
            for (let input of allInputs) {
                if (input.placeholder && input.placeholder.includes('æœç´¢è®¾å¤‡åç§°')) {
                    keywordInput = input;
                    break;
                }
            }
            
            // æŸ¥æ‰¾æ—¶é—´ç­›é€‰ä¸‹æ‹‰æ¡†
            let timeSelect = null;
            const allSelects = document.querySelectorAll('select');
            for (let select of allSelects) {
                const options = Array.from(select.options).map(opt => opt.textContent);
                if (options.includes('å…¨éƒ¨æ—¶é—´')) {
                    timeSelect = select;
                    break;
                }
            }
            
            if (keywordInput) keywordInput.value = '';
            if (timeSelect) timeSelect.selectedIndex = 0;
            
            console.log('ğŸ”„ é‡ç½®æœç´¢æ¡ä»¶');
            loadConfigList();
        }
        
        // ç»‘å®šæœç´¢å’Œé‡ç½®æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', function(e) {
            if (e.target.closest('button') && e.target.textContent.includes('æœç´¢')) {
                e.preventDefault();
                searchConfigList();
            }
            if (e.target.closest('button') && e.target.textContent.includes('é‡ç½®')) {
                e.preventDefault();
                resetConfigSearch();
            }
        });
        
        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.placeholder && e.target.placeholder.includes('æœç´¢è®¾å¤‡åç§°')) {
                e.preventDefault();
                searchConfigList();
            }
        });

        // åŠ è½½é…ç½®ç®¡ç†ç»Ÿè®¡æ•°æ®ï¼ˆå·²åˆ é™¤å›¾è¡¨åŠŸèƒ½ï¼‰
        function loadConfigStats() {
            // é…ç½®ç»Ÿè®¡åŠŸèƒ½å·²ç§»é™¤
            console.log('é…ç½®ç»Ÿè®¡å›¾è¡¨åŠŸèƒ½å·²åˆ é™¤');
        }

        // é…ç½®ç®¡ç†åˆ†é¡µå˜é‡
        let currentConfigPage = 1;
        const configsPerPage = 5;
        let allConfigs = [];

        // åŠ è½½é…ç½®ç®¡ç†åˆ—è¡¨ - ä»æ•°æ®åº“è¯»å–
        function loadConfigList(keyword = '', timeFilter = '') {
            console.log('ğŸ”„ ä»æ•°æ®åº“åŠ è½½é…ç½®ç®¡ç†åˆ—è¡¨...', { keyword, timeFilter });
            
            // è·å–token
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('âŒ æœªæ‰¾åˆ°è®¤è¯token');
                allConfigs = [];
                currentConfigPage = 1;
                renderConfigTable();
                updateConfigPagination();
                return;
            }
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = new URLSearchParams();
            if (keyword) {
                params.append('keyword', keyword);
            }
            if (timeFilter) {
                params.append('timeFilter', timeFilter);
            }
            
            const url = `/api/network/config/devices${params.toString() ? '?' + params.toString() : ''}`;
            
            // è°ƒç”¨ç½‘ç»œé…ç½®è®¾å¤‡API
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('ğŸ“¡ é…ç½®åˆ—è¡¨APIå“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('ğŸ“Š é…ç½®åˆ—è¡¨APIç»“æœ:', result);
                
                if (result.success && result.data) {
                    // è½¬æ¢æ•°æ®æ ¼å¼ä¸ºé…ç½®ç®¡ç†é¡µé¢éœ€è¦çš„æ ¼å¼
                    allConfigs = result.data.map(device => ({
                        id: device.deviceId,
                        deviceName: device.deviceName,
                        deviceIp: device.deviceIp || 'æœªé…ç½®',
                        deviceType: getDeviceTypeFromModel(device.model),
                        manufacturer: device.manufacturer,
                        model: device.model,
                        version: device.version || 'æœªå¤‡ä»½',
                        lastBackupTime: device.lastBackupTime || 'ä»æœªå¤‡ä»½',
                        backupStatus: device.backupStatus === 'success' ? 'success' : 
                                     device.backupStatus === 'no_backup' ? 'pending' : 'failed',
                        backupSize: device.backupSize || '-',
                        location: device.location,
                        status: device.status,
                        hasBackup: device.hasBackup
                    }));
                    
                    console.log('ğŸ“‹ ä»æ•°æ®åº“è·å–çš„é…ç½®åˆ—è¡¨:', allConfigs.length, 'æ¡è®°å½•');
                    
                    currentConfigPage = 1;
                    renderConfigTable();
                    updateConfigPagination();
                    
                    console.log('âœ… é…ç½®åˆ—è¡¨åŠ è½½å®Œæˆ');
                } else {
                    console.error('âŒ è·å–é…ç½®åˆ—è¡¨å¤±è´¥:', result.message);
                    allConfigs = [];
                    currentConfigPage = 1;
                    renderConfigTable();
                    updateConfigPagination();
                }
            })
            .catch(error => {
                console.error('âŒ é…ç½®åˆ—è¡¨APIè°ƒç”¨å¤±è´¥:', error);
                allConfigs = [];
                currentConfigPage = 1;
                renderConfigTable();
                updateConfigPagination();
            });
        }
        
        // æ ¹æ®è®¾å¤‡å‹å·åˆ¤æ–­è®¾å¤‡ç±»å‹
        function getDeviceTypeFromModel(model) {
            if (!model) return 'unknown';
            
            const modelLower = model.toLowerCase();
            if (modelLower.includes('switch') || modelLower.includes('catalyst')) {
                return 'switch';
            } else if (modelLower.includes('router') || modelLower.includes('isr')) {
                return 'router';
            } else if (modelLower.includes('firewall') || modelLower.includes('fortigate')) {
                return 'firewall';
            } else if (modelLower.includes('ap') || modelLower.includes('wifi')) {
                return 'ap';
            } else if (modelLower.includes('gateway') || modelLower.includes('big-ip')) {
                return 'gateway';
            } else {
                return 'unknown';
            }
        }
        
        // ä¿®å¤è®¾å¤‡åç§°ç¼–ç é—®é¢˜
        function fixDeviceName(deviceName, assetCode) {
            // æ ¹æ®èµ„äº§ç¼–ç æ˜ å°„æ­£ç¡®çš„è®¾å¤‡åç§°
            const deviceNameMap = {
                'NET-000001': 'æ ¸å¿ƒäº¤æ¢æœº',
                'NET-000002': 'ç›‘æ§ä¸“ç”¨äº¤æ¢æœº', 
                'NET-000003': 'è¾¹ç•Œè·¯ç”±å™¨',
                'NET-000004': 'å®‰å…¨é˜²ç«å¢™',
                'NET-000005': 'æ— çº¿AP',
                'NET-000006': 'VPNç½‘å…³',
                'NET-000007': 'å¤‡ç”¨äº¤æ¢æœº'
            };
            
            // å¦‚æœæœ‰æ˜ å°„ï¼Œä½¿ç”¨æ˜ å°„çš„åç§°ï¼Œå¦åˆ™ä½¿ç”¨åŸåç§°
            return deviceNameMap[assetCode] || deviceName || 'æœªçŸ¥è®¾å¤‡';
        }
        
        // æ ¼å¼åŒ–å¤‡ä»½æ—¶é—´
        function formatBackupTime(timeStr) {
            if (!timeStr || timeStr === 'ä»æœªå¤‡ä»½') {
                return 'ä»æœªå¤‡ä»½';
            }
            
            try {
                const date = new Date(timeStr);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return timeStr;
            }
        }
        
        // è·å–æ¯ä¸ªè®¾å¤‡çš„æœ€æ–°å¤‡ä»½è®°å½•
        function getLatestDeviceBackups(allBackups) {
            const deviceMap = new Map();
            
            // éå†æ‰€æœ‰å¤‡ä»½è®°å½•ï¼Œä¸ºæ¯ä¸ªè®¾å¤‡ä¿ç•™æœ€æ–°çš„è®°å½•
            allBackups.forEach(backup => {
                const deviceId = backup.deviceId;
                
                if (!deviceMap.has(deviceId)) {
                    deviceMap.set(deviceId, backup);
                } else {
                    const existingBackup = deviceMap.get(deviceId);
                    
                    // æ¯”è¾ƒç‰ˆæœ¬å·ï¼Œä¿ç•™æ›´æ–°çš„ç‰ˆæœ¬
                    if (compareVersions(backup.version, existingBackup.version) > 0) {
                        deviceMap.set(deviceId, backup);
                    } else if (compareVersions(backup.version, existingBackup.version) === 0) {
                        // ç‰ˆæœ¬å·ç›¸åŒæ—¶ï¼Œæ¯”è¾ƒæ—¶é—´æˆ³
                        const backupTime = new Date(backup.createTime);
                        const existingTime = new Date(existingBackup.createTime);
                        if (backupTime > existingTime) {
                            deviceMap.set(deviceId, backup);
                        }
                    }
                }
            });
            
            return Array.from(deviceMap.values());
        }
        
        // æ¯”è¾ƒç‰ˆæœ¬å·å¤§å°
        function compareVersions(version1, version2) {
            // è§£æç‰ˆæœ¬å· (å¦‚ v1.2)
            const parseVersion = (version) => {
                const match = version.match(/^v(\d+)\.(\d+)$/);
                if (match) {
                    return parseFloat(match[1] + '.' + match[2]);
                }
                return 0;
            };
            
            const v1 = parseVersion(version1);
            const v2 = parseVersion(version2);
            
            if (v1 > v2) return 1;
            if (v1 < v2) return -1;
            return 0;
        }
        
        // è·å–è®¾å¤‡çš„ç‰ˆæœ¬æ•°é‡
        function getDeviceVersionCount(deviceId, allBackups) {
            return allBackups.filter(backup => backup.deviceId == deviceId).length;
        }
        
        // é‡ç½®æœç´¢æ¡ä»¶
        function resetConfigSearch() {
            document.getElementById('configKeywordSearch').value = '';
            document.getElementById('configTimeFilter').value = '';
            loadConfigList();
        }

        // æ¸²æŸ“é…ç½®è¡¨æ ¼ï¼ˆåˆ†é¡µï¼‰
        function renderConfigTable() {
            const tbody = document.getElementById('configTableBody');
            
            if (allConfigs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>æš‚æ— é…ç½®æ•°æ®</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // è®¡ç®—å½“å‰é¡µçš„æ•°æ®
            const startIndex = (currentConfigPage - 1) * configsPerPage;
            const endIndex = startIndex + configsPerPage;
            const pageConfigs = allConfigs.slice(startIndex, endIndex);

            tbody.innerHTML = pageConfigs.map(config => {
                const backupStatusClass = config.backupStatus === 'success' ? 'status-online' : 'status-offline';
                const backupStatusText = config.backupStatus === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';

                return `
                    <tr>
                        <td>${config.deviceName}</td>
                        <td>${config.deviceIp}</td>
                        <td>${config.version || '-'}</td>
                        <td>${formatBackupTime(config.lastBackupTime)}</td>
                        <td><span class="status-badge ${backupStatusClass}">${backupStatusText}</span></td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn-detail" onclick="viewConfigHistory(${config.id}, '${config.deviceName}')">
                                    <i class="fas fa-history"></i> ç‰ˆæœ¬å†å²
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°é…ç½®ç®¡ç†åˆ†é¡µæ§ä»¶
        function updateConfigPagination() {
            const totalPages = Math.ceil(allConfigs.length / configsPerPage);
            
            document.getElementById('currentConfigPage').textContent = currentConfigPage;
            document.getElementById('totalConfigPages').textContent = totalPages;
            document.getElementById('totalConfigs').textContent = allConfigs.length;
            
            document.getElementById('prevConfigPageBtn').disabled = currentConfigPage === 1;
            document.getElementById('nextConfigPageBtn').disabled = currentConfigPage === totalPages || totalPages === 0;
        }

        // é…ç½®ç®¡ç†ä¸Šä¸€é¡µ
        function prevConfigPage() {
            if (currentConfigPage > 1) {
                currentConfigPage--;
                renderConfigTable();
                updateConfigPagination();
            }
        }

        // é…ç½®ç®¡ç†ä¸‹ä¸€é¡µ
        function nextConfigPage() {
            const totalPages = Math.ceil(allConfigs.length / configsPerPage);
            if (currentConfigPage < totalPages) {
                currentConfigPage++;
                renderConfigTable();
                updateConfigPagination();
            }
        }

        // ç«‹å³å¤‡ä»½è®¾å¤‡é…ç½®
        function backupDevice(deviceId, deviceName) {
            if (confirm(`ç¡®å®šè¦ç«‹å³å¤‡ä»½è®¾å¤‡ "${deviceName}" çš„é…ç½®å—ï¼Ÿ`)) {
                console.log('å¼€å§‹å¤‡ä»½è®¾å¤‡:', deviceId, deviceName);
                
                // æ˜¾ç¤ºå¤‡ä»½è¿›åº¦æç¤º
                alert('æ­£åœ¨å¤‡ä»½é…ç½®ï¼Œè¯·ç¨å€™...');
                
                // TODO: è°ƒç”¨å¤‡ä»½API
                fetch(`/api/network/config/backup/${deviceId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`è®¾å¤‡ "${deviceName}" é…ç½®å¤‡ä»½æˆåŠŸï¼`);
                        // åˆ·æ–°é…ç½®åˆ—è¡¨
                        loadConfigList();
                    } else {
                        alert(`å¤‡ä»½å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('å¤‡ä»½å¤±è´¥:', error);
                    alert('å¤‡ä»½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }

        // æŸ¥çœ‹è®¾å¤‡å¿«ç…§è¯¦æƒ…
        function viewDeviceSnapshot(deviceId, deviceName) {
            console.log('æŸ¥çœ‹è®¾å¤‡å¿«ç…§:', deviceId, deviceName);
            
            // ä»localStorageè·å–é…ç½®å¤‡ä»½æ•°æ®
            const configBackups = JSON.parse(localStorage.getItem('configBackups') || '{}');
            const deviceBackup = configBackups[deviceId];
            
            if (!deviceBackup || deviceBackup.backups.length === 0) {
                alert(`è®¾å¤‡ "${deviceName}" æš‚æ— å¤‡ä»½è®°å½•`);
                return;
            }
            
            // è·å–æœ€æ–°çš„å¤‡ä»½å¿«ç…§
            const latestBackup = deviceBackup.backups[0];
            const snapshot = latestBackup.deviceSnapshot;
            
            // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†
            showDeviceSnapshotModal(snapshot, latestBackup, deviceBackup);
        }

        // æ˜¾ç¤ºè®¾å¤‡å¿«ç…§è¯¦æƒ…æ¨¡æ€æ¡†
        function showDeviceSnapshotModal(snapshot, backup, deviceBackup) {
            // åˆ›å»ºæ¨¡æ€æ¡†HTML
            const modalHTML = `
                <div id="snapshotModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    ">
                        <!-- å¤´éƒ¨ -->
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #fff;
                            padding: 25px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 24px;">
                                    <i class="fas fa-camera"></i> è®¾å¤‡å¿«ç…§è¯¦æƒ…
                                </h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    å¤‡ä»½ç‰ˆæœ¬: ${backup.version} | å¤‡ä»½æ—¶é—´: ${backup.backupTime}
                                </p>
                            </div>
                            <button onclick="closeSnapshotModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- å†…å®¹åŒºåŸŸ -->
                        <div style="padding: 30px;">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #667eea;
                                ">
                                    <i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #667eea;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è®¾å¤‡ID</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceId || snapshot.id}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #667eea;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è®¾å¤‡åç§°</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceName || snapshot.name}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">IPåœ°å€</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceIp || snapshot.ip}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è®¾å¤‡ç±»å‹</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${getDeviceTypeText(snapshot.deviceType || snapshot.type)}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid ${(snapshot.deviceStatus || snapshot.status) === 'online' ? '#4CAF50' : '#F44336'};
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è®¾å¤‡çŠ¶æ€</div>
                                        <div style="color: ${(snapshot.deviceStatus || snapshot.status) === 'online' ? '#4CAF50' : '#F44336'}; font-size: 16px; font-weight: 500;">
                                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i>
                                            ${(snapshot.deviceStatus || snapshot.status) === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                        </div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #FF9800;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">æ‰€å±åˆ†ç»„</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.groupName || 'æœªåˆ†ç»„'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #9C27B0;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è®¾å¤‡å‹å·</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.deviceModel || snapshot.model || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #9C27B0;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">åˆ¶é€ å•†</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.manufacturer || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #607D8B;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">åºåˆ—å·</div>
                                        <div style="color: #333; font-size: 14px; font-weight: 500;">${snapshot.serialNumber || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #607D8B;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">MACåœ°å€</div>
                                        <div style="color: #333; font-size: 14px; font-weight: 500;">${snapshot.macAddress || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #00BCD4;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ç‰©ç†ä½ç½®</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.location || '-'}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #00BCD4;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">æ¥å£æ•°é‡</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${snapshot.interfaceCount || 0} ä¸ª</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ€§èƒ½æŒ‡æ ‡ -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #FF5722;
                                ">
                                    <i class="fas fa-tachometer-alt"></i> æ€§èƒ½æŒ‡æ ‡ï¼ˆå¿«ç…§æ—¶åˆ»ï¼‰
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(4, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">CPUä½¿ç”¨ç‡</div>
                                        <div style="font-size: 28px; font-weight: bold;">${(parseFloat(snapshot.cpuUsage) || 0).toFixed(1)}%</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">å†…å­˜ä½¿ç”¨ç‡</div>
                                        <div style="font-size: 28px; font-weight: bold;">${(parseFloat(snapshot.memoryUsage) || 0).toFixed(1)}%</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">ç£ç›˜ä½¿ç”¨ç‡</div>
                                        <div style="font-size: 28px; font-weight: bold;">${(parseFloat(snapshot.diskUsage) || 0).toFixed(1)}%</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #FA709A 0%, #FEE140 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">è¿è¡Œæ—¶é•¿</div>
                                        <div style="font-size: 20px; font-weight: bold;">${formatUptime(snapshot.uptime || 0)}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¤‡ä»½ä¿¡æ¯ -->
                            <div style="margin-bottom: 30px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #4CAF50;
                                ">
                                    <i class="fas fa-save"></i> å¤‡ä»½ä¿¡æ¯
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #2196F3;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å¤‡ä»½ç‰ˆæœ¬</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${backup.version}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid #2196F3;
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å¤‡ä»½æ—¶é—´</div>
                                        <div style="color: #333; font-size: 14px; font-weight: 500;">${backup.backupTime}</div>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 15px;
                                        border-radius: 8px;
                                        border-left: 4px solid ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                    ">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å¤‡ä»½çŠ¶æ€</div>
                                        <div style="color: ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'}; font-size: 16px; font-weight: 500;">
                                            <i class="fas ${backup.backupStatus === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                            ${backup.backupStatus === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                            <div style="margin-bottom: 20px;">
                                <h3 style="
                                    color: #333;
                                    font-size: 18px;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 2px solid #FF9800;
                                ">
                                    <i class="fas fa-chart-bar"></i> ç»Ÿè®¡ä¿¡æ¯
                                </h3>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 15px;
                                ">
                                    <div style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">æ€»å¤‡ä»½æ¬¡æ•°</div>
                                        <div style="font-size: 32px; font-weight: bold;">${deviceBackup.backups ? deviceBackup.backups.length : 0}</div>
                                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">æ¬¡</div>
                                    </div>
                                    <div style="
                                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                        color: #fff;
                                        padding: 20px;
                                        border-radius: 8px;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">å½“å‰ç‰ˆæœ¬å·</div>
                                        <div style="font-size: 32px; font-weight: bold;">${backup.version || '-'}</div>
                                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">ç‰ˆæœ¬</div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¿«ç…§æ—¶é—´æˆ³ -->
                            <div style="
                                background: #e3f2fd;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #2196F3;
                                margin-top: 20px;
                            ">
                                <div style="color: #1976D2; font-size: 14px;">
                                    <i class="fas fa-clock"></i> 
                                    <strong>å¿«ç…§æ—¶é—´ï¼š</strong>${backup.backupTime}
                                </div>
                                <div style="color: #666; font-size: 12px; margin-top: 5px;">
                                    æ­¤å¿«ç…§è®°å½•äº†è¯¥æ—¶åˆ»è®¾å¤‡çš„å®Œæ•´çŠ¶æ€ä¿¡æ¯
                                </div>
                            </div>
                        </div>

                        <!-- åº•éƒ¨æŒ‰é’® -->
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: flex-end;
                            gap: 10px;
                        ">
                            <button onclick="closeSnapshotModal()" style="
                                padding: 10px 20px;
                                background: #607D8B;
                                color: #fff;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                <i class="fas fa-times"></i> å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // å…³é—­å¿«ç…§è¯¦æƒ…æ¨¡æ€æ¡†
        function closeSnapshotModal() {
            const modal = document.getElementById('snapshotModal');
            if (modal) {
                modal.remove();
            }
        }

        // è·å–è®¾å¤‡ç±»å‹æ–‡æœ¬
        function getDeviceTypeText(type) {
            const typeMap = {
                'router': 'è·¯ç”±å™¨',
                'switch': 'äº¤æ¢æœº',
                'firewall': 'é˜²ç«å¢™',
                'server': 'æœåŠ¡å™¨',
                'storage': 'å­˜å‚¨è®¾å¤‡',
                'wireless': 'æ— çº¿AP',
                'load_balancer': 'è´Ÿè½½å‡è¡¡',
                'network': 'ç½‘ç»œè®¾å¤‡'
            };
            return typeMap[type] || type || 'æœªçŸ¥';
        }

        // æ ¼å¼åŒ–è¿è¡Œæ—¶é•¿
        function formatUptime(seconds) {
            if (!seconds || seconds === 0) return '0å¤©';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}å¤©${hours}æ—¶`;
            } else if (hours > 0) {
                return `${hours}æ—¶${minutes}åˆ†`;
            } else {
                return `${minutes}åˆ†é’Ÿ`;
            }
        }

        // æŸ¥çœ‹é…ç½®å†å² - ä»æ•°æ®åº“è¯»å–
        function viewConfigHistory(deviceId, deviceName) {
            console.log(`ğŸ” æŸ¥çœ‹è®¾å¤‡ç‰ˆæœ¬å†å²: ${deviceName} (ID: ${deviceId})`);
            
            fetch(`/api/config-backup/history/${deviceId}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('ğŸ“¡ ç‰ˆæœ¬å†å²APIå“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('ğŸ“Š ç‰ˆæœ¬å†å²APIç»“æœ:', result);
                
                if (result.success && result.data && result.data.length > 0) {
                    // è·å–ç¬¬ä¸€æ¡è®°å½•ä½œä¸ºè®¾å¤‡åŸºæœ¬ä¿¡æ¯çš„æ¥æº
                    const firstRecord = result.data[0];
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼ä»¥é€‚é…æ¨¡æ€æ¡†
                    const deviceBackup = {
                        deviceId: deviceId,
                        deviceName: firstRecord.deviceName || deviceName,
                        deviceType: firstRecord.deviceType || 'æœªçŸ¥',
                        deviceIp: 'è·å–ä¸­...', // éœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–
                        backups: result.data.map(history => ({
                            version: history.version,
                            backupTime: history.backupTime,
                            operator: history.operator || 'admin',
                            backupSize: history.backupSize || 'N/A',
                            backupStatus: 'success', // ä¿®æ­£å­—æ®µåï¼Œå¼ºåˆ¶è®¾ç½®ä¸ºæˆåŠŸçŠ¶æ€
                            changeSummary: history.changeSummary || 'é…ç½®å¤‡ä»½',
                            changeDetails: history.changeDetails,
                            backupId: history.backupId,
                            // æ·»åŠ è®¾å¤‡è¯¦ç»†ä¿¡æ¯
                            deviceId: history.deviceId,
                            deviceName: history.deviceName,
                            deviceType: history.deviceType
                        }))
                    };
                    
                    // ä»å¤‡ä»½è®°å½•ä¸­è·å–è®¾å¤‡è¯¦ç»†ä¿¡æ¯
                    if (deviceBackup.backups.length > 0) {
                        const latestBackup = deviceBackup.backups[0];
                        // é€šè¿‡å¤‡ä»½IDè·å–å®Œæ•´çš„è®¾å¤‡å¿«ç…§ä¿¡æ¯
                        fetch(`/api/config-backup/snapshot/${latestBackup.backupId}`, {
                            method: 'GET',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(snapshotResult => {
                            if (snapshotResult.success && snapshotResult.backup) {
                                const backup = snapshotResult.backup;
                                deviceBackup.deviceIp = backup.deviceIp || 'N/A';
                                deviceBackup.assetCode = backup.assetCode || 'N/A';
                                deviceBackup.manufacturer = backup.manufacturer || 'N/A';
                                deviceBackup.model = backup.model || 'N/A';
                                
                                // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„è®¾å¤‡ä¿¡æ¯
                                updateModalDeviceInfo(deviceBackup);
                            }
                        })
                        .catch(error => {
                            console.log('è·å–è®¾å¤‡å¿«ç…§å¤±è´¥:', error);
                        });
                    }
                    
                    showVersionHistoryModal(deviceName, deviceBackup);
                } else {
                    alert(`è®¾å¤‡ "${deviceName}" æš‚æ— å¤‡ä»½å†å²`);
                }
            })
            .catch(error => {
                console.error('âŒ ç‰ˆæœ¬å†å²APIè°ƒç”¨å¤±è´¥:', error);
                alert('è·å–ç‰ˆæœ¬å†å²å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„è®¾å¤‡ä¿¡æ¯
        function updateModalDeviceInfo(deviceBackup) {
            // è¿™ä¸ªå‡½æ•°ç”¨äºåœ¨è·å–åˆ°å®Œæ•´è®¾å¤‡ä¿¡æ¯åæ›´æ–°æ¨¡æ€æ¡†æ˜¾ç¤º
            // ç”±äºæ¨¡æ€æ¡†å·²ç»æ˜¾ç¤ºï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡DOMæ“ä½œæ›´æ–°ä¿¡æ¯
            console.log('æ›´æ–°æ¨¡æ€æ¡†è®¾å¤‡ä¿¡æ¯:', deviceBackup);
        }
        
        // è§£æç‰ˆæœ¬å·ä¸ºæ•°å­—ï¼ˆç”¨äºæ’åºï¼‰
        function parseVersionNumber(version) {
            const match = version.match(/^v(\d+)\.(\d+)$/);
            if (match) {
                return parseFloat(match[1] + '.' + match[2]);
            }
            return 0;
        }

        // æ˜¾ç¤ºç‰ˆæœ¬å†å²æ¨¡æ€æ¡†
        function showVersionHistoryModal(deviceName, deviceBackup) {
            const modalHTML = `
                <div id="historyModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    ">
                        <!-- å¤´éƒ¨ -->
                        <div style="
                            background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
                            color: #fff;
                            padding: 25px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 24px;">
                                    <i class="fas fa-history"></i> ç‰ˆæœ¬å†å²
                                </h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    è®¾å¤‡: ${deviceName} | æ€»è®¡ ${deviceBackup.backups.length} ä¸ªç‰ˆæœ¬
                                </p>
                            </div>
                            <button onclick="closeHistoryModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- æ—¶é—´çº¿å†…å®¹ -->
                        <div style="padding: 30px;">
                            <div style="position: relative; padding-left: 40px;">
                                <!-- æ—¶é—´çº¿ç«–çº¿ -->
                                <div style="
                                    position: absolute;
                                    left: 15px;
                                    top: 0;
                                    bottom: 0;
                                    width: 2px;
                                    background: linear-gradient(180deg, #4FACFE 0%, #00F2FE 100%);
                                "></div>
                                
                                ${deviceBackup.backups.map((backup, index) => `
                                    <div style="
                                        position: relative;
                                        margin-bottom: ${index < deviceBackup.backups.length - 1 ? '30px' : '0'};
                                        background: #fff;
                                        border: 2px solid ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                        border-radius: 8px;
                                        padding: 20px;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                        transition: transform 0.2s, box-shadow 0.2s;
                                    " onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" 
                                       onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                                        <!-- æ—¶é—´çº¿åœ†ç‚¹ -->
                                        <div style="
                                            position: absolute;
                                            left: -33px;
                                            top: 20px;
                                            width: 16px;
                                            height: 16px;
                                            background: ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                            border: 3px solid #fff;
                                            border-radius: 50%;
                                            box-shadow: 0 0 0 2px ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                        "></div>
                                        
                                        <!-- ç‰ˆæœ¬æ ‡é¢˜ -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="
                                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                    color: #fff;
                                                    padding: 5px 15px;
                                                    border-radius: 20px;
                                                    font-weight: bold;
                                                    font-size: 16px;
                                                ">ç‰ˆæœ¬ ${backup.version}</span>
                                                ${index === 0 ? '<span style="background: #FF9800; color: #fff; padding: 3px 10px; border-radius: 12px; font-size: 12px;">æœ€æ–°</span>' : ''}
                                            </div>
                                            <div style="
                                                color: ${backup.backupStatus === 'success' ? '#4CAF50' : '#F44336'};
                                                font-weight: bold;
                                                display: flex;
                                                align-items: center;
                                                gap: 5px;
                                            ">
                                                <i class="fas ${backup.backupStatus === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                                ${backup.backupStatus === 'success' ? 'å¤‡ä»½æˆåŠŸ' : 'å¤‡ä»½å¤±è´¥'}
                                            </div>
                                        </div>
                                        
                                        <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: repeat(2, 1fr);
                                            gap: 15px;
                                            margin-bottom: 15px;
                                        ">
                                            <div style="
                                                background: #f8f9fa;
                                                padding: 10px 15px;
                                                border-radius: 6px;
                                                border-left: 3px solid #2196F3;
                                            ">
                                                <div style="color: #666; font-size: 12px; margin-bottom: 3px;">
                                                    <i class="fas fa-clock"></i> å¤‡ä»½æ—¶é—´
                                                </div>
                                                <div style="color: #333; font-size: 14px; font-weight: 500;">
                                                    ${backup.backupTime}
                                                </div>
                                            </div>
                                            <!-- è®¾å¤‡çŠ¶æ€å·²éšè— -->
                                        </div>
                                        
                                        <!-- æ“ä½œæŒ‰é’® -->
                                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                            <button onclick="viewVersionSnapshot(${deviceBackup.deviceId}, ${backup.backupId}); event.stopPropagation();" style="
                                                padding: 8px 16px;
                                                background: #2196F3;
                                                color: #fff;
                                                border: none;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-size: 13px;
                                            ">
                                                <i class="fas fa-eye"></i> æŸ¥çœ‹å¿«ç…§
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- åº•éƒ¨ -->
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #e0e0e0;
                            display: flex;
                            justify-content: flex-end;
                        ">
                            <button onclick="closeHistoryModal()" style="
                                padding: 10px 20px;
                                background: #607D8B;
                                color: #fff;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                <i class="fas fa-times"></i> å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // å…³é—­ç‰ˆæœ¬å†å²æ¨¡æ€æ¡†
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }

        // æŸ¥çœ‹æŒ‡å®šç‰ˆæœ¬çš„å¿«ç…§
        function viewVersionSnapshot(deviceId, backupId) {
            console.log('æŸ¥çœ‹ç‰ˆæœ¬å¿«ç…§:', deviceId, backupId);
            
            // ä»åç«¯APIè·å–å¿«ç…§æ•°æ®
            fetch(`/api/config-backup/snapshot/${backupId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const data = result.data;
                        
                        // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                        console.log('ğŸ” å¿«ç…§APIè¿”å›ç»“æœ:', result);
                        console.log('ğŸ“Š è®¾å¤‡æ•°æ®è¯¦æƒ…:', data);
                        console.log('ğŸ†” åŸºæœ¬ä¿¡æ¯:', data.basicInfo);
                        console.log('ğŸ“‹ å¤‡ä»½ä¿¡æ¯:', data.backupInfo);
                        console.log('ğŸ“‹ æ‰€æœ‰å­—æ®µ:', Object.keys(data));
                        
                        // ä»APIè¿”å›çš„ç»“æ„åŒ–æ•°æ®ä¸­æå–ä¿¡æ¯
                        const basicInfo = data.basicInfo || {};
                        const backupInfo = data.backupInfo || {};
                        const deviceStatus = data.deviceStatus || {};
                        const networkConfig = data.networkConfig || {};
                        
                        // æ„é€ å¿«ç…§æ•°æ®å¯¹è±¡
                        const snapshot = {
                            deviceId: basicInfo.deviceId,
                            deviceName: basicInfo.deviceName,
                            deviceIp: basicInfo.deviceIp,
                            deviceType: basicInfo.deviceType,
                            manufacturer: basicInfo.manufacturer,
                            model: basicInfo.model,
                            assetCode: basicInfo.assetCode,
                            status: deviceStatus.status,
                            uptime: deviceStatus.uptime,
                            cpuUsage: deviceStatus.cpuUsage,
                            memoryUsage: deviceStatus.memoryUsage,
                            temperature: deviceStatus.temperature,
                            macAddress: networkConfig.macAddress,
                            subnetMask: networkConfig.subnetMask,
                            gateway: networkConfig.gateway,
                            dnsServers: networkConfig.dnsServers
                        };
                        
                        // æ„é€ backupå¯¹è±¡ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                        const backup = {
                            version: backupInfo.version || '-',
                            backupTime: backupInfo.backupTime || '-',
                            backupStatus: backupInfo.backupStatus || 'success',
                            backupSize: backupInfo.backupSize || '-',
                            operator: backupInfo.operator || '-',
                            firmwareVersion: backupInfo.firmwareVersion || '-',
                            configChecksum: backupInfo.configChecksum || '-'
                        };
                        
                        // æ„é€ deviceBackupå¯¹è±¡ï¼ˆç”¨äºæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼‰
                        const deviceBackup = {
                            deviceId: deviceId,
                            backups: [] // å¯ä»¥ä¸ºç©ºï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¾ç¤ºå½“å‰å¿«ç…§
                        };
                        
                        // å…³é—­å†å²æ¨¡æ€æ¡†
                        closeHistoryModal();
                        
                        // å»¶è¿Ÿä¸€ä¸‹å†æ˜¾ç¤ºå¿«ç…§è¯¦æƒ…ï¼Œç¡®ä¿å†å²æ¨¡æ€æ¡†å·²å…³é—­
                        setTimeout(() => {
                            showDeviceSnapshotModal(snapshot, backup, deviceBackup);
                        }, 100);
                    } else {
                        alert('æœªæ‰¾åˆ°è¯¥ç‰ˆæœ¬çš„å¿«ç…§æ•°æ®');
                    }
                })
                .catch(error => {
                    console.error('è·å–å¿«ç…§å¤±è´¥:', error);
                    alert('è·å–å¿«ç…§å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
        }

        // æ¨¡æ‹Ÿä¸“çº¿æ•°æ®
        let mockLines = [
            {
                id: 1,
                name: 'åŒ—äº¬-ä¸Šæµ·ä¸“çº¿',
                provider: 'ä¸­å›½ç”µä¿¡',
                bandwidth: '100Mbps',
                endpointA: 'åŒ—äº¬æœºæˆ¿',
                endpointB: 'ä¸Šæµ·æœºæˆ¿',
                status: 'normal',
                latency: 25.5,
                jitter: 5.2,
                packetLoss: 0.05
            },
            {
                id: 2,
                name: 'åŒ—äº¬-å¹¿å·ä¸“çº¿',
                provider: 'ä¸­å›½è”é€š',
                bandwidth: '200Mbps',
                endpointA: 'åŒ—äº¬æœºæˆ¿',
                endpointB: 'å¹¿å·æœºæˆ¿',
                status: 'warning',
                latency: 45.8,
                jitter: 8.5,
                packetLoss: 0.15
            },
            {
                id: 3,
                name: 'æœºæˆ¿A-æœºæˆ¿Bä¸“çº¿',
                provider: 'ä¸­å›½ç§»åŠ¨',
                bandwidth: '500Mbps',
                endpointA: 'æœºæˆ¿A',
                endpointB: 'æœºæˆ¿B',
                status: 'normal',
                latency: 18.2,
                jitter: 3.1,
                packetLoss: 0.02
            },
            {
                id: 4,
                name: 'äº’è”ç½‘å‡ºå£ä¸“çº¿',
                provider: 'ä¸­å›½ç”µä¿¡',
                bandwidth: '1Gbps',
                endpointA: 'æ ¸å¿ƒæœºæˆ¿',
                endpointB: 'äº’è”ç½‘',
                status: 'fault',
                latency: 85.6,
                jitter: 15.3,
                packetLoss: 2.5
            }
        ];

        // åŠ è½½ä¸“çº¿åˆ—è¡¨
        function loadLinesList() {
            const provider = document.getElementById('lineProviderFilter')?.value || '';
            const status = document.getElementById('lineStatusFilter')?.value || '';
            const keyword = document.getElementById('lineKeywordSearch')?.value || '';
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            let params = [];
            if (provider) params.push(`provider=${encodeURIComponent(provider)}`);
            if (status) params.push(`status=${encodeURIComponent(status)}`);
            if (keyword) params.push(`keyword=${encodeURIComponent(keyword)}`);
            
            const queryString = params.length > 0 ? '?' + params.join('&') : '';
            
            // ä»APIè·å–æ•°æ®
            fetch(`/api/lines${queryString}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        renderLineTable(result.data || []);
                    } else {
                        console.error('è·å–ä¸“çº¿åˆ—è¡¨å¤±è´¥:', result.message);
                        renderLineTable([]);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ä¸“çº¿åˆ—è¡¨å¤±è´¥:', error);
                    renderLineTable([]);
                });
        }

        // æ¸²æŸ“ä¸“çº¿è¡¨æ ¼
        function renderLineTable(lines) {
            const tbody = document.getElementById('lineTableBody');
            
            if (lines.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state">
                                <i class="fas fa-project-diagram"></i>
                                <p>æš‚æ— ä¸“çº¿æ•°æ®</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = lines.map(line => {
                const statusClass = line.status === 'normal' ? 'status-online' : 
                                   line.status === 'warning' ? 'status-maintenance' : 'status-offline';
                const statusText = line.status === 'normal' ? 'æ­£å¸¸' : 
                                  line.status === 'warning' ? 'è­¦å‘Š' : 'æ•…éšœ';
                
                const latencyClass = line.latency < 30 ? 'status-online' : 
                                    line.latency < 50 ? 'status-maintenance' : 'status-offline';
                const packetLossClass = line.packetLoss < 0.1 ? 'status-online' : 
                                       line.packetLoss < 1 ? 'status-maintenance' : 'status-offline';

                return `
                    <tr>
                        <td>${line.id}</td>
                        <td>${line.name}</td>
                        <td>${line.provider}</td>
                        <td>${line.bandwidth}</td>
                        <td>${line.endpointA}</td>
                        <td>${line.endpointB}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td><span class="status-badge ${latencyClass}">${line.latency}ms</span></td>
                        <td><span class="status-badge ${packetLossClass}">${line.packetLoss}%</span></td>
                        <td>
                            <button class="btn-detail" onclick="viewLineDetail(${line.id})" style="margin-right: 5px;">
                                <i class="fas fa-eye"></i> è¯¦æƒ…
                            </button>
                            <button class="btn-detail" onclick="editLine(${line.id})" style="margin-right: 5px; background: #FF9800;">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                            <button class="btn-detail" onclick="deleteLine(${line.id})" style="background: #F44336;">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æŸ¥çœ‹ä¸“çº¿è¯¦æƒ…
        function viewLineDetail(lineId) {
            fetch(`/api/lines/${lineId}`)
                .then(response => response.json())
                .then(line => {
                    if (line) {
                        showLineDetailModal(line);
                    } else {
                        alert('æœªæ‰¾åˆ°ä¸“çº¿ä¿¡æ¯');
                    }
                })
                .catch(error => {
                    console.error('è·å–ä¸“çº¿è¯¦æƒ…å¤±è´¥:', error);
                    alert('è·å–ä¸“çº¿è¯¦æƒ…å¤±è´¥');
                });
        }

        // æ˜¾ç¤ºä¸“çº¿è¯¦æƒ…æ¨¡æ€æ¡†
        function showLineDetailModal(line) {
            const statusText = line.status === 'normal' ? 'æ­£å¸¸' : 
                              line.status === 'warning' ? 'è­¦å‘Š' : 'æ•…éšœ';
            const statusColor = line.status === 'normal' ? '#4CAF50' : 
                               line.status === 'warning' ? '#FF9800' : '#F44336';
            
            const modalHTML = `
                <div id="lineDetailModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        animation: slideUp 0.3s;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #fff;
                            padding: 25px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 24px;">
                                <i class="fas fa-project-diagram"></i> ä¸“çº¿è¯¦æƒ…
                            </h2>
                            <button onclick="closeLineDetailModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                                transition: all 0.3s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="padding: 30px;">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ä¸“çº¿åç§°</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.name}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ç”µè·¯ID</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.circuitId || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è¿è¥å•†</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.provider}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ä¸“çº¿ç±»å‹</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.lineType || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å¸¦å®½</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.bandwidth}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">çŠ¶æ€</div>
                                        <div style="color: ${statusColor}; font-size: 16px; font-weight: 500;">
                                            <i class="fas fa-circle" style="font-size: 8px;"></i> ${statusText}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç«¯ç‚¹ä¿¡æ¯ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-map-marker-alt"></i> ç«¯ç‚¹ä¿¡æ¯
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ç«¯ç‚¹A</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.endpointA}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ç«¯ç‚¹B</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.endpointB}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- SLAæŒ‡æ ‡ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-chart-line"></i> SLAæŒ‡æ ‡
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å»¶è¿Ÿé˜ˆå€¼</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaLatency || '-'}ms</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">æŠ–åŠ¨é˜ˆå€¼</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaJitter || '-'}ms</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ä¸¢åŒ…ç‡é˜ˆå€¼</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaPacketLoss || '-'}%</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9C27B0;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å¯ç”¨æ€§è¦æ±‚</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.slaAvailability || '-'}%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- åˆåŒä¿¡æ¯ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-file-contract"></i> åˆåŒä¿¡æ¯
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">å¼€é€šæ—¥æœŸ</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.activationDate || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">åˆ°æœŸæ—¥æœŸ</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.expiryDate || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF5722;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">æœˆç§Ÿè´¹ç”¨</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">Â¥${line.monthlyCost || '-'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- è”ç³»ä¿¡æ¯ -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-address-book"></i> è”ç³»ä¿¡æ¯
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #00BCD4;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è”ç³»äºº</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.contactPerson || '-'}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #00BCD4;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">è”ç³»ç”µè¯</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">${line.contactPhone || '-'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¤‡æ³¨ -->
                            ${line.notes ? `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                    <i class="fas fa-sticky-note"></i> å¤‡æ³¨
                                </h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #607D8B;">
                                    <div style="color: #333; font-size: 14px; line-height: 1.6;">${line.notes}</div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 30px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="closeLineDetailModal(); editLine(${line.id});" style="
                                    padding: 10px 20px;
                                    background: #FF9800;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#F57C00'" 
                                   onmouseout="this.style.background='#FF9800'">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘
                                </button>
                                <button onclick="closeLineDetailModal()" style="
                                    padding: 10px 20px;
                                    background: #607D8B;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#455A64'" 
                                   onmouseout="this.style.background='#607D8B'">
                                    <i class="fas fa-times"></i> å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // å…³é—­ä¸“çº¿è¯¦æƒ…æ¨¡æ€æ¡†
        function closeLineDetailModal() {
            const modal = document.getElementById('lineDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        // ç¼–è¾‘ä¸“çº¿
        function editLine(lineId) {
            fetch(`/api/lines/${lineId}`)
                .then(response => response.json())
                .then(line => {
                    if (line) {
                        showLineFormModal(line);
                    } else {
                        alert('æœªæ‰¾åˆ°ä¸“çº¿ä¿¡æ¯');
                    }
                })
                .catch(error => {
                    console.error('è·å–ä¸“çº¿ä¿¡æ¯å¤±è´¥:', error);
                    alert('è·å–ä¸“çº¿ä¿¡æ¯å¤±è´¥');
                });
        }

        // æ˜¾ç¤ºä¸“çº¿è¡¨å•æ¨¡æ€æ¡†ï¼ˆæ·»åŠ /ç¼–è¾‘ï¼‰
        function showLineFormModal(line) {
            const isEdit = line !== null;
            const modalHTML = `
                <div id="lineFormModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s;
                ">
                    <div style="
                        background: #fff;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        animation: slideUp 0.3s;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #fff;
                            padding: 20px 30px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 22px;">
                                <i class="fas ${isEdit ? 'fa-edit' : 'fa-plus'}"></i> ${isEdit ? 'ç¼–è¾‘ä¸“çº¿' : 'æ·»åŠ ä¸“çº¿'}
                            </h2>
                            <button onclick="closeLineFormModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: #fff;
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 20px;
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="lineForm" style="padding: 30px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <!-- åŸºæœ¬ä¿¡æ¯ -->
                                <div style="grid-column: 1 / -1;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        ä¸“çº¿åç§° <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="lineName" value="${line?.name || ''}" required 
                                        placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬-ä¸Šæµ·ä¸“çº¿"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        ç”µè·¯ID <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="circuitId" value="${line?.circuitId || ''}" required 
                                        placeholder="ä¾‹å¦‚ï¼šCT-BJ-SH-001"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        è¿è¥å•† <span style="color: red;">*</span>
                                    </label>
                                    <select id="lineProvider" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">è¯·é€‰æ‹©è¿è¥å•†</option>
                                        <option value="ä¸­å›½ç”µä¿¡" ${line?.provider === 'ä¸­å›½ç”µä¿¡' ? 'selected' : ''}>ä¸­å›½ç”µä¿¡</option>
                                        <option value="ä¸­å›½è”é€š" ${line?.provider === 'ä¸­å›½è”é€š' ? 'selected' : ''}>ä¸­å›½è”é€š</option>
                                        <option value="ä¸­å›½ç§»åŠ¨" ${line?.provider === 'ä¸­å›½ç§»åŠ¨' ? 'selected' : ''}>ä¸­å›½ç§»åŠ¨</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        ä¸“çº¿ç±»å‹ <span style="color: red;">*</span>
                                    </label>
                                    <select id="lineType" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                        <option value="MPLS" ${line?.lineType === 'MPLS' ? 'selected' : ''}>MPLS</option>
                                        <option value="IPLC" ${line?.lineType === 'IPLC' ? 'selected' : ''}>IPLC</option>
                                        <option value="IEPL" ${line?.lineType === 'IEPL' ? 'selected' : ''}>IEPL</option>
                                        <option value="äº’è”ç½‘ä¸“çº¿" ${line?.lineType === 'äº’è”ç½‘ä¸“çº¿' ? 'selected' : ''}>äº’è”ç½‘ä¸“çº¿</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        å¸¦å®½ <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="bandwidth" value="${line?.bandwidth || ''}" required 
                                        placeholder="ä¾‹å¦‚ï¼š100Mbps"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        çŠ¶æ€ <span style="color: red;">*</span>
                                    </label>
                                    <select id="lineStatus" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="normal" ${line?.status === 'normal' ? 'selected' : ''}>æ­£å¸¸</option>
                                        <option value="warning" ${line?.status === 'warning' ? 'selected' : ''}>è­¦å‘Š</option>
                                        <option value="fault" ${line?.status === 'fault' ? 'selected' : ''}>æ•…éšœ</option>
                                    </select>
                                </div>

                                <!-- ç«¯ç‚¹ä¿¡æ¯ -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-map-marker-alt"></i> ç«¯ç‚¹ä¿¡æ¯
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        ç«¯ç‚¹A <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="endpointA" value="${line?.endpointA || ''}" required 
                                        placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬æ•°æ®ä¸­å¿ƒ"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        ç«¯ç‚¹B <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="endpointB" value="${line?.endpointB || ''}" required 
                                        placeholder="ä¾‹å¦‚ï¼šä¸Šæµ·æ•°æ®ä¸­å¿ƒ"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>

                                <!-- åˆåŒä¿¡æ¯ -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-file-contract"></i> åˆåŒä¿¡æ¯
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        å¼€é€šæ—¥æœŸ
                                    </label>
                                    <input type="date" id="activationDate" value="${line?.activationDate || ''}"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        åˆ°æœŸæ—¥æœŸ
                                    </label>
                                    <input type="date" id="expiryDate" value="${line?.expiryDate || ''}"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        æœˆç§Ÿè´¹ç”¨ï¼ˆå…ƒï¼‰
                                    </label>
                                    <input type="number" id="monthlyCost" value="${line?.monthlyCost || ''}" 
                                        placeholder="ä¾‹å¦‚ï¼š8000"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>

                                <!-- è”ç³»ä¿¡æ¯ -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                                        <i class="fas fa-address-book"></i> è”ç³»ä¿¡æ¯
                                    </h3>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        è”ç³»äºº
                                    </label>
                                    <input type="text" id="contactPerson" value="${line?.contactPerson || ''}" 
                                        placeholder="ä¾‹å¦‚ï¼šå¼ ä¼Ÿ"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        è”ç³»ç”µè¯
                                    </label>
                                    <input type="text" id="contactPhone" value="${line?.contactPhone || ''}" 
                                        placeholder="ä¾‹å¦‚ï¼š13800138000"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>

                                <!-- å¤‡æ³¨ -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">
                                        <i class="fas fa-sticky-note"></i> å¤‡æ³¨
                                    </label>
                                    <textarea id="notes" rows="3" 
                                        placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${line?.notes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 20px;">
                                <button type="button" onclick="closeLineFormModal()" style="
                                    padding: 10px 25px;
                                    background: #607D8B;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#455A64'" 
                                   onmouseout="this.style.background='#607D8B'">
                                    <i class="fas fa-times"></i> å–æ¶ˆ
                                </button>
                                <button type="submit" style="
                                    padding: 10px 25px;
                                    background: #4CAF50;
                                    color: #fff;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#45a049'" 
                                   onmouseout="this.style.background='#4CAF50'">
                                    <i class="fas fa-save"></i> ä¿å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('lineForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveLineData(line?.id);
            });
        }

        // ä¿å­˜ä¸“çº¿æ•°æ®
        function saveLineData(lineId) {
            const lineData = {
                name: document.getElementById('lineName').value.trim(),
                circuitId: document.getElementById('circuitId').value.trim(),
                provider: document.getElementById('lineProvider').value,
                lineType: document.getElementById('lineType').value,
                bandwidth: document.getElementById('bandwidth').value.trim(),
                status: document.getElementById('lineStatus').value,
                endpointA: document.getElementById('endpointA').value.trim(),
                endpointB: document.getElementById('endpointB').value.trim(),
                activationDate: document.getElementById('activationDate').value || null,
                expiryDate: document.getElementById('expiryDate').value || null,
                monthlyCost: document.getElementById('monthlyCost').value || null,
                contactPerson: document.getElementById('contactPerson').value.trim() || null,
                contactPhone: document.getElementById('contactPhone').value.trim() || null,
                notes: document.getElementById('notes').value.trim() || null
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!lineData.name || !lineData.circuitId || !lineData.provider || 
                !lineData.lineType || !lineData.bandwidth || !lineData.endpointA || !lineData.endpointB) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                return;
            }
            
            console.log('å‡†å¤‡ä¿å­˜ä¸“çº¿æ•°æ®:', lineData);
            
            const url = lineId ? `/api/lines/${lineId}` : '/api/lines';
            const method = lineId ? 'PUT' : 'POST';
            
            console.log(`å‘é€è¯·æ±‚: ${method} ${url}`);
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(lineData)
            })
            .then(response => {
                console.log('å“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('ä¿å­˜ç»“æœ:', result);
                if (result === true || result.success === true) {
                    alert(lineId ? 'ä¸“çº¿æ›´æ–°æˆåŠŸï¼' : 'ä¸“çº¿æ·»åŠ æˆåŠŸï¼');
                    closeLineFormModal();
                    loadLinesList();
                } else {
                    const errorMsg = result.message || 'æ“ä½œå¤±è´¥ï¼';
                    alert(errorMsg);
                    console.error('æ“ä½œå¤±è´¥:', result);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜ä¸“çº¿å¤±è´¥:', error);
                alert('ä¿å­˜ä¸“çº¿å¤±è´¥: ' + error.message);
            });
        }

        // å…³é—­ä¸“çº¿è¡¨å•æ¨¡æ€æ¡†
        function closeLineFormModal() {
            const modal = document.getElementById('lineFormModal');
            if (modal) {
                modal.remove();
            }
        }

        // åˆ é™¤ä¸“çº¿
        function deleteLine(lineId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä¸“çº¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                console.log('åˆ é™¤ä¸“çº¿:', lineId);
                
                fetch(`/api/lines/${lineId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    console.log('åˆ é™¤å“åº”çŠ¶æ€:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('åˆ é™¤ç»“æœ:', result);
                    if (result.success === true) {
                        alert('ä¸“çº¿åˆ é™¤æˆåŠŸï¼');
                        loadLinesList();
                    } else {
                        const errorMsg = result.message || 'åˆ é™¤å¤±è´¥ï¼';
                        alert(errorMsg);
                        console.error('åˆ é™¤å¤±è´¥:', result);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤ä¸“çº¿å¤±è´¥:', error);
                    alert('åˆ é™¤ä¸“çº¿å¤±è´¥: ' + error.message);
                });
            }
        }

        // æ·»åŠ ä¸“çº¿
        function addLine() {
            showLineFormModal(null);
        }

        // é‡ç½®ä¸“çº¿ç­›é€‰
        function resetLineFilters() {
            // æ¸…ç©ºæ‰€æœ‰ç­›é€‰æ¡ä»¶
            document.getElementById('lineProviderFilter').value = '';
            document.getElementById('lineStatusFilter').value = '';
            document.getElementById('lineKeywordSearch').value = '';
            // é‡æ–°åŠ è½½ä¸“çº¿åˆ—è¡¨
            loadLinesList();
        }

        // æœç´¢ä¸“çº¿
        document.addEventListener('DOMContentLoaded', function() {
            const searchBtn = document.getElementById('searchLineBtn');
            const resetBtn = document.getElementById('resetLineBtn');
            const addBtn = document.getElementById('addLineBtn');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', loadLinesList);
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', resetLineFilters);
            }
            
            if (addBtn) {
                addBtn.addEventListener('click', addLine);
            }
            
            const keywordInput = document.getElementById('lineKeywordSearch');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loadLinesList();
                    }
                });
            }
        });

        // è·å–è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        function getDeviceStatusDisplay(backup) {
            // ç›´æ¥æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€ï¼šåœ¨çº¿ã€ç¦»çº¿ã€ç»´æŠ¤ä¸­
            
            // å°è¯•ä»changeDetailsä¸­è§£æå¤‡ä»½æ—¶çš„è®¾å¤‡çŠ¶æ€
            try {
                if (backup.changeDetails) {
                    const details = JSON.parse(backup.changeDetails);
                    // å¦‚æœå¤‡ä»½æˆåŠŸï¼Œè¯´æ˜å¤‡ä»½æ—¶è®¾å¤‡åœ¨çº¿
                    if (details.backupStatus === 'success') {
                        return 'ğŸŸ¢ åœ¨çº¿';
                    } else if (details.backupStatus === 'failed') {
                        return 'ğŸ”´ ç¦»çº¿';
                    }
                }
            } catch (e) {
                // è§£æå¤±è´¥ï¼Œç»§ç»­å…¶ä»–é€»è¾‘
            }
            
            // æ ¹æ®å¤‡ä»½çŠ¶æ€æ¨æ–­è®¾å¤‡çŠ¶æ€
            if (backup.changeSummary && backup.changeSummary.includes('success')) {
                return 'ğŸŸ¢ åœ¨çº¿';
            } else if (backup.changeSummary && backup.changeSummary.includes('failed')) {
                return 'ğŸ”´ ç¦»çº¿';
            }
            
            // é»˜è®¤æ˜¾ç¤ºç¦»çº¿çŠ¶æ€
            return 'ğŸ”´ ç¦»çº¿';
        }

        // è·³è½¬åˆ°è®¾å¤‡ç®¡ç†é¡µé¢çš„æŒ‡å®šåˆ†ç»„
        function navigateToDeviceGroup(groupId, groupName) {
            // ä½¿ç”¨URLå‚æ•°ä¼ é€’åˆ†ç»„IDå’Œåç§°
            window.location.href = `è®¾å¤‡ç®¡ç†.html?groupId=${groupId}&groupName=${encodeURIComponent(groupName)}`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadDeviceStats();
            loadDeviceList();
            loadConfigStats();
            loadConfigList();
            loadLinesList();
        });
    </script>
    
    <!-- ä¾§è¾¹æ å¯¼èˆªè„šæœ¬ -->
    <script src="js/navigation-fix.js"></script>
    
    <!-- åŠ è½½ç”¨æˆ·ä¸‹æ‹‰èœå• -->
    <script src="js/user-dropdown-loader.js"></script>
        </div>
    </div>
</div>
</body>
</html>
