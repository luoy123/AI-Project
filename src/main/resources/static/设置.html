<!DOCTYPE html>
<html lang="zh-CN">
<head>
<style>
/* 立即隐藏CMDB菜单项 - 防止闪烁 */
.nav-cmdb { display: none !important; }
.sidebar-item[data-page="CMDB"] { display: none !important; }
</style>
<script>
// 立即执行：尽早隐藏CMDB，防止闪烁
(function() {
    function hideCMDB() {
        var items = document.querySelectorAll('.sidebar-item');
        items.forEach(function(item) {
            var span = item.querySelector('span');
            if (span && span.textContent.trim() === 'CMDB') {
                item.style.display = 'none';
                item.setAttribute('data-hidden', 'true');
            }
        });
    }
    
    // 立即执行
    hideCMDB();
    
    // DOM Ready时再执行一次
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideCMDB);
    }
    
    // 额外保险：延迟执行确保覆盖所有情况
    setTimeout(hideCMDB, 10);
    setTimeout(hideCMDB, 100);
})();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - 人工智能运维平台</title>
    <link rel="stylesheet" href="libs/fontawesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="设置.css">
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>人工智能运维平台</h2>
            </div>
            <div class="menuItem sidebar-item nav-overview">
                <i class="fas fa-tachometer-alt"></i>
                <span>总览</span>
            </div>
            <div class="sidebar-item sidebar-item nav-view">
                <i class="fas fa-eye"></i>
                <span>视图</span>
            </div>
            <div class="sidebar-item sidebar-item nav-alert">
                <i class="fas fa-bell"></i>
                <span>告警中心</span>
            </div>
            <div class="sidebar-item sidebar-item nav-device">
                <i class="fas fa-server"></i>
                <span>设备管理</span>
            </div>
            <div class="sidebar-item sidebar-item nav-network">
                <i class="fas fa-network-wired"></i>
                <span>网络拓扑</span>
            </div>
            <div class="sidebar-item sidebar-item nav-report">
                <i class="fas fa-chart-line"></i>
                <span>统计报表</span>
            </div>
            <div class="sidebar-item">
                <i class="fas fa-tools"></i>
                <span>运维工具</span>
            </div>
            <div class="sidebar-item">
                <i class="fas fa-desktop"></i>
                <span>数字大屏</span>
            </div>
            <div class="sidebar-divider"></div>
            <div class="sidebar-group-title">拓展中心</div>
            <div class="sidebar-item sidebar-item nav-business">
                <i class="fas fa-layer-group"></i>
                <span>业务管理</span>
            </div>
            <div class="menuItem sidebar-item nav-network-mgmt">
                <i class="fas fa-globe"></i>
                <span>网络管理</span>
            </div>
            <div class="sidebar-item sidebar-item nav-video">
                <i class="fas fa-video"></i>
                <span>视频管理</span>
            </div>
            <div class="sidebar-item sidebar-item nav-room">
                <i class="fas fa-building"></i>
                <span>机房管理</span>
            </div>
            <div class="sidebar-item sidebar-item nav-asset">
                <i class="fas fa-cubes"></i>
                <span>资产管理</span>
            </div>
            <div class="sidebar-item sidebar-item nav-operation">
                <i class="fas fa-user-cog"></i>
                <span>运维管理</span>
            </div>
            <div class="sidebar-item sidebar-item nav-cmdb">
                <i class="fas fa-database"></i>
                <span>CMDB</span>
            </div>
            <div class="sidebar-item sidebar-item nav-log">
                <i class="fas fa-file-alt"></i>
                <span>日志管理</span>
            </div>
            <div class="menuItem sidebar-item nav-prediction">
                <i class="fas fa-chart-pie"></i>
                <span>智能预测管理</span>
            </div>
            <div class="menuItem sidebar-item nav-cloud">
                <i class="fas fa-cloud"></i>
                <span>云平台</span>
            </div>
            <div class="sidebar-divider"></div>
            <div class="sidebar-group-title">设置中心</div>
            <div class="menuItem sidebar-item nav-settings active">
                <i class="fas fa-cog"></i>
                <span>设置</span>
            </div>
            <div class="menuItem sidebar-item nav-docking">
                <i class="fas fa-plug"></i>
                <span>对接配置</span>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 顶部导航栏 -->
            <header class="top-header">
<style>
/* 立即隐藏CMDB菜单项 - 防止闪烁 */
.nav-cmdb { display: none !important; }
.sidebar-item[data-page="CMDB"] { display: none !important; }
</style>
<script>
// 立即执行：尽早隐藏CMDB，防止闪烁
(function() {
    function hideCMDB() {
        var items = document.querySelectorAll('.sidebar-item');
        items.forEach(function(item) {
            var span = item.querySelector('span');
            if (span && span.textContent.trim() === 'CMDB') {
                item.style.display = 'none';
                item.setAttribute('data-hidden', 'true');
            }
        });
    }
    
    // 立即执行
    hideCMDB();
    
    // DOM Ready时再执行一次
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideCMDB);
    }
    
    // 额外保险：延迟执行确保覆盖所有情况
    setTimeout(hideCMDB, 10);
    setTimeout(hideCMDB, 100);
})();
</script>
                <div class="header-left">
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">设置</span>
                    </div>
                </div>
                <div class="header-right">
                    <!-- 用户下拉菜单容器 -->
                    <div id="user-dropdown-container"></div>
                </div>
            </header>

            <!-- 页面内容 -->
            <div class="page-content">
                <!-- 设置内容区域 -->
                <div class="settings-container">
                    <!-- 左侧设置分类树 -->
                    <div class="settings-tree">
                        <div class="tree-header">
                            <h3>设置</h3>
                        </div>
                        <div class="tree-content">
                            <div class="tree-node">
                                <div class="node-item selected">
                                    <i class="fas fa-user node-icon"></i>
                                    <span class="node-text">用户</span>
                                </div>
                            </div>
                            <div class="tree-node">
                                <div class="node-item">
                                    <i class="fas fa-user-shield node-icon"></i>
                                    <span class="node-text">角色</span>
                                </div>
                            </div>
                            <div class="tree-node">
                                <div class="node-item">
                                    <i class="fas fa-cogs node-icon"></i>
                                    <span class="node-text">系统配置</span>
                                </div>
                            </div>
                            <div class="tree-node">
                                <div class="node-item" data-setting="detection-template">
                                    <i class="fas fa-clipboard-check node-icon"></i>
                                    <span class="node-text">检测模板设置</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧主要内容区域 -->
                    <div class="settings-main">
                        <!-- 工具栏 -->
                        <div class="toolbar" id="userToolbar">
                            <div class="toolbar-left">
                                <div class="nav-tabs">
                                    <button class="nav-tab active" data-tab="users">用户</button>
                                    <button class="nav-tab" data-tab="add">新增</button>
                                    <button class="nav-tab" data-tab="edit" style="display: none;">编辑</button>
                                    <button class="nav-tab" data-tab="import">导入</button>
                                </div>
                            </div>
                            <div class="toolbar-right">
                                <div class="search-container">
                                    <input type="text" class="search-input" placeholder="输入关键字搜索用户信息，如用户名、邮箱等" id="userSearchInput" autocomplete="off">
                                    <button class="search-btn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button class="refresh-btn">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 设置内容 -->
                        <div class="settings-content">
                            <!-- 用户管理表格 -->
                            <div class="user-management" id="usersTab">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>登录名称/显示名称</th>
                                                <th>邮箱</th>
                                                <th>最后一次登录</th>
                                                <th>最后修改时间</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="userTableBody">
                                            <!-- 用户数据将通过JavaScript动态加载 -->
                                            <tr>
                                                <td colspan="6" style="text-align: center; padding: 40px;">
                                                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <!-- 分页 -->
                                    <div class="pagination" id="userPagination">
                                        <div class="pagination-info" id="userPaginationInfo">
                                            共计 0 条记录，共 0 页，每页 20 条，当前第 1 页
                                        </div>
                                        <div class="pagination-controls">
                                            <button class="page-btn" id="userPrevBtn" onclick="changeUserPage(-1)">
                                                <i class="fas fa-angle-left"></i>
                                            </button>
                                            <span class="page-numbers" id="userPageNumbers">1</span>
                                            <button class="page-btn" id="userNextBtn" onclick="changeUserPage(1)">
                                                <i class="fas fa-angle-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 新增用户表单 -->
                            <div class="add-user-form" id="addTab" style="display: none;">
                                <div class="form-container">
                                    <h3>新增用户</h3>
                                    <form class="user-form" id="addUserForm">
                                        <input type="hidden" id="add-userId" name="id">
                                        
                                        <!-- 头像上传 -->
                                        <div class="form-group avatar-upload-group">
                                            <label>头像</label>
                                            <div class="avatar-upload-container">
                                                <div class="avatar-preview" id="add-avatarPreview">
                                                    <img src="https://via.placeholder.com/100" alt="头像预览" id="add-avatarImage">
                                                    <div class="avatar-upload-overlay">
                                                        <i class="fas fa-camera"></i>
                                                        <span>上传头像</span>
                                                    </div>
                                                </div>
                                                <input type="file" id="add-avatarInput" accept="image/*" style="display: none;">
                                                <input type="hidden" id="add-avatarUrl" name="avatar">
                                                <div class="avatar-tips">
                                                    <p>支持 JPG、PNG 格式，文件大小不超过 2MB</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="add-username">用户名 <span class="required">*</span></label>
                                            <input type="text" id="add-username" name="username" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="add-realName">真实姓名 <span class="required">*</span></label>
                                            <input type="text" id="add-realName" name="realName" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="add-email">邮箱</label>
                                            <input type="email" id="add-email" name="email">
                                        </div>
                                        <div class="form-group">
                                            <label for="add-phone">手机号</label>
                                            <input type="tel" id="add-phone" name="phone">
                                        </div>
                                        <div class="form-group">
                                            <label for="add-password">密码 <span class="required">*</span></label>
                                            <div class="password-input-wrapper" style="position: relative;">
                                                <input type="password" id="add-password" name="password" required minlength="6" placeholder="密码长度至少6位">
                                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('add-password', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="add-confirmPassword">确认密码 <span class="required">*</span></label>
                                            <div class="password-input-wrapper" style="position: relative;">
                                                <input type="password" id="add-confirmPassword" name="confirmPassword" required minlength="6" placeholder="请再次输入密码">
                                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('add-confirmPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="add-role">角色</label>
                                            <select id="add-role" name="role">
                                                <option value="user">普通用户</option>
                                                <option value="admin">管理员</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="add-status">状态</label>
                                            <select id="add-status" name="status">
                                                <option value="1">启用</option>
                                                <option value="0">禁用</option>
                                            </select>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn-primary">保存</button>
                                            <button type="button" class="btn-secondary" onclick="switchTab('users')">取消</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- 编辑用户表单 -->
                            <div class="edit-user-form" id="editTab" style="display: none;">
                                <div class="form-container">
                                    <h3>编辑用户</h3>
                                    <form class="user-form" id="editUserForm">
                                        <input type="hidden" id="edit-userId" name="id">
                                        
                                        <!-- 头像上传 -->
                                        <div class="form-group avatar-upload-group">
                                            <label>头像</label>
                                            <div class="avatar-upload-container">
                                                <div class="avatar-preview" id="edit-avatarPreview">
                                                    <img src="https://via.placeholder.com/100" alt="头像预览" id="edit-avatarImage">
                                                    <div class="avatar-upload-overlay">
                                                        <i class="fas fa-camera"></i>
                                                        <span>上传头像</span>
                                                    </div>
                                                </div>
                                                <input type="file" id="edit-avatarInput" accept="image/*" style="display: none;">
                                                <input type="hidden" id="edit-avatarUrl" name="avatar">
                                                <div class="avatar-tips">
                                                    <p>支持 JPG、PNG 格式，文件大小不超过 2MB</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="edit-username">用户名 <span class="required">*</span></label>
                                            <input type="text" id="edit-username" name="username" required readonly>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-realName">真实姓名 <span class="required">*</span></label>
                                            <input type="text" id="edit-realName" name="realName" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-email">邮箱</label>
                                            <input type="email" id="edit-email" name="email">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-phone">手机号</label>
                                            <input type="tel" id="edit-phone" name="phone">
                                        </div>
                                        <div class="form-group">
                                            <label>修改密码（留空则不修改）</label>
                                            <div class="password-input-wrapper" style="position: relative;">
                                                <input type="password" id="edit-password" name="password" placeholder="留空则不修改密码">
                                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('edit-password', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-confirmPassword">确认新密码</label>
                                            <div class="password-input-wrapper" style="position: relative;">
                                                <input type="password" id="edit-confirmPassword" name="confirmPassword" placeholder="确认新密码">
                                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('edit-confirmPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-role">角色</label>
                                            <select id="edit-role" name="role">
                                                <option value="user">普通用户</option>
                                                <option value="admin">管理员</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-status">状态</label>
                                            <select id="edit-status" name="status">
                                                <option value="1">启用</option>
                                                <option value="0">禁用</option>
                                            </select>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn-primary">保存修改</button>
                                            <button type="button" class="btn-secondary" onclick="switchTab('users')">取消</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- 导入用户 -->
                            <div class="import-user" id="importTab" style="display: none;">
                                <div class="import-container">
                                    <h3>导入用户</h3>
                                    <div class="import-area">
                                        <div class="upload-zone">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>拖拽文件到此处或点击上传</p>
                                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                                            <button class="upload-btn">选择文件</button>
                                        </div>
                                        <div class="import-tips">
                                            <h4>导入说明：</h4>
                                            <ul>
                                                <li>支持 CSV、Excel 格式文件</li>
                                                <li>文件大小不超过 10MB</li>
                                                <li>必须包含：用户名 列</li>
                                                <li>可选包含：真实姓名、邮箱、手机号、密码、角色 列</li>
                                                <li>未填写密码的用户默认密码为：123456</li>
                                                <li>未填写角色的用户默认为：普通用户</li>
                                            </ul>
                                            <button class="btn-template" onclick="downloadImportTemplate()" style="margin-top: 15px; padding: 8px 16px; background: #1890ff; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-download"></i> 下载导入模板
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 检测模板设置 -->
                            <div class="detection-template-management" id="detectionTemplateTab" style="display: none;">
                                <div class="template-header">
                                    <div class="header-left">
                                        <h3>检测模板设置</h3>
                                        <div class="template-stats">
                                            <span class="stat-item">全部 <span class="stat-count" id="totalTemplates">0</span></span>
                                        </div>
                                    </div>
                                    <div class="header-right">
                                        <div class="search-container">
                                            <input type="text" class="search-input" placeholder="输入模板名称" id="templateSearchInput">
                                            <button class="search-btn" onclick="searchTemplates()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <button class="btn-primary add-template-btn" onclick="showAddTemplateModal()">
                                            <i class="fas fa-plus"></i>
                                            添加检测模板
                                        </button>
                                    </div>
                                </div>

                                <div class="template-content">
                                    <div class="table-container">
                                        <table class="detection-template-table">
                                            <thead>
                                                <tr>
                                                    <th>模板名称</th>
                                                    <th>检测类型</th>
                                                    <th>阈值设置</th>
                                                    <th>更新时间</th>
                                                    <th>状态</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="templateTableBody">
                                                <!-- 模板数据将通过JavaScript动态加载 -->
                                                <tr class="empty-row">
                                                    <td colspan="6">
                                                        <div class="empty-state">
                                                            <i class="fas fa-clipboard-list"></i>
                                                            <p>暂无检测模板</p>
                                                            <button class="btn-primary" onclick="showAddTemplateModal()">添加第一个模板</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- 分页 -->
                                    <div class="pagination" id="templatePagination" style="display: none;">
                                        <div class="pagination-info">
                                            <span id="templatePaginationInfo">共计 0 条记录，共 0 页，每页 20 条，当前第 1 页</span>
                                        </div>
                                        <div class="pagination-controls">
                                            <button class="page-btn" id="templatePrevBtn" onclick="changeTemplatePage(-1)">
                                                <i class="fas fa-angle-left"></i>
                                            </button>
                                            <span class="page-numbers" id="templatePageNumbers"></span>
                                            <button class="page-btn" id="templateNextBtn" onclick="changeTemplatePage(1)">
                                                <i class="fas fa-angle-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 角色管理 -->
                            <div class="role-management" id="roleManagementTab" style="display: none;">
                                <!-- 工具栏 -->
                                <div class="toolbar" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                    <div class="toolbar-left">
                                        <div class="search-container" style="display: flex; gap: 10px;">
                                            <input type="text" class="search-input" placeholder="搜索角色名称、代码..." id="roleSearchInput" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 300px;">
                                            <button class="search-btn" onclick="searchRoles()" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="toolbar-right">
                                        <button class="btn btn-primary" onclick="showAddRoleModal()" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            <i class="fas fa-plus"></i> 新增角色
                                        </button>
                                    </div>
                                </div>

                                <!-- 角色列表 -->
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>角色名称</th>
                                                <th>角色代码</th>
                                                <th>角色描述</th>
                                                <th>权限数量</th>
                                                <th>状态</th>
                                                <th>排序</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="roleTableBody">
                                            <!-- 角色数据将通过JavaScript动态加载 -->
                                        </tbody>
                                    </table>
                                    
                                    <!-- 分页 -->
                                    <div class="pagination">
                                        <div class="pagination-info">
                                            <span id="rolePaginationInfo">共计 0 条记录，共 0 页，每页 20 条，当前第 1 页</span>
                                        </div>
                                        <div class="pagination-controls">
                                            <button class="page-btn" id="rolePrevBtn">
                                                <i class="fas fa-angle-left"></i>
                                            </button>
                                            <span class="page-numbers" id="rolePageNumbers"></span>
                                            <button class="page-btn" id="roleNextBtn">
                                                <i class="fas fa-angle-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 系统配置 -->
                            <div class="system-config-management" id="systemConfigTab" style="display: none;">
                                <!-- 系统配置内容将通过JavaScript动态加载 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增角色模态框 -->
    <div class="modal" id="addRoleModal" style="display: none;">
        <div class="modal-backdrop" onclick="closeAddRoleModal()"></div>
        <div class="modal-content" style="width: 700px; max-width: 90vw;">
            <div class="modal-header">
                <h3>新增角色</h3>
                <button class="close-btn" onclick="closeAddRoleModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addRoleForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            角色名称 <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="addRoleName" class="form-control" placeholder="请输入角色名称" required
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            角色代码 <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="addRoleCode" class="form-control" placeholder="例如: SYSTEM_ADMIN" required
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 12px; margin-top: 4px; display: block;">
                            例如: SYSTEM_ADMIN
                        </small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            角色描述
                        </label>
                        <textarea id="addRoleDesc" class="form-control" rows="3" placeholder="请输入角色描述"
                                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                状态
                            </label>
                            <select id="addRoleStatus" class="form-control"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="1">启用</option>
                                <option value="0">禁用</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                排序
                            </label>
                            <input type="number" id="addRoleSort" class="form-control" placeholder="0" value="0"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddRoleModal()">取消</button>
                <button class="btn btn-primary" onclick="saveAddRole()">保存</button>
            </div>
        </div>
    </div>

    <!-- 编辑角色模态框 -->
    <div class="modal" id="editRoleModal" style="display: none;">
        <div class="modal-backdrop" onclick="closeEditRoleModal()"></div>
        <div class="modal-content" style="width: 700px; max-width: 90vw;">
            <div class="modal-header">
                <h3>编辑角色</h3>
                <button class="close-btn" onclick="closeEditRoleModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editRoleForm">
                    <input type="hidden" id="editRoleId">
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            角色名称 <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="editRoleName" class="form-control" placeholder="请输入角色名称" required
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            角色代码 <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="editRoleCode" class="form-control" placeholder="例如: SYSTEM_ADMIN" required
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 12px; margin-top: 4px; display: block;">
                            例如: SYSTEM_ADMIN
                        </small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                            角色描述
                        </label>
                        <textarea id="editRoleDesc" class="form-control" rows="3" placeholder="请输入角色描述"
                                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                状态
                            </label>
                            <select id="editRoleStatus" class="form-control"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="1">启用</option>
                                <option value="0">禁用</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                排序
                            </label>
                            <input type="number" id="editRoleSort" class="form-control" placeholder="0" value="0"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditRoleModal()">取消</button>
                <button class="btn btn-primary" onclick="saveEditRole()">保存</button>
            </div>
        </div>
    </div>

    <!-- 权限分配模态框 -->
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1;
        }
        
        .modal .modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2;
            animation: slideIn 0.3s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            border-bottom: 2px solid #f0f0f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .modal-header .close-btn {
            color: white;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        
        .modal-header .close-btn:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .permission-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .permission-actions button {
            padding: 8px 16px;
            background: white;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .permission-actions button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .permission-tree {
            border: 2px solid #e9ecef;
            padding: 20px;
            border-radius: 8px;
            min-height: 400px;
            background: white;
        }
        
        .permission-parent {
            margin-bottom: 20px;
        }
        
        .permission-parent > label {
            display: flex;
            align-items: center;
            padding: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .permission-parent > label:hover {
            background: #f0f4ff;
        }
        
        .permission-children {
            margin-left: 30px;
            margin-top: 8px;
        }
        
        .permission-children label {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .permission-children label:hover {
            background: #f8f9fa;
        }
        
        .permission-tree input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 30px;
            border-top: 2px solid #f0f0f0;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }
        
        .modal-footer button {
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-footer .btn-secondary {
            background: white;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .modal-footer .btn-secondary:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }
        
        .modal-footer .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .modal-footer .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
    </style>
    <div class="modal modal-large" id="permissionModal" style="display: none;">
        <div class="modal-backdrop" onclick="closePermissionModal()"></div>
        <div class="modal-content" style="width: 900px; max-width: 90vw;">
            <div class="modal-header">
                <h3>分配权限 - <span id="permissionRoleName"></span></h3>
                <button class="close-btn" onclick="closePermissionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="permission-tree-container">
                    <div class="permission-actions">
                        <button onclick="expandAll()">
                            <i class="fas fa-expand-alt"></i> 展开全部
                        </button>
                        <button onclick="collapseAll()">
                            <i class="fas fa-compress-alt"></i> 收起全部
                        </button>
                        <button onclick="selectAll()">
                            <i class="fas fa-check-square"></i> 全选
                        </button>
                        <button onclick="unselectAll()">
                            <i class="fas fa-square"></i> 取消全选
                        </button>
                    </div>
                    <div class="permission-tree" id="permissionTree">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> 加载权限数据...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePermissionModal()">取消</button>
                <button class="btn btn-primary" onclick="savePermissions()">保存</button>
            </div>
        </div>
    </div>

    <!-- 密码验证弹窗 -->
    <div class="password-modal" id="passwordModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>验证管理员密码</h3>
                <button class="modal-close" onclick="closePasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-tip">新增用户需要管理员密码验证</p>
                <div class="form-group">
                    <label for="adminPassword">管理员密码 <span class="required">*</span></label>
                    <input type="password" id="adminPassword" placeholder="请输入管理员密码" autofocus>
                    <span class="error-message" id="passwordError" style="display: none;"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePasswordModal()">取消</button>
                <button class="btn-primary" onclick="verifyPassword()">确认</button>
            </div>
        </div>
    </div>

    <!-- 检测模板弹窗 -->
    <div class="template-modal" id="templateModal" style="display: none;">
        <div class="modal-overlay" onclick="closeTemplateModal()"></div>
        <div class="modal-content template-modal-content">
            <div class="modal-header">
                <h3 id="templateModalTitle">添加检测模板</h3>
                <button class="modal-close" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="template-form" id="templateForm">
                    <input type="hidden" id="templateId" name="id">
                    
                    <div class="form-group">
                        <label for="templateName">模板名称 <span class="required">*</span></label>
                        <input type="text" id="templateName" name="templateName" placeholder="请输入模板名称" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="detectionType">监控类型 <span class="required">*</span></label>
                        <select id="detectionType" name="detectionType" required>
                            <option value="">请选择监控类型</option>
                            <option value="cpu">CPU监控</option>
                            <option value="memory">内存监控</option>
                            <option value="disk">磁盘监控</option>
                            <option value="network">网络监控</option>
                            <option value="temperature">温度监控</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="warningThreshold">警告阈值 <span class="required">*</span></label>
                        <div class="threshold-input">
                            <input type="number" id="warningThreshold" name="warningThreshold" placeholder="0" min="0" max="100" required>
                            <span class="threshold-unit">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="criticalThreshold">严重阈值 <span class="required">*</span></label>
                        <div class="threshold-input">
                            <input type="number" id="criticalThreshold" name="criticalThreshold" placeholder="0" min="0" max="100" required>
                            <span class="threshold-unit">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="checkInterval">检测间隔 <span class="required">*</span></label>
                        <div class="interval-input">
                            <input type="number" id="checkInterval" name="checkInterval" placeholder="5" min="1" required>
                            <select id="intervalUnit" name="intervalUnit">
                                <option value="minutes">分钟</option>
                                <option value="hours">小时</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="templateDescription">描述</label>
                        <textarea id="templateDescription" name="description" placeholder="请输入模板描述" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="templateStatus">状态</label>
                        <select id="templateStatus" name="status">
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeTemplateModal()">取消</button>
                <button class="btn-primary" onclick="saveTemplate()">保存</button>
            </div>
        </div>
    </div>

    <script src="设置.js"></script>
    
    <!-- 立即执行的头像修复脚本 -->
    <script>
    (function() {
        'use strict';
        
        function fixSettingsAvatarImmediate() {
            console.log('🔧 立即修复设置页面头像');
            
            const avatarElement = document.getElementById('settingsUserAvatar');
            if (!avatarElement) {
                console.log('❌ 未找到头像元素 settingsUserAvatar');
                return;
            }
            
            // 修复URL格式
            let userAvatar = localStorage.getItem('userAvatar');
            if (userAvatar && userAvatar.startsWith('/upload/')) {
                userAvatar = userAvatar.replace('/upload/', '/api/upload/');
                localStorage.setItem('userAvatar', userAvatar);
                console.log('✅ 修复头像URL格式:', userAvatar);
            }
            
            // 设置头像
            if (userAvatar && userAvatar !== 'null' && userAvatar !== '') {
                avatarElement.src = userAvatar;
                console.log('✅ 设置页面头像已更新:', userAvatar);
            } else {
                avatarElement.src = '1.png';
                console.log('✅ 使用默认头像');
            }
        }
        
        // 立即尝试修复
        fixSettingsAvatarImmediate();
        
        // DOM加载完成后再次尝试
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fixSettingsAvatarImmediate);
        }
        
        // 延迟再次尝试
        setTimeout(fixSettingsAvatarImmediate, 500);
        setTimeout(fixSettingsAvatarImmediate, 1500);
        
        // 监听头像更新事件
        window.addEventListener('avatarUpdated', function(e) {
            const avatarElement = document.getElementById('settingsUserAvatar');
            if (avatarElement && e.detail && e.detail.avatar) {
                avatarElement.src = e.detail.avatar;
                console.log('✅ 设置页面头像事件更新:', e.detail.avatar);
            }
        });
        
        console.log('🎯 设置页面头像修复脚本已加载');
    })();
    </script>

    <!-- 引入用户下拉菜单加载器 -->
    <script src="js/user-dropdown-loader.js"></script>
</body>
</html>
