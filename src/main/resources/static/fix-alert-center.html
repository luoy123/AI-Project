<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¿®å¤å‘Šè­¦ä¸­å¿ƒ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿®å¤å‘Šè­¦ä¸­å¿ƒé—®é¢˜</h1>
    
    <div class="step">
        <h2>æ­¥éª¤1: æ£€æŸ¥APIè¿æ¥</h2>
        <button onclick="testConnection()">æµ‹è¯•APIè¿æ¥</button>
        <pre id="connectionResult"></pre>
    </div>
    
    <div class="step">
        <h2>æ­¥éª¤2: åˆ›å»ºæµ‹è¯•å‘Šè­¦æ•°æ®</h2>
        <button onclick="createTestAlerts()">åˆ›å»ºæµ‹è¯•å‘Šè­¦</button>
        <pre id="createResult"></pre>
    </div>
    
    <div class="step">
        <h2>æ­¥éª¤3: æµ‹è¯•å‘Šè­¦åˆ—è¡¨</h2>
        <button onclick="testAlertList()">è·å–å‘Šè­¦åˆ—è¡¨</button>
        <pre id="listResult"></pre>
    </div>
    
    <div class="step">
        <h2>æ­¥éª¤4: æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯</h2>
        <button onclick="testStatistics()">è·å–ç»Ÿè®¡ä¿¡æ¯</button>
        <pre id="statsResult"></pre>
    </div>
    
    <div class="step">
        <h2>æ­¥éª¤5: æ‰“å¼€å‘Šè­¦ä¸­å¿ƒ</h2>
        <button onclick="openAlertCenter()">æ‰“å¼€å‘Šè­¦ä¸­å¿ƒ</button>
        <p>ä¿®å¤å®Œæˆåï¼Œå‘Šè­¦ä¸­å¿ƒåº”è¯¥æ­£å¸¸æ˜¾ç¤ºæ•°æ®</p>
    </div>

    <script src="common.js"></script>
    <script>
        const API_BASE = '/api/alert';
        
        function testConnection() {
            console.log('æµ‹è¯•APIè¿æ¥...');
            
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('connectionResult').textContent = 'âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ';
                return;
            }
            
            // æµ‹è¯•åŸºç¡€è¿æ¥
            fetch('/api/alert/statistics', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                console.log('APIå“åº”æ•°æ®:', data);
                document.getElementById('connectionResult').textContent = 'âœ… APIè¿æ¥æ­£å¸¸\n' + JSON.stringify(data, null, 2);
            })
            .catch(error => {
                console.error('APIè¿æ¥å¤±è´¥:', error);
                document.getElementById('connectionResult').textContent = 'âŒ APIè¿æ¥å¤±è´¥: ' + error.message;
            });
        }
        
        function createTestAlerts() {
            console.log('åˆ›å»ºæµ‹è¯•å‘Šè­¦æ•°æ®...');
            
            const testAlerts = [
                {
                    severity: 'critical',
                    message: 'CPUä½¿ç”¨ç‡è¿‡é«˜',
                    deviceName: 'æœåŠ¡å™¨-001',
                    deviceType: 'server',
                    description: 'CPUä½¿ç”¨ç‡è¾¾åˆ°95%ï¼Œéœ€è¦ç«‹å³å¤„ç†',
                    status: 'active'
                },
                {
                    severity: 'warning',
                    message: 'å†…å­˜ä½¿ç”¨ç‡è­¦å‘Š',
                    deviceName: 'æœåŠ¡å™¨-002',
                    deviceType: 'server',
                    description: 'å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°80%',
                    status: 'active'
                },
                {
                    severity: 'info',
                    message: 'ç½‘ç»œè¿æ¥æ­£å¸¸',
                    deviceName: 'äº¤æ¢æœº-001',
                    deviceType: 'network',
                    description: 'ç½‘ç»œè¿æ¥å·²æ¢å¤æ­£å¸¸',
                    status: 'resolved'
                }
            ];
            
            const results = [];
            let completed = 0;
            
            testAlerts.forEach((alert, index) => {
                fetchWithAuth(`${API_BASE}/add`, {
                    method: 'POST',
                    body: JSON.stringify(alert)
                })
                .then(data => {
                    results.push(`âœ… å‘Šè­¦${index + 1}: ${data.message || 'åˆ›å»ºæˆåŠŸ'}`);
                    completed++;
                    if (completed === testAlerts.length) {
                        document.getElementById('createResult').textContent = results.join('\n');
                    }
                })
                .catch(error => {
                    results.push(`âŒ å‘Šè­¦${index + 1}: ${error.message}`);
                    completed++;
                    if (completed === testAlerts.length) {
                        document.getElementById('createResult').textContent = results.join('\n');
                    }
                });
            });
        }
        
        function testAlertList() {
            console.log('æµ‹è¯•å‘Šè­¦åˆ—è¡¨...');
            
            fetchWithAuth(`${API_BASE}/list`)
                .then(data => {
                    console.log('å‘Šè­¦åˆ—è¡¨å“åº”:', data);
                    if (data.code === 200) {
                        const alerts = data.data || [];
                        const result = `âœ… è·å–æˆåŠŸï¼Œå…±${alerts.length}æ¡å‘Šè­¦\n\n` + 
                                     JSON.stringify(alerts, null, 2);
                        document.getElementById('listResult').textContent = result;
                    } else {
                        document.getElementById('listResult').textContent = 'âŒ è·å–å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                    }
                })
                .catch(error => {
                    console.error('è·å–å‘Šè­¦åˆ—è¡¨å¤±è´¥:', error);
                    document.getElementById('listResult').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
                });
        }
        
        function testStatistics() {
            console.log('æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯...');
            
            fetchWithAuth(`${API_BASE}/statistics`)
                .then(data => {
                    console.log('ç»Ÿè®¡ä¿¡æ¯å“åº”:', data);
                    if (data.code === 200) {
                        const result = 'âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ\n\n' + JSON.stringify(data.data, null, 2);
                        document.getElementById('statsResult').textContent = result;
                    } else {
                        document.getElementById('statsResult').textContent = 'âŒ è·å–å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                    }
                })
                .catch(error => {
                    console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                    document.getElementById('statsResult').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
                });
        }
        
        function openAlertCenter() {
            window.open('å‘Šè­¦ä¸­å¿ƒ.html', '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            setTimeout(testConnection, 500);
        };
    </script>
</body>
</html>
