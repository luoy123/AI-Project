<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„æµ‹æŠ¥å‘Š - äººå·¥æ™ºèƒ½è¿ç»´å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§åˆ†ç±»æ  */
        .sidebar {
            width: 250px;
            background-color: #fff;
            border-right: 1px solid #e4e7ed;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .category-list {
            padding: 10px 0;
        }

        .category-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item:hover {
            background-color: #f5f7fa;
        }

        .category-item.active {
            background-color: #ecf5ff;
            color: #409eff;
            border-left: 3px solid #409eff;
        }

        .category-name {
            font-size: 14px;
        }

        .category-count {
            font-size: 12px;
            color: #909399;
            background-color: #f4f4f5;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* å³ä¾§å†…å®¹åŒº */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 20px;
            font-weight: 600;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        /* å¥åº·åº¦ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        .stats-row {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 6px;
        }

        .stat-item.normal {
            background-color: #f0f9ff;
            border: 1px solid #67c23a;
        }

        .stat-item.abnormal {
            background-color: #fef0f0;
            border: 1px solid #f56c6c;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #606266;
        }

        /* æŠ¥å‘Šå¡ç‰‡åˆ—è¡¨ */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .report-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .report-card:hover {
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .report-title {
            font-size: 16px;
            font-weight: 600;
        }

        .report-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-normal {
            background-color: #f0f9ff;
            color: #67c23a;
        }

        .status-warning {
            background-color: #fdf6ec;
            color: #e6a23c;
        }

        .status-critical {
            background-color: #fef0f0;
            color: #f56c6c;
        }

        .report-chart {
            height: 200px;
            margin-bottom: 15px;
        }

        .report-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e4e7ed;
        }

        .report-time {
            font-size: 12px;
            color: #909399;
        }

        .view-btn {
            padding: 6px 16px;
            background-color: #409eff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background-color: #66b1ff;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 16px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #909399;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§åˆ†ç±»æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>å›¾åˆ†ç±»</h3>
                <button class="filter-select" onclick="loadCategories()">åˆ·æ–°</button>
            </div>
            <div class="category-list" id="categoryList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="main-content">
            <div class="content-header">
                <h2 class="content-title" id="contentTitle">æœåŠ¡å™¨OS</h2>
                <div class="filter-bar">
                    <select class="filter-select" id="predictionTimeFilter" onchange="loadReports()">
                        <option value="1">é¢„æµ‹æ—¶é—´: 1å¤©</option>
                        <option value="3">é¢„æµ‹æ—¶é—´: 3å¤©</option>
                        <option value="7">é¢„æµ‹æ—¶é—´: 7å¤©</option>
                        <option value="30">é¢„æµ‹æ—¶é—´: 30å¤©</option>
                    </select>
                </div>
            </div>

            <!-- å¥åº·åº¦ç»Ÿè®¡ -->
            <div class="stats-card" id="statsCard" style="display: none;">
                <div class="stats-row">
                    <div class="stat-item normal">
                        <div class="stat-value" id="normalCount">0</div>
                        <div class="stat-label">æ­£å¸¸è®¾å¤‡</div>
                    </div>
                    <div class="stat-item abnormal">
                        <div class="stat-value" id="abnormalCount">0</div>
                        <div class="stat-label">å¼‚å¸¸è®¾å¤‡</div>
                    </div>
                </div>
            </div>

            <!-- æŠ¥å‘Šåˆ—è¡¨ -->
            <div class="reports-grid" id="reportsGrid">
                <div class="loading">è¯·é€‰æ‹©åˆ†ç±»æŸ¥çœ‹æŠ¥å‘Š</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentCategoryId = null;
        let currentPredictionTime = 1;
        let chartInstances = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
        });

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            try {
                const response = await fetch('/api/prediction/enhanced-reports/categories/assets');
                const result = await response.json();

                if (result.code === 200 && result.data) {
                    renderCategories(result.data);
                } else {
                    showError('åŠ è½½åˆ†ç±»å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                showError('åŠ è½½åˆ†ç±»å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategories(categories) {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';

            // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
            const allItem = document.createElement('div');
            allItem.className = 'category-item active';
            allItem.innerHTML = `
                <span class="category-name">å…¨éƒ¨</span>
                <span class="category-count">${categories.length}</span>
            `;
            allItem.onclick = () => selectCategory(null, 'å…¨éƒ¨', allItem);
            categoryList.appendChild(allItem);

            // æ·»åŠ åˆ†ç±»é¡¹
            categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.innerHTML = `
                    <span class="category-name">${category.categoryName}</span>
                    <span class="category-count">(${category.id})</span>
                `;
                item.onclick = () => selectCategory(category.id, category.categoryName, item);
                categoryList.appendChild(item);
            });

            // é»˜è®¤åŠ è½½å…¨éƒ¨
            selectCategory(null, 'å…¨éƒ¨', allItem);
        }

        // é€‰æ‹©åˆ†ç±»
        function selectCategory(categoryId, categoryName, element) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');

            // æ›´æ–°å½“å‰åˆ†ç±»
            currentCategoryId = categoryId;
            document.getElementById('contentTitle').textContent = categoryName;

            // åŠ è½½æŠ¥å‘Š
            loadReports();
        }

        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
        async function loadReports() {
            const reportsGrid = document.getElementById('reportsGrid');
            reportsGrid.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                currentPredictionTime = document.getElementById('predictionTimeFilter').value;

                let url = `/api/prediction/enhanced-reports/category-reports?predictionTime=${currentPredictionTime}`;
                if (currentCategoryId) {
                    url += `&categoryId=${currentCategoryId}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.code === 200 && result.data) {
                    renderReports(result.data);
                    updateStats(result.data);
                } else {
                    showError('åŠ è½½æŠ¥å‘Šå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
                showError('åŠ è½½æŠ¥å‘Šå¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“æŠ¥å‘Šåˆ—è¡¨
        function renderReports(reports) {
            const reportsGrid = document.getElementById('reportsGrid');

            if (!reports || reports.length === 0) {
                reportsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“Š</div>
                        <div class="empty-text">æš‚æ— æŠ¥å‘Šæ•°æ®</div>
                    </div>
                `;
                return;
            }

            reportsGrid.innerHTML = '';

            reports.forEach(report => {
                const card = createReportCard(report);
                reportsGrid.appendChild(card);
            });

            // æ¸²æŸ“å›¾è¡¨
            setTimeout(() => {
                reports.forEach(report => {
                    renderChart(report);
                });
            }, 100);
        }

        // åˆ›å»ºæŠ¥å‘Šå¡ç‰‡
        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'report-card';

            const statusClass = report.status === 'NORMAL' ? 'status-normal' :
                              report.status === 'WARNING' ? 'status-warning' : 'status-critical';
            const statusText = report.status === 'NORMAL' ? 'æ­£å¸¸' :
                             report.status === 'WARNING' ? 'è­¦å‘Š' : 'ä¸¥é‡';

            card.innerHTML = `
                <div class="report-header">
                    <div class="report-title">${report.reportName || 'è®¾å¤‡å¥åº·åº¦æŠ¥å‘Š'}</div>
                    <div class="report-status ${statusClass}">${statusText}</div>
                </div>
                <div class="report-chart">
                    <canvas id="chart-${report.id}"></canvas>
                </div>
                <div class="report-footer">
                    <div class="report-time">æ›´æ–°æ—¶é—´: ${formatTime(report.updatedAt)}</div>
                    <button class="view-btn" onclick="viewDetail(${report.id})">æŸ¥çœ‹</button>
                </div>
            `;

            return card;
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(report) {
            const canvas = document.getElementById(`chart-${report.id}`);
            if (!canvas) return;

            // é”€æ¯æ—§å›¾è¡¨
            if (chartInstances[report.id]) {
                chartInstances[report.id].destroy();
            }

            // è§£æå›¾è¡¨æ•°æ®
            let chartData = { type: 'line', data: [65, 68, 70, 72, 69] };
            if (report.chartData) {
                try {
                    chartData = JSON.parse(report.chartData);
                } catch (e) {
                    console.error('è§£æå›¾è¡¨æ•°æ®å¤±è´¥:', e);
                }
            }

            // åˆ›å»ºæ–°å›¾è¡¨
            const ctx = canvas.getContext('2d');
            chartInstances[report.id] = new Chart(ctx, {
                type: chartData.type || 'line',
                data: {
                    labels: ['20:00', '13:00', '04:00', '08:00', '12:00'],
                    datasets: [{
                        label: 'æœ¬æœºè®¾å¤‡-å¥åº·è¯„åˆ†',
                        data: chartData.data || [65, 68, 70, 72, 69],
                        borderColor: '#409eff',
                        backgroundColor: 'rgba(64, 158, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(reports) {
            const statsCard = document.getElementById('statsCard');
            const normalCount = reports.filter(r => r.status === 'NORMAL').length;
            const abnormalCount = reports.length - normalCount;

            document.getElementById('normalCount').textContent = normalCount;
            document.getElementById('abnormalCount').textContent = abnormalCount;

            statsCard.style.display = reports.length > 0 ? 'block' : 'none';
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetail(reportId) {
            alert('æŸ¥çœ‹æŠ¥å‘Šè¯¦æƒ…: ' + reportId + '\n\næ­¤åŠŸèƒ½å°†æ˜¾ç¤ºæ›´è¯¦ç»†çš„é¢„æµ‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š\n- è¯¦ç»†çš„å¥åº·åº¦è¯„åˆ†\n- å†å²è¶‹åŠ¿åˆ†æ\n- å¼‚å¸¸æ£€æµ‹ç»“æœ\n- é¢„æµ‹å»ºè®®');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            if (!timeStr) return '-';
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const reportsGrid = document.getElementById('reportsGrid');
            reportsGrid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âš ï¸</div>
                    <div class="empty-text">${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
